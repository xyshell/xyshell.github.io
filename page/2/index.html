<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
  <title>
    
    You Xie&#39;s Blog
  </title>
  <!-- Icon -->
  
    <link rel="shortcut icon" href="/favicon.ico">
    
  
<link rel="stylesheet" href="/css/style.css">

  
  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<script src="/js/pace.min.js"></script>

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.2"></head>

<body>
  <main class="content">
    <section class="jumbotron">
  <div class="video">
    
    <div class="video-frame">
      <img src="/images/ocean/overlay-hero.png" alt="Decorative image frame">
    </div>
    
    <div class="video-media">
      <video playsinline="" autoplay="" loop="" muted="" data-autoplay="" poster="/images/ocean/ocean.png"
        x5-video-player-type="h5">
        <source src="/images/ocean/ocean.mp4" type="video/mp4">
        <source src="/images/ocean/ocean.ogv" type="video/ogg">
        <source src="/images/ocean/ocean.webm" type="video/webm">
        <p>Your user agent does not support the HTML5 Video element.</p>
      </video>
      <div class="video-overlay"></div>
    </div>
    <div class="video-inner text-center text-white">
      <h1><a href="/">You Xie&#39;s Blog</a></h1>
      <p></p>
      <div><img src="/images/hexo-inverted.svg" class="brand" alt="You Xie&#39;s Blog"></div>
    </div>
    <div class="video-learn-more">
      <a class="anchor" href="#landingpage"><i class="fe fe-mouse"></i></a>
    </div>
  </div>
</section>
<div id="landingpage">
  <section class="outer">
  <article class="articles">
    
    <h1 class="page-type-title"></h1>
    
    
    <article id="post-spark-note" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      
  
  <h2 class="article-title" itemprop="name">
    <a href="/2020/07/26/spark-note/">Spark Note</a>
  </h2>
  
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/07/26/spark-note/" class="article-date">
  <time datetime="2020-07-27T03:27:48.000Z" itemprop="datePublished">2020-07-26</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
        <h1 id="Data-Processing"><a href="#Data-Processing" class="headerlink" title="Data Processing"></a>Data Processing</h1><h2 id="Creating-a-SparkSession-Object"><a href="#Creating-a-SparkSession-Object" class="headerlink" title="Creating a SparkSession Object"></a>Creating a SparkSession Object</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pyspark.sql <span class="keyword">import</span> SparkSession</span><br><span class="line">spark=SparkSession.builder.appName(<span class="string">&#x27;data_processing&#x27;</span>).getOrCreate()</span><br><span class="line"><span class="keyword">import</span> pyspark.sql.functions <span class="keyword">as</span> F</span><br><span class="line"><span class="keyword">from</span> pyspark.sql.types <span class="keyword">import</span> *</span><br></pre></td></tr></table></figure>
<h2 id="Creating-Dataframes"><a href="#Creating-Dataframes" class="headerlink" title="Creating Dataframes"></a>Creating Dataframes</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">schema=StructType() \</span><br><span class="line">    .add(<span class="string">&quot;user_id&quot;</span>,<span class="string">&quot;string&quot;</span>) \</span><br><span class="line">    .add(<span class="string">&quot;country&quot;</span>,<span class="string">&quot;string&quot;</span>) \</span><br><span class="line">    .add(<span class="string">&quot;browser&quot;</span>, <span class="string">&quot;string&quot;</span>) \</span><br><span class="line">    .add(<span class="string">&quot;OS&quot;</span>,<span class="string">&#x27;string&#x27;</span>) \</span><br><span class="line">    .add(<span class="string">&quot;age&quot;</span>, <span class="string">&quot;integer&quot;</span>)</span><br><span class="line">df=spark.createDataFrame([</span><br><span class="line">    (<span class="string">&quot;A203&quot;</span>,<span class="string">&#x27;India&#x27;</span>,<span class="string">&quot;Chrome&quot;</span>,<span class="string">&quot;WIN&quot;</span>,<span class="number">33</span>),</span><br><span class="line">    (<span class="string">&quot;A201&quot;</span>,<span class="string">&#x27;China&#x27;</span>,<span class="string">&quot;Safari&quot;</span>,<span class="string">&quot;MacOS&quot;</span>,<span class="number">35</span>),</span><br><span class="line">    (<span class="string">&quot;A205&quot;</span>,<span class="string">&#x27;UK&#x27;</span>,<span class="string">&quot;Mozilla&quot;</span>,<span class="string">&quot;Linux&quot;</span>,<span class="number">25</span>)</span><br><span class="line">],schema=schema)</span><br><span class="line">df.printSchema()</span><br><span class="line">df.show()</span><br></pre></td></tr></table></figure>
<h2 id="Null-Values"><a href="#Null-Values" class="headerlink" title="Null Values"></a>Null Values</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">df_na=spark.createDataFrame([</span><br><span class="line">    (<span class="string">&quot;A203&quot;</span>,<span class="literal">None</span>,<span class="string">&quot;Chrome&quot;</span>,<span class="string">&quot;WIN&quot;</span>,<span class="number">33</span>),</span><br><span class="line">    (<span class="string">&quot;A201&quot;</span>,<span class="string">&#x27;China&#x27;</span>,<span class="literal">None</span>,<span class="string">&quot;MacOS&quot;</span>,<span class="number">35</span>),</span><br><span class="line">    (<span class="string">&quot;A205&quot;</span>,<span class="string">&#x27;UK&#x27;</span>,<span class="string">&quot;Mozilla&quot;</span>,<span class="string">&quot;Linux&quot;</span>,<span class="number">25</span>)</span><br><span class="line">],schema=schema)</span><br><span class="line">df_na.show()</span><br><span class="line">df_na.fillna(<span class="string">&#x27;0&#x27;</span>).show()</span><br><span class="line">df_na.fillna( &#123; <span class="string">&#x27;country&#x27;</span>:<span class="string">&#x27;USA&#x27;</span>, <span class="string">&#x27;browser&#x27;</span>:<span class="string">&#x27;Safari&#x27;</span> &#125; ).show()</span><br><span class="line">df_na.na.drop().show() <span class="comment"># dropna row</span></span><br><span class="line">df_na.na.drop(subset=<span class="string">&#x27;country&#x27;</span>).show() <span class="comment"># dropna row for column</span></span><br><span class="line">df_na.replace(<span class="string">&quot;Chrome&quot;</span>,<span class="string">&quot;Google Chrome&quot;</span>).show()</span><br><span class="line">df_na.drop(<span class="string">&#x27;user_id&#x27;</span>).show() <span class="comment"># drop column</span></span><br><span class="line"></span><br><span class="line">df=spark.read.csv(<span class="string">&quot;customer_data.csv&quot;</span>,header=<span class="literal">True</span>,inferSchema=<span class="literal">True</span>)</span><br><span class="line">df.count()</span><br><span class="line"><span class="built_in">len</span>(df.columns)</span><br><span class="line">df.show(<span class="number">3</span>)</span><br><span class="line">df.summary().show() <span class="comment"># describe</span></span><br></pre></td></tr></table></figure>
<h2 id="Subset-of-a-Dataframe"><a href="#Subset-of-a-Dataframe" class="headerlink" title="Subset of a Dataframe"></a>Subset of a Dataframe</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">df.select([<span class="string">&#x27;Customer_subtype&#x27;</span>,<span class="string">&#x27;Avg_Salary&#x27;</span>]).show()</span><br><span class="line"></span><br><span class="line">df.<span class="built_in">filter</span>(df[<span class="string">&#x27;Avg_Salary&#x27;</span>] &gt; <span class="number">1000000</span>).count()</span><br><span class="line">df.<span class="built_in">filter</span>(df[<span class="string">&#x27;Avg_Salary&#x27;</span>] &gt; <span class="number">1000000</span>).show()</span><br><span class="line">df.<span class="built_in">filter</span>(df[<span class="string">&#x27;Avg_Salary&#x27;</span>] &gt; <span class="number">500000</span>).<span class="built_in">filter</span>(df[<span class="string">&#x27;Number_of_houses&#x27;</span>] &gt; <span class="number">2</span>).show()</span><br><span class="line"></span><br><span class="line">df.where((df[<span class="string">&#x27;Avg_Salary&#x27;</span>] &gt; <span class="number">500000</span>) &amp; (df[<span class="string">&#x27;Number_of_houses&#x27;</span>] &gt; <span class="number">2</span>)).show()</span><br></pre></td></tr></table></figure>
<h2 id="Aggregations"><a href="#Aggregations" class="headerlink" title="Aggregations"></a>Aggregations</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">df.groupBy(<span class="string">&#x27;Customer_subtype&#x27;</span>).count().show()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> col <span class="keyword">in</span> df.columns:</span><br><span class="line">    <span class="keyword">if</span> col !=<span class="string">&#x27;Avg_Salary&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot; Aggregation for <span class="subst">&#123;col&#125;</span>&quot;</span>)</span><br><span class="line">        df.groupBy(col).count().orderBy(<span class="string">&#x27;count&#x27;</span>,ascending=<span class="literal">False</span>).show(truncate=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">df.groupBy(<span class="string">&#x27;Customer_main_type&#x27;</span>).agg(F.mean(<span class="string">&#x27;Avg_Salary&#x27;</span>)).show()</span><br><span class="line">df.groupBy(<span class="string">&#x27;Customer_main_type&#x27;</span>).agg(F.<span class="built_in">max</span>(<span class="string">&#x27;Avg_Salary&#x27;</span>)).show()</span><br><span class="line">df.groupBy(<span class="string">&#x27;Customer_main_type&#x27;</span>).agg(F.<span class="built_in">min</span>(<span class="string">&#x27;Avg_Salary&#x27;</span>)).show()</span><br><span class="line">df.groupBy(<span class="string">&#x27;Customer_main_type&#x27;</span>).agg(F.<span class="built_in">sum</span>(<span class="string">&#x27;Avg_Salary&#x27;</span>)).show()</span><br><span class="line"></span><br><span class="line">df.sort(<span class="string">&quot;Avg_Salary&quot;</span>, ascending=<span class="literal">False</span>).show()</span><br><span class="line"></span><br><span class="line">df.groupBy(<span class="string">&#x27;Customer_subtype&#x27;</span>) \</span><br><span class="line">    .agg(F.avg(<span class="string">&#x27;Avg_Salary&#x27;</span>) \</span><br><span class="line">    .alias(<span class="string">&#x27;mean_salary&#x27;</span>)) \</span><br><span class="line">    .orderBy(<span class="string">&#x27;mean_salary&#x27;</span>,ascending=<span class="literal">False</span>) \</span><br><span class="line">    .show(<span class="number">50</span>,<span class="literal">False</span>)</span><br><span class="line">df.groupBy(<span class="string">&#x27;Customer_subtype&#x27;</span>) \</span><br><span class="line">    .agg(F.<span class="built_in">max</span>(<span class="string">&#x27;Avg_Salary&#x27;</span>) \</span><br><span class="line">    .alias(<span class="string">&#x27;max_salary&#x27;</span>)) \</span><br><span class="line">    .orderBy(<span class="string">&#x27;max_salary&#x27;</span>,ascending=<span class="literal">False</span>) \</span><br><span class="line">    .show()</span><br></pre></td></tr></table></figure>
<h2 id="Collect"><a href="#Collect" class="headerlink" title="Collect"></a>Collect</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">df.groupby(<span class="string">&quot;Customer_subtype&quot;</span>) \</span><br><span class="line">    .agg(F.collect_set(<span class="string">&quot;Number_of_houses&quot;</span>)) \</span><br><span class="line">    .show()</span><br><span class="line">df.groupby(<span class="string">&quot;Customer_subtype&quot;</span>) \</span><br><span class="line">    .agg(F.collect_list(<span class="string">&quot;Number_of_houses&quot;</span>)) \</span><br><span class="line">    .show()</span><br><span class="line"></span><br><span class="line">df=df.withColumn(<span class="string">&#x27;constant&#x27;</span>,F.lit(<span class="string">&#x27;finance&#x27;</span>))</span><br><span class="line">df.select(<span class="string">&#x27;Customer_subtype&#x27;</span>,<span class="string">&#x27;constant&#x27;</span>).show()</span><br></pre></td></tr></table></figure>
<h2 id="User-Defined-Functions-UDFs"><a href="#User-Defined-Functions-UDFs" class="headerlink" title="User-Defined Functions (UDFs)"></a>User-Defined Functions (UDFs)</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pyspark.sql.functions <span class="keyword">import</span> udf</span><br><span class="line">df.groupby(<span class="string">&quot;Avg_age&quot;</span>).count().show()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">age_category</span>(<span class="params">age</span>):</span><br><span class="line">    <span class="keyword">if</span> age == <span class="string">&quot;20-30 years&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Young&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> age== <span class="string">&quot;30-40 years&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Mid Aged&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> ((age== <span class="string">&quot;40-50 years&quot;</span>) <span class="keyword">or</span> (age== <span class="string">&quot;50-60 years&quot;</span>)) :</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Old&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Very Old&quot;</span></span><br><span class="line">age_udf=udf(age_category,StringType())</span><br><span class="line">df=df.withColumn(<span class="string">&#x27;age_category&#x27;</span>,age_udf(df[<span class="string">&#x27;Avg_age&#x27;</span>]))</span><br><span class="line">df.select(<span class="string">&#x27;Avg_age&#x27;</span>,<span class="string">&#x27;age_category&#x27;</span>).show()</span><br><span class="line">df.groupby(<span class="string">&quot;age_category&quot;</span>).count().show()</span><br><span class="line"></span><br><span class="line">df.select(<span class="string">&#x27;Avg_Salary&#x27;</span>).summary().show()</span><br><span class="line">min_sal=<span class="number">1361</span></span><br><span class="line">max_sal=<span class="number">48919896</span></span><br><span class="line"><span class="keyword">from</span> pyspark.sql.functions <span class="keyword">import</span> pandas_udf, PandasUDFType</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">scaled_salary</span>(<span class="params">salary</span>):</span><br><span class="line">    scaled_sal=(salary-min_sal)/(max_sal-min_sal)</span><br><span class="line">    <span class="keyword">return</span> scaled_sal</span><br><span class="line">scaling_udf = pandas_udf(scaled_salary, DoubleType())</span><br><span class="line">df.withColumn(<span class="string">&quot;scaled_salary&quot;</span>,scaling_udf(df[<span class="string">&#x27;Avg_Salary&#x27;</span>])) \</span><br><span class="line">    .show(<span class="number">10</span>,<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>
<h2 id="Joins"><a href="#Joins" class="headerlink" title="Joins"></a>Joins</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">region_data = spark.createDataFrame([</span><br><span class="line">    (<span class="string">&#x27;Family with grown ups&#x27;</span>,<span class="string">&#x27;PN&#x27;</span>),</span><br><span class="line">    (<span class="string">&#x27;Driven Growers&#x27;</span>,<span class="string">&#x27;GJ&#x27;</span>),</span><br><span class="line">    (<span class="string">&#x27;Conservative families&#x27;</span>,<span class="string">&#x27;DD&#x27;</span>),</span><br><span class="line">    (<span class="string">&#x27;Cruising Seniors&#x27;</span>,<span class="string">&#x27;DL&#x27;</span>),</span><br><span class="line">    (<span class="string">&#x27;Average Family &#x27;</span>,<span class="string">&#x27;MN&#x27;</span>),</span><br><span class="line">    (<span class="string">&#x27;Living well&#x27;</span>,<span class="string">&#x27;KA&#x27;</span>),</span><br><span class="line">    (<span class="string">&#x27;Successful hedonists&#x27;</span>,<span class="string">&#x27;JH&#x27;</span>),</span><br><span class="line">    (<span class="string">&#x27;Retired and Religious&#x27;</span>,<span class="string">&#x27;AX&#x27;</span>),</span><br><span class="line">    (<span class="string">&#x27;Career Loners&#x27;</span>,<span class="string">&#x27;HY&#x27;</span>),(<span class="string">&#x27;Farmers&#x27;</span>,<span class="string">&#x27;JH&#x27;</span>)</span><br><span class="line">], schema=StructType() \</span><br><span class="line">    .add(<span class="string">&quot;Customer_main_type&quot;</span>,<span class="string">&quot;string&quot;</span>) \</span><br><span class="line">    .add(<span class="string">&quot;Region Code&quot;</span>,<span class="string">&quot;string&quot;</span>))</span><br><span class="line">new_df=df.join(region_data,on=<span class="string">&#x27;Customer_main_type&#x27;</span>)</span><br><span class="line">new_df.groupby(<span class="string">&quot;Region Code&quot;</span>).count().show()</span><br></pre></td></tr></table></figure>
<h2 id="Pivoting"><a href="#Pivoting" class="headerlink" title="Pivoting"></a>Pivoting</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">df.groupBy(<span class="string">&#x27;Customer_main_type&#x27;</span>) \</span><br><span class="line">    .pivot(<span class="string">&#x27;Avg_age&#x27;</span>) \ </span><br><span class="line">    .<span class="built_in">sum</span>(<span class="string">&#x27;Avg_Salary&#x27;</span>) \</span><br><span class="line">    .fillna(<span class="number">0</span>) \ </span><br><span class="line">    .show()</span><br><span class="line">df.groupBy(<span class="string">&#x27;Customer_main_type&#x27;</span>) \</span><br><span class="line">    .pivot(<span class="string">&#x27;label&#x27;</span>) \</span><br><span class="line">    .<span class="built_in">sum</span>(<span class="string">&#x27;Avg_Salary&#x27;</span>) \</span><br><span class="line">    .fillna(<span class="number">0</span>) \</span><br><span class="line">    .show()</span><br></pre></td></tr></table></figure>
<h2 id="Window-Functions-or-Windowed-Aggregates"><a href="#Window-Functions-or-Windowed-Aggregates" class="headerlink" title="Window Functions or Windowed Aggregates"></a>Window Functions or Windowed Aggregates</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pyspark.sql.window <span class="keyword">import</span> Window</span><br><span class="line"><span class="keyword">from</span> pyspark.sql.functions <span class="keyword">import</span> col,row_number</span><br><span class="line">win = Window.orderBy(df[<span class="string">&#x27;Avg_Salary&#x27;</span>].desc())</span><br><span class="line">df=df.withColumn(<span class="string">&#x27;rank&#x27;</span>, row_number().over(win).alias(<span class="string">&#x27;rank&#x27;</span>)).show()</span><br><span class="line"></span><br><span class="line">win_1=Window.partitionBy(<span class="string">&quot;Customer_subtype&quot;</span>).orderBy(df[<span class="string">&#x27;Avg_Salary&#x27;</span>].desc())</span><br><span class="line">df=df.withColumn(<span class="string">&#x27;rank&#x27;</span>, row_number().over(win_1).alias(<span class="string">&#x27;rank&#x27;</span>))</span><br><span class="line">df.groupBy(<span class="string">&#x27;rank&#x27;</span>).count().orderBy(<span class="string">&#x27;rank&#x27;</span>).show()</span><br><span class="line">df.<span class="built_in">filter</span>(col(<span class="string">&#x27;rank&#x27;</span>) &lt; <span class="number">4</span>).show()</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://xyshell.github.io/2020/07/26/spark-note/" data-id="clywj85gf001jt895axhw528o" class="article-share-link">
        Share
      </a>
      
<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/spark/" rel="tag">spark</a></li></ul>

    </footer>

  </div>

  

  

</article>
    
    <article id="post-cpp-note" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      
  
  <h2 class="article-title" itemprop="name">
    <a href="/2020/07/13/cpp-note/">CPP Note</a>
  </h2>
  
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/07/13/cpp-note/" class="article-date">
  <time datetime="2020-07-13T06:56:16.000Z" itemprop="datePublished">2020-07-13</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
        <h1 id="Cmake"><a href="#Cmake" class="headerlink" title="Cmake"></a>Cmake</h1><p><a target="_blank" rel="noopener" href="https://chenxiaowei.gitbook.io/cmake-cookbook/">Cmake Cookbook</a></p>
<h2 id="Chapter-1-From-a-Simple-Executable-to-Libraries"><a href="#Chapter-1-From-a-Simple-Executable-to-Libraries" class="headerlink" title="Chapter 1: From a Simple Executable to Libraries"></a>Chapter 1: From a Simple Executable to Libraries</h2><h3 id="1-Compiling-a-single-source-file-into-an-executable"><a href="#1-Compiling-a-single-source-file-into-an-executable" class="headerlink" title="1. Compiling a single source file into an executable"></a>1. Compiling a single source file into an executable</h3><p>CmakeLists.txt</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 3.5 FATAL_ERROR)</span><br><span class="line">project(recipe-01 LANGUAGES CXX) <span class="comment"># default language is c++</span></span><br><span class="line">add_executable(hello-world hello-world.cpp)</span><br></pre></td></tr></table></figure>
<p>Normal steps:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> -p build</span><br><span class="line">$ <span class="built_in">cd</span> build</span><br><span class="line">$ cmake .. <span class="comment"># ../CmakeLists.txt exsits</span></span><br><span class="line">$ cmake --build .bash</span><br></pre></td></tr></table></figure>
<p>Single command build:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cmake -H. -Bbuild</span><br></pre></td></tr></table></figure>
<p>Build outside:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> -p /tmp/someplace</span><br><span class="line">$ <span class="built_in">cd</span> /tmp/someplace</span><br><span class="line">$ cmake /path/to/source</span><br><span class="line">$ cmake --build .</span><br></pre></td></tr></table></figure>
<p>available targets:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ cmake --build . -t <span class="built_in">help</span> <span class="comment"># --target</span></span><br><span class="line"></span><br><span class="line">The following are some of the valid targets <span class="keyword">for</span> this Makefile:</span><br><span class="line">... all (the default <span class="keyword">if</span> no target is provided)</span><br><span class="line">... clean</span><br><span class="line">... depend</span><br><span class="line">... edit_cache</span><br><span class="line">... rebuild_cache</span><br><span class="line">... hello-world</span><br><span class="line">... hello-world.o</span><br><span class="line">... hello-world.i</span><br><span class="line">... hello-world.s</span><br></pre></td></tr></table></figure>
<h3 id="2-Switching-generators"><a href="#2-Switching-generators" class="headerlink" title="2. Switching generators"></a>2. Switching generators</h3><p>Choose Ninja:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> -p build</span><br><span class="line">$ <span class="built_in">cd</span> build</span><br><span class="line">$ cmake -G Ninja .. <span class="comment"># must install Ninja first</span></span><br><span class="line">$ cmake --build .</span><br></pre></td></tr></table></figure>
<p>Single command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmake -H. -Bbuild -GNinja</span><br></pre></td></tr></table></figure>
<h3 id="3-Building-and-linking-static-and-shared-libraries"><a href="#3-Building-and-linking-static-and-shared-libraries" class="headerlink" title="3. Building and linking static and shared libraries"></a>3. Building and linking static and shared libraries</h3><p>CmakeLists.txt</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 3.5 FATAL_ERROR)</span><br><span class="line"></span><br><span class="line">project(recipe-03 LANGUAGES CXX)</span><br><span class="line"></span><br><span class="line"><span class="comment"># generate a library from sources</span></span><br><span class="line">add_library(message</span><br><span class="line">  STATIC</span><br><span class="line">    Message.hpp</span><br><span class="line">    Message.cpp</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">add_executable(hello-world hello-world.cpp)</span><br><span class="line"></span><br><span class="line">target_link_libraries(hello-world message)</span><br></pre></td></tr></table></figure>
<ul>
<li><code>add_library(message STATIC Message.hpp Message.cpp)</code>: add_library’s first param is target name, available for entire CMakeLists.txt to be refered. Actually name will be prefixed with lib and suffixed withbash proper extension by cmake, determined by (STATIC or SHARED) and OS</li>
<li><code>target_link_libraries(hello-world message)</code>: link library to executable and make sure hello-world depends correctly on library. Must after <code>add_library</code>.</li>
</ul>
<p>After build, we get <code>libmessage.a</code> together with executable <code>hello-world</code>.</p>
<p>second parameter of <code>add_library</code>:</p>
<ul>
<li>STATIC：用于创建静态库，即编译文件的打包存档，以便在链接其他目标时使用，例如：可执行文件。</li>
<li>SHARED：用于创建动态库，即可以动态链接，并在运行时加载的库。可以在 CMakeLists.txt 中使用<code>add_library(message SHAREDbash Message.hpp Message.cpp)</code>从静态库切换到动态共享对象(DSO)。</li>
<li>OBJECT：可将给定 add_library 的列表中的源码编译到目标文件，不将它们归档到静态库中，也不能将它们链接到共享对象中。如果需要一次性创建静态库和动态库，那么使用对象库尤其有用。我们将在本示例中演示。</li>
<li>MODULE：又为 DSO 组。与 SHARED 库不同，它们不链接到项目中的任何目标，不过可以进行动态加载。该参数可以用于构建运行时插件。</li>
</ul>
<p>other special type of library:</p>
<ul>
<li>IMPORTED：此类库目标表示位于项目外部的库。此类库的主要用途是，对现有依赖项进行构建。因此，IMPORTED 库将被视为不可变的。我们将在本书的其他章节演示使用 IMPORTED 库的示例。参见: <a target="_blank" rel="noopener" href="https://cmake.org/cmake/help/latest/manual/cmakebuildsystem.7.html#imported-targets">https://cmake.org/cmake/help/latest/manual/cmakebuildsystem.7.html#imported-targets</a></li>
<li>INTERFACE：与 IMPORTED 库类似。不过，该类型库可变，没有位置信息。它主要用于项目之外的目标构建使用。我们将在本章第 5 节中演示 INTERFACE 库的示例。参见: <a target="_blank" rel="noopener" href="https://cmake.org/cmake/help/latest/manual/cmake-buildsystem.7.html#interface-libraries">https://cmake.org/cmake/help/latest/manual/cmake-buildsystem.7.html#interface-libraries</a></li>
<li>ALIAS：顾名思义，这种库为项目中已存在的库目标定义别名。不过，不能为 IMPORTED 库选择别名。参见: <a target="_blank" rel="noopener" href="https://cmake.org/cmake/help/latest/manual/cmake-buildsystem.7.html#alias-libraries">https://cmake.org/cmake/help/latest/manual/cmake-buildsystem.7.html#alias-libraries</a></li>
</ul>
<p>Make dynamic linking, optional to set name to <code>message-shared</code> and use set_target_properties so <code>#include &quot;message.h&quot;</code> is available in source code:</p>
<p>CmakeLists.txt</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 3.5 FATAL_ERROR)</span><br><span class="line"></span><br><span class="line">project(recipe-03 LANGUAGES CXX)</span><br><span class="line"></span><br><span class="line">add_library(message-shared</span><br><span class="line">  SHARED</span><br><span class="line">    Message.hpp</span><br><span class="line">    Message.cpp</span><br><span class="line">  )</span><br><span class="line">set_target_properties(message-shared</span><br><span class="line">  PROPERTIES</span><br><span class="line">    OUTPUT_NAME <span class="string">&quot;message&quot;</span></span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">add_executable(hello-world hello-world.cpp)</span><br><span class="line"></span><br><span class="line">target_link_libraries(hello-world message-shared)</span><br></pre></td></tr></table></figure>
<h3 id="4-Controlling-compilation-with-conditionals"><a href="#4-Controlling-compilation-with-conditionals" class="headerlink" title="4. Controlling compilation with conditionals"></a>4. Controlling compilation with conditionals</h3><p>CmakeLists.txt</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># set minimum cmake version</span></span><br><span class="line">cmake_minimum_required(VERSION 3.5 FATAL_ERROR)</span><br><span class="line"></span><br><span class="line"><span class="comment"># project name and language</span></span><br><span class="line">project(recipe-04 LANGUAGES CXX)</span><br><span class="line"></span><br><span class="line"><span class="comment"># introduce a toggle for using a library</span></span><br><span class="line"><span class="built_in">set</span>(USE_LIBRARY OFF)</span><br><span class="line"></span><br><span class="line">message(STATUS <span class="string">&quot;Compile sources into a library? <span class="variable">$&#123;USE_LIBRARY&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># BUILD_SHARED_LIBS is a global flag offered by CMake</span></span><br><span class="line"><span class="comment"># to toggle the behavior of add_library</span></span><br><span class="line"><span class="built_in">set</span>(BUILD_SHARED_LIBS OFF)</span><br><span class="line"></span><br><span class="line"><span class="comment"># list sources</span></span><br><span class="line">list(APPEND _sources Message.hpp Message.cpp)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(USE_LIBRARY)</span><br><span class="line">  <span class="comment"># add_library will create a static library</span></span><br><span class="line">  <span class="comment"># since BUILD_SHARED_LIBS is OFF</span></span><br><span class="line">  add_library(message <span class="variable">$&#123;_sources&#125;</span>)</span><br><span class="line"></span><br><span class="line">  add_executable(hello-world hello-world.cpp)</span><br><span class="line"></span><br><span class="line">  target_link_libraries(hello-world message)</span><br><span class="line"><span class="keyword">else</span>()</span><br><span class="line">  add_executable(hello-world hello-world.cpp <span class="variable">$&#123;_sources&#125;</span>)</span><br><span class="line">endif()</span><br></pre></td></tr></table></figure>
<h3 id="5-Presenting-options-to-the-user"><a href="#5-Presenting-options-to-the-user" class="headerlink" title="5. Presenting options to the user"></a>5. Presenting options to the user</h3><p>CmakeLists.txt</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># set minimum cmake version</span></span><br><span class="line">cmake_minimum_required(VERSION 3.5 FATAL_ERROR)</span><br><span class="line"></span><br><span class="line"><span class="comment"># project name and language</span></span><br><span class="line">project(recipe-05 LANGUAGES CXX)</span><br><span class="line"></span><br><span class="line"><span class="comment"># expose options to the user</span></span><br><span class="line">option(USE_LIBRARY <span class="string">&quot;Compile sources into a library&quot;</span> OFF)</span><br><span class="line"></span><br><span class="line">message(STATUS <span class="string">&quot;Compile sources into a library? <span class="variable">$&#123;USE_LIBRARY&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">include(CMakeDependentOption)</span><br><span class="line"></span><br><span class="line"><span class="comment"># second option depends on the value of the first</span></span><br><span class="line">cmake_dependent_option(</span><br><span class="line">  MAKE_STATIC_LIBRARY <span class="string">&quot;Compile sources into a static library&quot;</span> OFF</span><br><span class="line">  <span class="string">&quot;USE_LIBRARY&quot;</span> ON</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line"><span class="comment"># third option depends on the value of the first</span></span><br><span class="line">cmake_dependent_option(</span><br><span class="line">  MAKE_SHARED_LIBRARY <span class="string">&quot;Compile sources into a shared library&quot;</span> ON</span><br><span class="line">  <span class="string">&quot;USE_LIBRARY&quot;</span> ON</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_WINDOWS_EXPORT_ALL_SYMBOLS ON)</span><br><span class="line"></span><br><span class="line"><span class="comment"># list sources</span></span><br><span class="line">list(APPEND _sources Message.hpp Message.cpp)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(USE_LIBRARY)</span><br><span class="line">  message(STATUS <span class="string">&quot;Compile sources into a STATIC library? <span class="variable">$&#123;MAKE_STATIC_LIBRARY&#125;</span>&quot;</span>)</span><br><span class="line">  message(STATUS <span class="string">&quot;Compile sources into a SHARED library? <span class="variable">$&#123;MAKE_SHARED_LIBRARY&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(MAKE_SHARED_LIBRARY)</span><br><span class="line">    add_library(message SHARED <span class="variable">$&#123;_sources&#125;</span>)</span><br><span class="line"></span><br><span class="line">    add_executable(hello-world hello-world.cpp)</span><br><span class="line"></span><br><span class="line">    target_link_libraries(hello-world message)</span><br><span class="line">  endif()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(MAKE_STATIC_LIBRARY)</span><br><span class="line">    add_library(message STATIC <span class="variable">$&#123;_sources&#125;</span>)</span><br><span class="line"></span><br><span class="line">    add_executable(hello-world hello-world.cpp)</span><br><span class="line"></span><br><span class="line">    target_link_libraries(hello-world message)</span><br><span class="line">  endif()</span><br><span class="line"><span class="keyword">else</span>()</span><br><span class="line">  add_executable(hello-world hello-world.cpp <span class="variable">$&#123;_sources&#125;</span>)</span><br><span class="line">endif()</span><br></pre></td></tr></table></figure>
<p>to toggle options:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cmake -D USE_LIBRARY=OFF -D MAKE_SHARED_LIBRARY=ON ..</span><br></pre></td></tr></table></figure>
<h3 id="6-Specifying-the-compiler"><a href="#6-Specifying-the-compiler" class="headerlink" title="6. Specifying the compiler"></a>6. Specifying the compiler</h3><p>prefered:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cmake -D CMAKE_CXX_COMPILER=clang++ ..</span><br></pre></td></tr></table></figure>
<p>not prefered:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">env</span> CXX=clang++ cmake ..</span><br></pre></td></tr></table></figure>
<p>CMakeLists.txt</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># set minimum cmake version</span></span><br><span class="line">cmake_minimum_required(VERSION 3.5 FATAL_ERROR)</span><br><span class="line"></span><br><span class="line"><span class="comment"># project name and language</span></span><br><span class="line">project(recipe-06 LANGUAGES C CXX)</span><br><span class="line"></span><br><span class="line">message(STATUS <span class="string">&quot;Is the C++ compiler loaded? <span class="variable">$&#123;CMAKE_CXX_COMPILER_LOADED&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">if</span>(CMAKE_CXX_COMPILER_LOADED)</span><br><span class="line">  message(STATUS <span class="string">&quot;The C++ compiler ID is: <span class="variable">$&#123;CMAKE_CXX_COMPILER_ID&#125;</span>&quot;</span>)</span><br><span class="line">  message(STATUS <span class="string">&quot;Is the C++ from GNU? <span class="variable">$&#123;CMAKE_COMPILER_IS_GNUCXX&#125;</span>&quot;</span>)</span><br><span class="line">  message(STATUS <span class="string">&quot;The C++ compiler version is: <span class="variable">$&#123;CMAKE_CXX_COMPILER_VERSION&#125;</span>&quot;</span>)</span><br><span class="line">endif()</span><br><span class="line"></span><br><span class="line">message(STATUS <span class="string">&quot;Is the C compiler loaded? <span class="variable">$&#123;CMAKE_C_COMPILER_LOADED&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">if</span>(CMAKE_C_COMPILER_LOADED)</span><br><span class="line">  message(STATUS <span class="string">&quot;The C compiler ID is: <span class="variable">$&#123;CMAKE_C_COMPILER_ID&#125;</span>&quot;</span>)</span><br><span class="line">  message(STATUS <span class="string">&quot;Is the C from GNU? <span class="variable">$&#123;CMAKE_COMPILER_IS_GNUCC&#125;</span>&quot;</span>)</span><br><span class="line">  message(STATUS <span class="string">&quot;The C compiler version is: <span class="variable">$&#123;CMAKE_C_COMPILER_VERSION&#125;</span>&quot;</span>)</span><br><span class="line">endif()</span><br></pre></td></tr></table></figure>
<h3 id="7-Switching-the-build-type"><a href="#7-Switching-the-build-type" class="headerlink" title="7. Switching the build type"></a>7. Switching the build type</h3><ul>
<li>Debug：用于在没有优化的情况下，使用带有调试符号构建库或可执行文件。</li>
<li>Release：用于构建的优化的库或可执行文件，不包含调试符号。</li>
<li>RelWithDebInfo：用于构建较少的优化库或可执行文件，包含调试符号。</li>
<li>MinSizeRel：用于不增加目标代码大小的优化方式，来构建库或可执行文件。</li>
</ul>
<p>CMakeLists.txt</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># set minimum cmake version</span></span><br><span class="line">cmake_minimum_required(VERSION 3.5 FATAL_ERROR)</span><br><span class="line"></span><br><span class="line"><span class="comment"># project name and language</span></span><br><span class="line">project(recipe-07 LANGUAGES C CXX)</span><br><span class="line"></span><br><span class="line"><span class="comment"># we default to Release build type</span></span><br><span class="line"><span class="keyword">if</span>(NOT CMAKE_BUILD_TYPE)</span><br><span class="line">  <span class="built_in">set</span>(CMAKE_BUILD_TYPE Release CACHE STRING <span class="string">&quot;Build type&quot;</span> FORCE)</span><br><span class="line">endif()</span><br><span class="line"></span><br><span class="line">message(STATUS <span class="string">&quot;Build type: <span class="variable">$&#123;CMAKE_BUILD_TYPE&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">message(STATUS <span class="string">&quot;C flags, Debug configuration: <span class="variable">$&#123;CMAKE_C_FLAGS_DEBUG&#125;</span>&quot;</span>)</span><br><span class="line">message(STATUS <span class="string">&quot;C flags, Release configuration: <span class="variable">$&#123;CMAKE_C_FLAGS_RELEASE&#125;</span>&quot;</span>)</span><br><span class="line">message(STATUS <span class="string">&quot;C flags, Release configuration with Debug info: <span class="variable">$&#123;CMAKE_C_FLAGS_RELWITHDEBINFO&#125;</span>&quot;</span>)</span><br><span class="line">message(STATUS <span class="string">&quot;C flags, minimal Release configuration: <span class="variable">$&#123;CMAKE_C_FLAGS_MINSIZEREL&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">message(STATUS <span class="string">&quot;C++ flags, Debug configuration: <span class="variable">$&#123;CMAKE_CXX_FLAGS_DEBUG&#125;</span>&quot;</span>)</span><br><span class="line">message(STATUS <span class="string">&quot;C++ flags, Release configuration: <span class="variable">$&#123;CMAKE_CXX_FLAGS_RELEASE&#125;</span>&quot;</span>)</span><br><span class="line">message(STATUS <span class="string">&quot;C++ flags, Release configuration with Debug info: <span class="variable">$&#123;CMAKE_CXX_FLAGS_RELWITHDEBINFO&#125;</span>&quot;</span>)</span><br><span class="line">message(STATUS <span class="string">&quot;C++ flags, minimal Release configuration: <span class="variable">$&#123;CMAKE_CXX_FLAGS_MINSIZEREL&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>to switch build type:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cmake -D CMAKE_BUILD_TYPE=Debug ..</span><br></pre></td></tr></table></figure>
<h3 id="8-Controlling-compiler-flags"><a href="#8-Controlling-compiler-flags" class="headerlink" title="8. Controlling compiler flags"></a>8. Controlling compiler flags</h3><p>CMakeLists.txt</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># set minimum cmake version</span></span><br><span class="line">cmake_minimum_required(VERSION 3.5 FATAL_ERROR)</span><br><span class="line"></span><br><span class="line"><span class="comment"># project name and language</span></span><br><span class="line">project(recipe-08 LANGUAGES CXX)</span><br><span class="line"></span><br><span class="line">message(<span class="string">&quot;C++ compiler flags: <span class="variable">$&#123;CMAKE_CXX_FLAGS&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">list(APPEND flags <span class="string">&quot;-fPIC&quot;</span> <span class="string">&quot;-Wall&quot;</span>)</span><br><span class="line"><span class="keyword">if</span>(NOT WIN32)</span><br><span class="line">  list(APPEND flags <span class="string">&quot;-Wextra&quot;</span> <span class="string">&quot;-Wpedantic&quot;</span>)</span><br><span class="line">endif()</span><br><span class="line"></span><br><span class="line">add_library(geometry</span><br><span class="line">  STATIC</span><br><span class="line">    geometry_circle.cpp</span><br><span class="line">    geometry_circle.hpp</span><br><span class="line">    geometry_polygon.cpp</span><br><span class="line">    geometry_polygon.hpp</span><br><span class="line">    geometry_rhombus.cpp</span><br><span class="line">    geometry_rhombus.hpp</span><br><span class="line">    geometry_square.cpp</span><br><span class="line">    geometry_square.hpp</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">target_compile_options(geometry</span><br><span class="line">  PRIVATE</span><br><span class="line">    <span class="variable">$&#123;flags&#125;</span></span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">add_executable(compute-areas compute-areas.cpp)</span><br><span class="line"></span><br><span class="line">target_compile_options(compute-areas</span><br><span class="line">  PRIVATE</span><br><span class="line">    <span class="string">&quot;-fPIC&quot;</span></span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">target_link_libraries(compute-areas geometry)</span><br></pre></td></tr></table></figure>
<h3 id="9-Setting-the-standard-for-the-language"><a href="#9-Setting-the-standard-for-the-language" class="headerlink" title="9. Setting the standard for the language"></a>9. Setting the standard for the language</h3><p>CMakeLists.txt</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># set minimum cmake version</span></span><br><span class="line">cmake_minimum_required(VERSION 3.5 FATAL_ERROR)</span><br><span class="line"></span><br><span class="line"><span class="comment"># project name and language</span></span><br><span class="line">project(recipe-09 LANGUAGES CXX)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_WINDOWS_EXPORT_ALL_SYMBOLS ON)</span><br><span class="line"></span><br><span class="line">add_library(animals</span><br><span class="line">  SHARED</span><br><span class="line">    Animal.cpp</span><br><span class="line">    Animal.hpp</span><br><span class="line">    Cat.cpp</span><br><span class="line">    Cat.hpp</span><br><span class="line">    Dog.cpp</span><br><span class="line">    Dog.hpp</span><br><span class="line">    Factory.hpp</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">set_target_properties(animals</span><br><span class="line">  PROPERTIES</span><br><span class="line">    CXX_STANDARD 14</span><br><span class="line">    CXX_EXTENSIONS OFF</span><br><span class="line">    CXX_STANDARD_REQUIRED ON</span><br><span class="line">    POSITION_INDEPENDENT_CODE 1</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">add_executable(animal-farm animal-farm.cpp)</span><br><span class="line"></span><br><span class="line">set_target_properties(animal-farm</span><br><span class="line">  PROPERTIES</span><br><span class="line">    CXX_STANDARD 14</span><br><span class="line">    CXX_EXTENSIONS OFF</span><br><span class="line">    CXX_STANDARD_REQUIRED ON</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">target_link_libraries(animal-farm animals)</span><br></pre></td></tr></table></figure>
<h3 id="10-Using-control-flow-constructs"><a href="#10-Using-control-flow-constructs" class="headerlink" title="10. Using control flow constructs"></a>10. Using control flow constructs</h3><p>CMakeLists.txt</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># set minimum cmake version</span></span><br><span class="line">cmake_minimum_required(VERSION 3.5 FATAL_ERROR)</span><br><span class="line"></span><br><span class="line"><span class="comment"># project name and language</span></span><br><span class="line">project(recipe-10 LANGUAGES CXX)</span><br><span class="line"></span><br><span class="line">add_library(geometry</span><br><span class="line">  STATIC</span><br><span class="line">    geometry_circle.cpp</span><br><span class="line">    geometry_circle.hpp</span><br><span class="line">    geometry_polygon.cpp</span><br><span class="line">    geometry_polygon.hpp</span><br><span class="line">    geometry_rhombus.cpp</span><br><span class="line">    geometry_rhombus.hpp</span><br><span class="line">    geometry_square.cpp</span><br><span class="line">    geometry_square.hpp</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line"><span class="comment"># we wish to compile the library with the optimization flag: -O3</span></span><br><span class="line">target_compile_options(geometry</span><br><span class="line">  PRIVATE</span><br><span class="line">    -O3</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">list(</span><br><span class="line">  APPEND sources_with_lower_optimization</span><br><span class="line">    geometry_circle.cpp</span><br><span class="line">    geometry_rhombus.cpp</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line"><span class="comment"># we use the IN LISTS foreach syntax to set source properties</span></span><br><span class="line">message(STATUS <span class="string">&quot;Setting source properties using IN LISTS syntax:&quot;</span>)</span><br><span class="line">foreach(_source IN LISTS sources_with_lower_optimization)</span><br><span class="line">  set_source_files_properties(<span class="variable">$&#123;_source&#125;</span> PROPERTIES COMPILE_FLAGS -O2)</span><br><span class="line">  message(STATUS <span class="string">&quot;Appending -O2 flag for <span class="variable">$&#123;_source&#125;</span>&quot;</span>)</span><br><span class="line">endforeach()</span><br><span class="line"></span><br><span class="line"><span class="comment"># we demonstrate the plain foreach syntax to query source properties</span></span><br><span class="line"><span class="comment"># which requires to expand the contents of the variable</span></span><br><span class="line">message(STATUS <span class="string">&quot;Querying sources properties using plain syntax:&quot;</span>)</span><br><span class="line">foreach(_source <span class="variable">$&#123;sources_with_lower_optimization&#125;</span>)</span><br><span class="line">  get_source_file_property(_flags <span class="variable">$&#123;_source&#125;</span> COMPILE_FLAGS)</span><br><span class="line">  message(STATUS <span class="string">&quot;Source <span class="variable">$&#123;_source&#125;</span> has the following extra COMPILE_FLAGS: <span class="variable">$&#123;_flags&#125;</span>&quot;</span>)</span><br><span class="line">endforeach()</span><br><span class="line"></span><br><span class="line">add_executable(compute-areas compute-areas.cpp)</span><br><span class="line"></span><br><span class="line">target_link_libraries(compute-areas geometry)</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://xyshell.github.io/2020/07/13/cpp-note/" data-id="clywj85g00008t8957t5d77ag" class="article-share-link">
        Share
      </a>
      
<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cpp/" rel="tag">cpp</a></li></ul>

    </footer>

  </div>

  

  

</article>
    
    <article id="post-julia-note" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      
  
  <h2 class="article-title" itemprop="name">
    <a href="/2020/07/09/julia-note/">Julia Note</a>
  </h2>
  
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/07/09/julia-note/" class="article-date">
  <time datetime="2020-07-09T18:31:27.000Z" itemprop="datePublished">2020-07-09</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
        <h1 id="Variable"><a href="#Variable" class="headerlink" title="Variable"></a>Variable</h1><h2 id="Stylistic-Conventions"><a href="#Stylistic-Conventions" class="headerlink" title="Stylistic Conventions"></a>Stylistic Conventions</h2><ul>
<li><p>Names of variables are in lower case.</p>
</li>
<li><p>Word separation can be indicated by underscores (‘_’), but use of underscores is discouraged unless the name would be hard to read otherwise.</p>
</li>
<li><p>Names of Types and Modules begin with a capital letter and word separation is shown with upper camel case instead of underscores.</p>
</li>
<li><p>Names of functions and macros are in lower case, without underscores.</p>
</li>
<li><p>Functions that write to their arguments have names that end in !. These are sometimes called “mutating” or “in-place” functions because they are intended to produce changes in their arguments after the function is called, not just return a value.</p>
</li>
</ul>
<h1 id="Package"><a href="#Package" class="headerlink" title="Package"></a>Package</h1><h2 id="Add-package"><a href="#Add-package" class="headerlink" title="Add package"></a>Add package</h2><figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Pkg; Pkg.add(<span class="string">&quot;Date&quot;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="Use-package"><a href="#Use-package" class="headerlink" title="Use package"></a>Use package</h2><figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Dates</span><br><span class="line">isleapyear(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Dates</span><br><span class="line">Dates.isleapyear(<span class="number">4</span>)</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://xyshell.github.io/2020/07/09/julia-note/" data-id="clywj85g7000pt895bqsh12kq" class="article-share-link">
        Share
      </a>
      
<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/julia/" rel="tag">julia</a></li></ul>

    </footer>

  </div>

  

  

</article>
    
    <article id="post-js-note" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      
  
  <h2 class="article-title" itemprop="name">
    <a href="/2020/07/02/js-note/">JS Note</a>
  </h2>
  
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/07/02/js-note/" class="article-date">
  <time datetime="2020-07-02T23:23:21.000Z" itemprop="datePublished">2020-07-02</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
        <h1 id="Template-literals-String-literals"><a href="#Template-literals-String-literals" class="headerlink" title="Template literals (String literals)"></a>Template literals (String literals)</h1><p>add variables at runtime</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> msg = <span class="string">`some <span class="subst">$&#123;variable1&#125;</span>, </span></span><br><span class="line"><span class="string">    <span class="subst">$&#123;<span class="string">&quot;$&quot;</span> + variable2&#125;</span>`</span>;</span><br></pre></td></tr></table></figure>
<p>use tag function to add bold style to variables in template literals</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">highlighText</span>(<span class="params">strings, ...values</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> str = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; strings.<span class="property">raw</span>.<span class="property">lengths</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      str += <span class="string">`&lt;b&gt;<span class="subst">$&#123;values[i - <span class="number">1</span>]&#125;</span>&lt;/b&gt;`</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    str += strings.<span class="property">raw</span>[i];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> msg = highlighText<span class="string">`some <span class="subst">$&#123;variable1&#125;</span>, <span class="subst">$&#123;<span class="string">&quot;$&quot;</span> + variable2&#125;</span>`</span>;</span><br></pre></td></tr></table></figure>
<h1 id="var-let-and-const"><a href="#var-let-and-const" class="headerlink" title="var, let and const"></a>var, let and const</h1><p>var:</p>
<ul>
<li>no block scope</li>
<li>can be redeclared anywhere</li>
<li>can be used and reassigned anywhere</li>
</ul>
<p>let:</p>
<ul>
<li>block scope</li>
<li>can’t be redeclared within scope</li>
<li>can be reassigned within scope</li>
</ul>
<p>const:</p>
<ul>
<li>block scope</li>
<li>can’t be reassigned or redeclared</li>
<li>the value <strong>can</strong> be changed</li>
</ul>
<p>const is more used as readability purpose</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> arr = [<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line">arr = <span class="number">3</span>; <span class="comment">// error</span></span><br><span class="line">arr[<span class="number">0</span>] = <span class="number">22</span>; <span class="comment">// okay!</span></span><br><span class="line"><span class="keyword">var</span> arr = <span class="title class_">Object</span>.<span class="title function_">freeze</span>([<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]); <span class="comment">// instead</span></span><br></pre></td></tr></table></figure>
<h1 id="Destructing-an-array-or-object"><a href="#Destructing-an-array-or-object" class="headerlink" title="Destructing an array or object"></a>Destructing an array or object</h1><p>array:</p>
<ul>
<li>don’t have to catch all values in the array</li>
<li>variable is undefined if arr is not enough to unpack</li>
<li>can set default value</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> [a, b = <span class="literal">true</span>, c, ...moreArgs] = arr;</span><br></pre></td></tr></table></figure>
<p>object:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> &#123; <span class="title class_">Id</span>, <span class="title class_">ApplicantName</span> = <span class="string">&quot;Barry&quot;</span> &#125; = obj;</span><br></pre></td></tr></table></figure>
<h1 id="String"><a href="#String" class="headerlink" title="String"></a>String</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">str.<span class="title function_">trim</span>(); <span class="comment">// trim white space</span></span><br><span class="line">str.<span class="title function_">toLowerCase</span>();</span><br><span class="line">str.<span class="title function_">startWith</span>(<span class="string">&quot;dr&quot;</span>);</span><br><span class="line">str.<span class="title function_">endWith</span>(<span class="string">&quot;md&quot;</span>, <span class="number">4</span>);</span><br><span class="line">str.<span class="title function_">search</span>(<span class="string">&quot;house&quot;</span>);</span><br><span class="line">str.<span class="title function_">includes</span>(<span class="string">&quot;house&quot;</span>);</span><br></pre></td></tr></table></figure>
<h1 id="Number"><a href="#Number" class="headerlink" title="Number"></a>Number</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Number</span>.<span class="title function_">isInteger</span>(num); <span class="comment">// 25.0 is integer</span></span><br><span class="line"><span class="title class_">Number</span>.<span class="property">MAX_SAFE_INTEGER</span>; <span class="comment">// Number.MIN_SAFE_INTEGER</span></span><br><span class="line"><span class="title class_">Number</span>.<span class="title function_">isSafeInteger</span>(num);</span><br></pre></td></tr></table></figure>
<h1 id="Symbol"><a href="#Symbol" class="headerlink" title="Symbol"></a>Symbol</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> id = <span class="title class_">Symbol</span>(<span class="string">&quot;My Id&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> id2 = <span class="title class_">Symbol</span>(<span class="string">&quot;My Id&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(id === id2); <span class="comment">// false</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> id = <span class="title class_">Symbol</span>.<span class="title function_">for</span>(<span class="string">&quot;My Id&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> id2 = <span class="title class_">Symbol</span>.<span class="title function_">for</span>(<span class="string">&quot;My Id&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(id === id2); <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// create secret property</span></span><br><span class="line"><span class="keyword">var</span> loan = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;Barry&quot;</span>,</span><br><span class="line">    [<span class="title class_">Symbol</span>(<span class="string">&quot;income&quot;</span>)]: <span class="number">15000</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(load[<span class="title class_">Symbol</span>.<span class="title function_">for</span>(<span class="string">&quot;income&quot;</span>)]); <span class="comment">// 15000</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="title function_">getOwnPropertyNames</span>(loan)); <span class="comment">// [&quot;name&quot;]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="title function_">getOwnPropertySymbol</span>(loan)); <span class="comment">// [Symbol(income)]</span></span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://xyshell.github.io/2020/07/02/js-note/" data-id="clywj85g7000mt895caw4favr" class="article-share-link">
        Share
      </a>
      
<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/" rel="tag">javascript</a></li></ul>

    </footer>

  </div>

  

  

</article>
    
    <article id="post-network-note" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      
  
  <h2 class="article-title" itemprop="name">
    <a href="/2020/06/20/network-note/">Network Note</a>
  </h2>
  
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/06/20/network-note/" class="article-date">
  <time datetime="2020-06-20T18:45:44.000Z" itemprop="datePublished">2020-06-20</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
        <h1 id="OSI-Model"><a href="#OSI-Model" class="headerlink" title="OSI Model"></a>OSI Model</h1><p><img src="/photos/intro-network-note/OSI_model.png" alt="OSI_model"></p>
<h1 id="Protocols"><a href="#Protocols" class="headerlink" title="Protocols"></a>Protocols</h1><h2 id="Data-Transfer"><a href="#Data-Transfer" class="headerlink" title="Data Transfer"></a>Data Transfer</h2><p><img src="/photos/intro-network-note/http.png" alt="http"></p>
<h2 id="File-Transfer"><a href="#File-Transfer" class="headerlink" title="File Transfer"></a>File Transfer</h2><p><img src="/photos/intro-network-note/ftp.png" alt="ftp"></p>
<h2 id="Email"><a href="#Email" class="headerlink" title="Email"></a>Email</h2><p><img src="/photos/intro-network-note/email.png" alt="email"></p>
<h2 id="Authentication"><a href="#Authentication" class="headerlink" title="Authentication"></a>Authentication</h2><p><img src="/photos/intro-network-note/auth.png" alt="auth"></p>
<h2 id="Network-Service"><a href="#Network-Service" class="headerlink" title="Network Service"></a>Network Service</h2><p><img src="/photos/intro-network-note/dhcp.png" alt="dhcp"></p>
<h2 id="Domain-Name-System-DNS"><a href="#Domain-Name-System-DNS" class="headerlink" title="Domain Name System(DNS)"></a>Domain Name System(DNS)</h2><p><img src="/photos/intro-network-note/dns.png" alt="dns"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ nslookup google.com <span class="comment"># check google&#x27;s ip</span></span><br><span class="line">$ nslookup </span><br><span class="line">&gt; facebook.com</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ nslookup</span><br><span class="line">&gt; server 8.8.8.8 <span class="comment"># config dns server</span></span><br></pre></td></tr></table></figure>
<h2 id="Network-Time-Protocol-NTP"><a href="#Network-Time-Protocol-NTP" class="headerlink" title="Network Time Protocol(NTP)"></a>Network Time Protocol(NTP)</h2><p><img src="/photos/intro-network-note/ntp.png" alt="ntp"></p>
<h2 id="Network-Management"><a href="#Network-Management" class="headerlink" title="Network Management"></a>Network Management</h2><p><img src="/photos/intro-network-note/ssh_telnet.png" alt="ssh_telnet"></p>
<p>ssh: encryted; telnet: clear text</p>
<p>ssh used encrypt ftp</p>
<p><img src="/photos/intro-network-note/snmp.png" alt="snmp"></p>
<p>Walk the tree: server collect information(statistics, log) from client</p>
<p>Trap: client send SNMP trap to server</p>
<h2 id="Remote-Desktop-Protocol-RDP"><a href="#Remote-Desktop-Protocol-RDP" class="headerlink" title="Remote Desktop Protocol(RDP)"></a>Remote Desktop Protocol(RDP)</h2><p><img src="/photos/intro-network-note/rdp.png" alt="rdp"></p>
<h2 id="Audio-Visual-Protocol"><a href="#Audio-Visual-Protocol" class="headerlink" title="Audio/Visual Protocol"></a>Audio/Visual Protocol</h2><p><img src="/photos/intro-network-note/h323.png" alt="h323"></p>
<p><img src="/photos/intro-network-note/sip.png" alt="sip"></p>
<p>session initiation protocol: voice over ip communication</p>
<h1 id="TCP-and-UDP"><a href="#TCP-and-UDP" class="headerlink" title="TCP and UDP"></a>TCP and UDP</h1><p>TCP: transmission control protocol</p>
<p>UDP: user datagram protocol</p>
<h2 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h2><p>reliable, verifiable(sequence numbers / acknowledge numbers), notion of session</p>
<h3 id="The-3-way-handshake"><a href="#The-3-way-handshake" class="headerlink" title="The 3-way handshake"></a>The 3-way handshake</h3><p><img src="/photos/intro-network-note/3way.png" alt="3way"></p>
<ol>
<li>SYN: send syn msg, wait for reply from server(change state to SYN-RECEIVED)</li>
<li>SYN-ACK: send msg to client</li>
<li>ACK: client respond to server</li>
</ol>
<p>then session establish between client and server by layer 4 protocol</p>
<p>client or server can ask for missing / additional information from each other</p>
<p>then use layer 7 protocol</p>
<h3 id="The-4-way-Disconnect"><a href="#The-4-way-Disconnect" class="headerlink" title="The 4-way Disconnect"></a>The 4-way Disconnect</h3><p><img src="/photos/intro-network-note/4way.png" alt="4way"></p>
<ol>
<li>FIN: server to client</li>
<li>FIN-ACK: client to server</li>
<li>FIN: client to server</li>
<li>FIN-ACK</li>
</ol>
<p>shutdown the session</p>
<p>RST: tcp reset, server to client, to shutdown quickly</p>
<h2 id="UDP"><a href="#UDP" class="headerlink" title="UDP"></a>UDP</h2><p>no 3-way handshake, no reliable communication, no sequence numbers / acknowledge numbers</p>
<p>very efficient for small data transfer (e.x. DNS)</p>
<p><img src="/photos/intro-network-note/udp.png" alt="udp"></p>
<h2 id="Port-numbers-Transport-layer-addressing"><a href="#Port-numbers-Transport-layer-addressing" class="headerlink" title="Port numbers(Transport layer addressing)"></a>Port numbers(Transport layer addressing)</h2><p><img src="/photos/intro-network-note/port.png" alt="port"></p>
<h3 id="Source-port-and-Destination-port"><a href="#Source-port-and-Destination-port" class="headerlink" title="Source port and Destination port"></a>Source port and Destination port</h3><p><img src="/photos/intro-network-note/src_dstnt.png" alt="src_dstnt"></p>
<h2 id="Application-layer-portocol-dependency"><a href="#Application-layer-portocol-dependency" class="headerlink" title="Application layer portocol dependency"></a>Application layer portocol dependency</h2><p><img src="/photos/intro-network-note/protocol_dependency_1.png" alt="protocol_dependency_1"></p>
<p><img src="/photos/intro-network-note/protocol_dependency_2.png" alt="protocol_dependency_2"></p>
<h1 id="IP-Addressing"><a href="#IP-Addressing" class="headerlink" title="IP Addressing"></a>IP Addressing</h1><ul>
<li><p>unicast: class A, B, C(public internet), one device to one device</p>
</li>
<li><p>multicast: class D(enterprise org’s live video streamming), one device to many devices</p>
</li>
<li><p>experimental: class E</p>
</li>
</ul>
<h2 id="class-A"><a href="#class-A" class="headerlink" title="class A"></a>class A</h2><p><img src="/photos/intro-network-note/class_a.png" alt="class_a"></p>
<h2 id="class-B"><a href="#class-B" class="headerlink" title="class B"></a>class B</h2><p><img src="/photos/intro-network-note/class_b.png" alt="class_b"></p>
<h2 id="class-C"><a href="#class-C" class="headerlink" title="class C"></a>class C</h2><p><img src="/photos/intro-network-note/class_c.png" alt="class_c"></p>
<h2 id="class-D"><a href="#class-D" class="headerlink" title="class D"></a>class D</h2><p><img src="/photos/intro-network-note/class_d.png" alt="class_d"></p>
<h2 id="Address-types"><a href="#Address-types" class="headerlink" title="Address types"></a>Address types</h2><p><img src="/photos/intro-network-note/address_types.png" alt="address_types"></p>
<h2 id="Private-ip-address"><a href="#Private-ip-address" class="headerlink" title="Private ip address"></a>Private ip address</h2><p>127.0.0.1: loopback address, localhost</p>
<p><img src="/photos/intro-network-note/private_ip.png" alt="private_ip"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://xyshell.github.io/2020/06/20/network-note/" data-id="clywj85g9000ut895aqwb0rt2" class="article-share-link">
        Share
      </a>
      
<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/network/" rel="tag">network</a></li></ul>

    </footer>

  </div>

  

  

</article>
    
    <article id="post-k8s-note" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      
  
  <h2 class="article-title" itemprop="name">
    <a href="/2020/06/17/k8s-note/">k8s Note</a>
  </h2>
  
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/06/17/k8s-note/" class="article-date">
  <time datetime="2020-06-18T02:00:10.000Z" itemprop="datePublished">2020-06-17</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
        <h1 id="Kubernetes-Architecture"><a href="#Kubernetes-Architecture" class="headerlink" title="Kubernetes Architecture"></a>Kubernetes Architecture</h1><p><img src="/photos/k8s-note/k8s_architecture.png" alt="k8s_architecture"></p>
<h2 id="Master-Node"><a href="#Master-Node" class="headerlink" title="Master Node"></a>Master Node</h2><p><img src="/photos/k8s-note/master_node.png" alt="master_node"></p>
<p>control plane responsible for managing the state of a Kubernetes cluster(brain)</p>
<p>users send requests to the master node via a Command Line Interface (CLI) tool, a Web User-Interface (Web UI) Dashboard, or Application Programming Interface (API)</p>
<p>master node replicas are added to the cluster, configured in High-Availability (HA) mode to ensure the control plane’s fault tolerance. While only one of the master node replicas actively manages the cluster, the control plane components stay in sync across the master node replicas</p>
<p>4 components:</p>
<ol>
<li>API server</li>
<li>Scheduler</li>
<li>Controller managers</li>
<li>etcd</li>
</ol>
<h3 id="API-Server"><a href="#API-Server" class="headerlink" title="API Server"></a>API Server</h3><p>a central control plane component, coordinating all the administrative tasks</p>
<p>reads the Kubernetes cluster’s current state from the etcd, and after a call’s execution, saves the resulting state of the Kubernetes cluster in etcd(only master plane component talks to etcd)</p>
<p>designed to scale horizontally: it scales by deploying more instances to balance traffic between those instances</p>
<p>highly configurable and customizable, supports the addition of custom API servers</p>
<h3 id="Scheduler"><a href="#Scheduler" class="headerlink" title="Scheduler"></a>Scheduler</h3><p>assign new objects, such as pods, to nodes, based on current Kubernetes cluster state and new object’s requirements</p>
<p>takes into account: individual and collective resource requirements, hardware/software/policy constraints, affinity and anti-affinity specifications, data locality, inter-workload interference, and deadlines.</p>
<p>highly configurable and customizable, supports additional custom schedulers (specify the name of the custom scheduler in object ‘s configuration data)</p>
<h3 id="Controller-Managers"><a href="#Controller-Managers" class="headerlink" title="Controller Managers"></a>Controller Managers</h3><p>run controllers to regulate the state of the Kubernetes cluster</p>
<p>controllers are watch-loops continuously running and comparing the cluster’s desired state (provided by objects’ configuration data) with its current state (obtained from etcd data store via the API server), includes:</p>
<ul>
<li>Node controller: Responsible for noticing and responding when nodes go down.</li>
<li>Replication controller: Responsible for maintaining the correct number of pods for every replication controller object in the system.</li>
<li>Endpoints controller: Populates the Endpoints object (that is, joins Services &amp; Pods).</li>
<li>Service Account &amp; Token controllers: Create default accounts and API access tokens for new namespaces.</li>
</ul>
<p>corrective action is taken in the cluster until its current state matches the desired state.</p>
<ul>
<li><p>kube-controller-manager: runs controllers responsible to act when nodes become unavailable, to ensure pod counts are as expected, to create endpoints, service accounts, and API access tokens.</p>
</li>
<li><p>cloud-controller-manager: runs controllers responsible to interact with the underlying infrastructure of a cloud provider when nodes become unavailable, to manage storage volumes when provided by a cloud service, and to manage load balancing and routing.</p>
<ul>
<li>Node controller: For checking the cloud provider to determine if a node has been deleted in the cloud after it stops responding</li>
<li>Route controller: For setting up routes in the underlying cloud infrastructure</li>
<li>Service controller: For creating, updating and deleting cloud provider load balancers</li>
</ul>
</li>
</ul>
<h3 id="etcd"><a href="#etcd" class="headerlink" title="etcd"></a><a target="_blank" rel="noopener" href="https://etcd.io/docs/">etcd</a></h3><p>a distributed key-value store which holds cluster state related data, to persist the Kubernetes cluster’s state</p>
<p>either configured on the master node (stacked) or on its dedicated host (external)</p>
<ul>
<li>when stacked: HA master node replicas ensure etcd resiliency.</li>
<li>when external: etcd hosts have to be separately replicated for HA mode configuration.</li>
</ul>
<p>based on <a target="_blank" rel="noopener" href="https://web.stanford.edu/~ouster/cgi-bin/papers/raft-atc14">Raft Consensus Algorithm</a>, written in Golang, besides storing the cluster state, also used to store configuration details such as subnets, ConfigMaps, Secrets, etc.</p>
<h2 id="Worker-Node"><a href="#Worker-Node" class="headerlink" title="Worker Node"></a>Worker Node</h2><p><img src="/photos/k8s-note/worker_node.png" alt="worker_node"></p>
<p>provides a running environment for client applications, which are encapsulated in Pods, controlled by the cluster control plane agents running on the master node</p>
<p>Pods are scheduled on worker nodes, where they find required compute, memory and storage resources to run, and networking to talk to each other and the outside world.</p>
<p>A Pod is the smallest scheduling unit in Kubernetes, a logical collection of one or more containers scheduled together.</p>
<p>to access the applications from the external world, we connect to worker nodes and not to the master node.</p>
<p>4 parts:</p>
<ol>
<li>Container runtime</li>
<li>kubelet</li>
<li>kube-proxy</li>
<li>Addons for DNS, Dashboard, cluster-level monitoring and logging.</li>
</ol>
<h3 id="Container-Runtime"><a href="#Container-Runtime" class="headerlink" title="Container Runtime"></a>Container Runtime</h3><p>responsible for running containers, e.x. Docker, containerd, CRI-O</p>
<h3 id="Kubelet"><a href="#Kubelet" class="headerlink" title="Kubelet"></a>Kubelet</h3><p>an agent running on each node, communicates with the control plane components from the master node, makes sure containers are running in a Pod.</p>
<p>receives Pod definitions, primarily from the API server, and interacts with the container runtime on the node to run containers associated with the Pod.</p>
<p>monitors the health of the Pod’s running container</p>
<p>connects to the container runtime using Container Runtime Interface (CRI). which consists of protocol buffers, gRPC API, and libraries.</p>
<p><img src="/photos/k8s-note/CRI.png" alt="CRI"></p>
<p>CRI implements two services:</p>
<ul>
<li>ImageService: responsible for all the image-related operations</li>
<li>RuntimeService: responsible for all the Pod and container-related operations.</li>
</ul>
<p>some examples of CRI shims:</p>
<ul>
<li>dockershim: with dockershim, containers are created using Docker installed on the worker nodes. Internally, Docker uses containerd to create and manage containers.</li>
</ul>
<p><img src="/photos/k8s-note/dockershim.png" alt="dockershim"></p>
<ul>
<li>cri-containerd: with cri-containerd, we can directly use Docker’s smaller offspring containerd to create and manage containers.</li>
</ul>
<p><img src="/photos/k8s-note/cri-containerd.png" alt="cri-containerd"></p>
<ul>
<li>cri-o: cri-o enables using any Open Container Initiative (OCI) compatible runtimes with Kubernetes. At the time this course was created, CRI-O supported runC and Clear Containers as container runtimes. However, in principle, any OCI-compliant runtime can be plugged-in.</li>
</ul>
<p><img src="/photos/k8s-note/cri-o.png" alt="cri-o"></p>
<h3 id="Kube-proxy"><a href="#Kube-proxy" class="headerlink" title="Kube-proxy"></a>Kube-proxy</h3><p>network agent which runs on each node, responsible for dynamic updates and maintenance of all networking rules on the node, abstracts the details of Pods networking and forwards connection requests to Pods.</p>
<p>implements part of the Kubernetes Service concept.</p>
<p>maintains network rules on nodes. These network rules allow network communication to your Pods from network sessions inside or outside of your cluster.</p>
<p>uses the operating system packet filtering layer if there is one and it’s available. Otherwise, forwards the traffic itself.</p>
<h3 id="Addons"><a href="#Addons" class="headerlink" title="Addons"></a>Addons</h3><p>use Kubernetes resources (DaemonSet, Deployment, etc) to implement cluster features and functionality not yet available in Kubernetes, therefore implemented through 3rd-party pods and services.</p>
<ul>
<li>DNS: cluster DNS is a DNS server for Kubernetes services, required to assign DNS records to Kubernetes objects and resources</li>
<li>Web UI(Dashboard): a general purposed web-based user interface for cluster management</li>
<li>Container Resource Monitoring: records generic time-series metrics about containers in a central database, and provides a UI for browsing that data.</li>
<li>Cluster-level Logging: responsible for saving container logs to a central log store with search/browsing interface.</li>
</ul>
<h2 id="Networking-Challenges"><a href="#Networking-Challenges" class="headerlink" title="Networking Challenges"></a>Networking Challenges</h2><h3 id="Container-to-Container-Communication-Inside-Pods"><a href="#Container-to-Container-Communication-Inside-Pods" class="headerlink" title="Container-to-Container Communication Inside Pods"></a>Container-to-Container Communication Inside Pods</h3><p>When a Pod is started, a network namespace is created inside the Pod, and all containers running inside the Pod will share that network namespace so that they can talk to each other via localhost.</p>
<h3 id="Pod-to-Pod-Communication-Across-Nodes"><a href="#Pod-to-Pod-Communication-Across-Nodes" class="headerlink" title="Pod-to-Pod Communication Across Nodes"></a>Pod-to-Pod Communication Across Nodes</h3><p>Kubernetes network model “IP-per-Pod”</p>
<p>containers are integrated with the overall Kubernetes networking model through the use of the <a target="_blank" rel="noopener" href="https://github.com/containernetworking/cni">Container Network Interface</a> (CNI) supported by <a target="_blank" rel="noopener" href="https://github.com/containernetworking/cni#3rd-party-plugins">CNI plugins</a>.</p>
<h3 id="Pod-to-External-World-Communication"><a href="#Pod-to-External-World-Communication" class="headerlink" title="Pod-to-External World Communication"></a>Pod-to-External World Communication</h3><p>by services, complex constructs which encapsulate networking rules definitions on cluster nodes. By exposing services to the external world with kube-proxy, applications become accessible from outside the cluster over a virtual IP.</p>
<h1 id="Installing-Kubernetes"><a href="#Installing-Kubernetes" class="headerlink" title="Installing Kubernetes"></a>Installing Kubernetes</h1><h2 id="Kubernetes-Configuration"><a href="#Kubernetes-Configuration" class="headerlink" title="Kubernetes Configuration"></a>Kubernetes Configuration</h2><p>four major installation types:</p>
<ul>
<li>All-in-One Single-Node Installation:</li>
</ul>
<p>In this setup, all the master and worker components are installed and running on a single-node. While it is useful for learning, development, and testing, it should not be used in production. Minikube is one such example, and we are going to explore it in future chapters.</p>
<ul>
<li>Single-Node etcd, Single-Master and Multi-Worker Installation:</li>
</ul>
<p>In this setup, we have a single-master node, which also runs a single-node etcd instance. Multiple worker nodes are connected to the master node.</p>
<ul>
<li>Single-Node etcd, Multi-Master and Multi-Worker Installation:</li>
</ul>
<p>In this setup, we have multiple-master nodes configured in HA mode, but we have a single-node etcd instance. Multiple worker nodes are connected to the master nodes.</p>
<ul>
<li>Multi-Node etcd, Multi-Master and Multi-Worker Installation:</li>
</ul>
<p>In this mode, etcd is configured in clustered HA mode, the master nodes are all configured in HA mode, connecting to multiple worker nodes. This is the most advanced and recommended production setup.</p>
<h2 id="Localhost-Installation"><a href="#Localhost-Installation" class="headerlink" title="Localhost Installation"></a>Localhost Installation</h2><p>localhost installation options available to deploy single- or multi-node Kubernetes clusters on our workstation/laptop:</p>
<ul>
<li>Minikube: single-node local Kubernetes cluster</li>
<li>Docker Desktop: single-node local Kubernetes cluster for Windows and Mac</li>
<li>CDK on LXD: multi-node local cluster with LXD containers.</li>
</ul>
<h2 id="On-Premise-Installation"><a href="#On-Premise-Installation" class="headerlink" title="On-Premise Installation"></a>On-Premise Installation</h2><p>Kubernetes can be installed on-premise on VMs and bare metal.</p>
<ul>
<li>On-Premise VMs:</li>
</ul>
<p>Kubernetes can be installed on VMs created via Vagrant, VMware vSphere, KVM, or another Configuration Management (CM) tool in conjunction with a hypervisor software. There are different tools available to automate the installation, such as Ansible or kubeadm.</p>
<ul>
<li>On-Premise Bare Metal:</li>
</ul>
<p>Kubernetes can be installed on on-premise bare metal, on top of different operating systems, like RHEL, CoreOS, CentOS, Fedora, Ubuntu, etc. Most of the tools used to install Kubernetes on VMs can be used with bare metal installations as well.</p>
<h2 id="Cloud-Installation"><a href="#Cloud-Installation" class="headerlink" title="Cloud Installation"></a>Cloud Installation</h2><p>Kubernetes can be installed and managed on almost any cloud environment:</p>
<ul>
<li>Hosted Solutions:</li>
</ul>
<p>With Hosted Solutions, any given software is completely managed by the provider. The user pays hosting and management charges. Some of the vendors providing hosted solutions for Kubernetes are:</p>
<blockquote>
<p>Google Kubernetes Engine (GKE)<br>Azure Kubernetes Service (AKS)<br>Amazon Elastic Container Service for Kubernetes (EKS)<br>DigitalOcean Kubernetes<br>OpenShift Dedicated<br>Platform9<br>IBM Cloud Kubernetes Service.</p>
</blockquote>
<ul>
<li>Turnkey Cloud Solutions:</li>
</ul>
<p>Below are only a few of the Turnkey Cloud Solutions, to install Kubernetes with just a few commands on an underlying IaaS platform, such as:</p>
<blockquote>
<p>Google Compute Engine (GCE)<br>Amazon AWS (AWS EC2)<br>Microsoft Azure (AKS).</p>
</blockquote>
<ul>
<li>Turnkey On-Premise Solutions:</li>
</ul>
<p>The On-Premise Solutions install Kubernetes on secure internal private clouds with just a few commands:</p>
<blockquote>
<p>GKE On-Prem by Google Cloud<br>IBM Cloud Private<br>OpenShift Container Platform by Red Hat.</p>
</blockquote>
<h2 id="Kubernetes-Installation-Tools-Resources"><a href="#Kubernetes-Installation-Tools-Resources" class="headerlink" title="Kubernetes Installation Tools/Resources"></a>Kubernetes Installation Tools/Resources</h2><p>It is worth checking out the <a target="_blank" rel="noopener" href="https://github.com/kelseyhightower/kubernetes-the-hard-way">Kubernetes The Hard Way</a> GitHub project</p>
<p>some useful tools/resources available:</p>
<ul>
<li>kubeadm:</li>
</ul>
<p>kubeadm is a first-class citizen on the Kubernetes ecosystem. It is a secure and recommended way to bootstrap a single- or multi-node Kubernetes cluster. It has a set of building blocks to setup the cluster, but it is easily extendable to add more features. Please note that kubeadm does not support the provisioning of hosts.</p>
<ul>
<li>kubespray</li>
</ul>
<p>With kubespray (formerly known as kargo), we can install Highly Available Kubernetes clusters on AWS, GCE, Azure, OpenStack, or bare metal. Kubespray is based on Ansible, and is available on most Linux distributions. It is a Kubernetes Incubator project.</p>
<ul>
<li>kops</li>
</ul>
<p>With kops, we can create, destroy, upgrade, and maintain production-grade, highly-available Kubernetes clusters from the command line. It can provision the machines as well. Currently, AWS is officially supported. Support for GCE is in beta, and VMware vSphere in alpha stage, and other platforms are planned for the future. Explore the kops project for more details.</p>
<ul>
<li>kube-aws</li>
</ul>
<p>With kube-aws we can create, upgrade and destroy Kubernetes clusters on AWS from the command line. Kube-aws is also a Kubernetes Incubator project.</p>
<h2 id="Minikube"><a href="#Minikube" class="headerlink" title="Minikube"></a>Minikube</h2><p>A Local Single-Node Kubernetes Cluster</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://xyshell.github.io/2020/06/17/k8s-note/" data-id="clywj85g9000st895bjmf94mm" class="article-share-link">
        Share
      </a>
      
<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/k8s/" rel="tag">k8s</a></li></ul>

    </footer>

  </div>

  

  

</article>
    
    <article id="post-DCA-note" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      
  
  <h2 class="article-title" itemprop="name">
    <a href="/2020/06/11/DCA-note/">DCA Note</a>
  </h2>
  
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/06/11/DCA-note/" class="article-date">
  <time datetime="2020-06-11T21:38:24.000Z" itemprop="datePublished">2020-06-11</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
        <h1 id="Docker-Certified-Associate-Exam-Preparation-Guide-v1-3"><a href="#Docker-Certified-Associate-Exam-Preparation-Guide-v1-3" class="headerlink" title="Docker Certified Associate Exam Preparation Guide (v1.3)"></a>Docker Certified Associate Exam Preparation Guide (v1.3)</h1><h2 id="Domain-1-Orchestration-25-of-exam"><a href="#Domain-1-Orchestration-25-of-exam" class="headerlink" title="Domain 1: Orchestration (25% of exam)"></a>Domain 1: Orchestration (25% of exam)</h2><h3 id="Complete-the-setup-of-a-swarm-mode-cluster-with-managers-and-worker-nodes"><a href="#Complete-the-setup-of-a-swarm-mode-cluster-with-managers-and-worker-nodes" class="headerlink" title="Complete the setup of a swarm mode cluster, with managers and worker nodes"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/swarm/swarm-tutorial/create-swarm/">Complete the setup of a swarm mode cluster, with managers and worker nodes</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker swarm init</span><br><span class="line">$ docker swarm join-token manager / $ docker swarm join-token worker</span><br><span class="line">$ docker swarm <span class="built_in">join</span> --token &lt;token&gt; &lt;ip&gt;:&lt;port&gt;</span><br></pre></td></tr></table></figure>
<h3 id="Describe-and-demonstrate-how-to-extend-the-instructions-to-run-individual-containers-into-running-services-under-swarm"><a href="#Describe-and-demonstrate-how-to-extend-the-instructions-to-run-individual-containers-into-running-services-under-swarm" class="headerlink" title="Describe and demonstrate how to extend the instructions to run individual containers into running services under swarm"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/swarm/swarm-tutorial/deploy-service/">Describe and demonstrate how to extend the instructions to run individual containers into running services under swarm</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker service create --replicas 1 --name &lt;service&gt; &lt;image&gt; &lt;cmd&gt;</span><br><span class="line">$ docker service <span class="built_in">ls</span></span><br></pre></td></tr></table></figure>
<h3 id="Describe-the-importance-of-quorum-in-a-swarm-cluster"><a href="#Describe-the-importance-of-quorum-in-a-swarm-cluster" class="headerlink" title="Describe the importance of quorum in a swarm cluster."></a><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/swarm/raft/">Describe the importance of quorum in a swarm cluster.</a></h3><ul>
<li><a target="_blank" rel="noopener" href="http://thesecretlivesofdata.com/raft/">Raft Consensus Algorithm</a> to make sure all the manager nodes in charge of managing and scheduling tasks in the cluster, are storing the same consistent state.</li>
<li>Having the same consistent state across the cluster means that in case of a failure, any Manager node can pick up the tasks and restore the services to a stable state.</li>
<li>Raft tolerates up to (N-1)/2 failures and requires a majority or quorum of (N/2)+1 members to agree on values proposed to the cluster.</li>
</ul>
<h3 id="Describe-the-difference-between-running-a-container-and-running-a-service"><a href="#Describe-the-difference-between-running-a-container-and-running-a-service" class="headerlink" title="Describe the difference between running a container and running a service."></a><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/swarm/how-swarm-mode-works/services/#services-tasks-and-containers">Describe the difference between running a container and running a service.</a></h3><p>Service -&gt; tasks - containers</p>
<h3 id="Interpret-the-output-of-“docker-inspect”-commands"><a href="#Interpret-the-output-of-“docker-inspect”-commands" class="headerlink" title="Interpret the output of “docker inspect” commands"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/swarm/swarm-tutorial/inspect-service/">Interpret the output of “docker inspect” commands</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker service|container|network|... inpsect --pretty &lt;name&gt;</span><br></pre></td></tr></table></figure>
<h3 id="Convert-an-application-deployment-into-a-stack-file-using-a-YAML-compose-file-with-“docker-stack-deploy”"><a href="#Convert-an-application-deployment-into-a-stack-file-using-a-YAML-compose-file-with-“docker-stack-deploy”" class="headerlink" title="Convert an application deployment into a stack file using a YAML compose file with “docker stack deploy”"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/swarm/stack-deploy/">Convert an application deployment into a stack file using a YAML compose file with “docker stack deploy”</a></h3><p>stack file is a YAML defining services, networks and volumes.</p>
<h3 id="Manipulate-a-running-stack-of-services"><a href="#Manipulate-a-running-stack-of-services" class="headerlink" title="Manipulate a running stack of services"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/stack_services/#related-commands">Manipulate a running stack of services</a></h3><p><code>docker service scale</code>; <code>docker service update</code>; update config file, re-deploy by: <code>docker stack deploy -c &lt;stackfile&gt; &lt;stack&gt;</code></p>
<h3 id="Describe-and-demonstrate-orchestration-activities"><a href="#Describe-and-demonstrate-orchestration-activities" class="headerlink" title="Describe and demonstrate orchestration activities"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/get-started/orchestration/">Describe and demonstrate orchestration activities</a></h3><p>Tools to manage, scale, and maintain containerized applications are called orchestrators (e.x. Kubernetes and Docker Swarm)</p>
<h3 id="Increase-number-of-replicas"><a href="#Increase-number-of-replicas" class="headerlink" title="Increase number of replicas"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/service_scale/">Increase number of replicas</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker service scale &lt;service&gt;=20</span><br></pre></td></tr></table></figure>
<h3 id="Add-networks-publish-ports"><a href="#Add-networks-publish-ports" class="headerlink" title="Add networks, publish ports"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/network/">Add networks, publish ports</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker network create -d &lt;driver&gt; &lt;network&gt;</span><br><span class="line">$ docker container create --network &lt;network&gt; -p 8080:8080 &lt;container&gt;</span><br></pre></td></tr></table></figure>
<h3 id="Mount-volumes"><a href="#Mount-volumes" class="headerlink" title="Mount volumes"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/storage/volumes/">Mount volumes</a></h3><p>to attach volume to a container, either by —mount or -v:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d --name &lt;container&gt; --mount <span class="built_in">source</span>=&lt;volume&gt;,target=/vol &lt;image&gt;</span><br><span class="line">$ docker run -d --name &lt;container&gt; -v &lt;volume&gt;:/vol &lt;image&gt;</span><br></pre></td></tr></table></figure>
<h3 id="Describe-and-demonstrate-how-to-run-replicated-and-global-services"><a href="#Describe-and-demonstrate-how-to-run-replicated-and-global-services" class="headerlink" title="Describe and demonstrate how to run replicated and global services"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/swarm/how-swarm-mode-works/services/#replicated-and-global-services">Describe and demonstrate how to run replicated and global services</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker service create --replicas 5 &lt;service&gt; <span class="comment"># default replicated mode</span></span><br><span class="line">$ docker service create --mode global &lt;service&gt; <span class="comment"># global mode</span></span><br></pre></td></tr></table></figure>
<h3 id="Apply-node-labels-to-demonstrate-placement-of-tasks"><a href="#Apply-node-labels-to-demonstrate-placement-of-tasks" class="headerlink" title="Apply node labels to demonstrate placement of tasks"></a><a target="_blank" rel="noopener" href="https://success.docker.com/article/using-contraints-and-labels-to-control-the-placement-of-containers">Apply node labels to demonstrate placement of tasks</a></h3><h3 id="Describe-and-demonstrate-how-to-use-templates-with-“docker-service-create”"><a href="#Describe-and-demonstrate-how-to-use-templates-with-“docker-service-create”" class="headerlink" title="Describe and demonstrate how to use templates with “docker service create”"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/service_create/#create-services-using-templates">Describe and demonstrate how to use templates with “docker service create”</a></h3><p>only <code>--hostname</code>,<code>--mount</code>,<code>--env</code> support templates, e.x.:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ docker service create \</span><br><span class="line">    --name hosttempl \</span><br><span class="line">    --hostname=<span class="string">&quot;&#123;&#123;.Node.Hostname&#125;&#125;-&#123;&#123;.Node.ID&#125;&#125;-&#123;&#123;.Service.Name&#125;&#125;&quot;</span> \ <span class="comment"># default container ID</span></span><br><span class="line">    busybox top</span><br></pre></td></tr></table></figure>
<h3 id="Identify-the-steps-needed-to-troubleshoot-a-service-not-deploying"><a href="#Identify-the-steps-needed-to-troubleshoot-a-service-not-deploying" class="headerlink" title="Identify the steps needed to troubleshoot a service not deploying"></a><a target="_blank" rel="noopener" href="https://success.docker.com/article/swarm-troubleshooting-methodology">Identify the steps needed to troubleshoot a service not deploying</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ docker service <span class="built_in">ls</span></span><br><span class="line">$ docker service ps &lt;service&gt;</span><br><span class="line">$ docker service inspect &lt;service&gt;</span><br><span class="line">$ docker inspect &lt;task&gt;</span><br><span class="line">$ docker inspect &lt;container&gt;</span><br><span class="line">$ docker logs &lt;container&gt;</span><br></pre></td></tr></table></figure>
<h3 id="Describe-how-a-Dockerized-application-communicates-with-legacy-systems"><a href="#Describe-how-a-Dockerized-application-communicates-with-legacy-systems" class="headerlink" title="Describe how a Dockerized application communicates with legacy systems"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/config/containers/container-networking/">Describe how a Dockerized application communicates with legacy systems</a></h3><p>use a bridge, an overlay, a macvlan network, or a custom network plugin.</p>
<h3 id="Describe-how-to-deploy-containerized-workloads-as-Kubernetes-pods-and-deployments"><a href="#Describe-how-to-deploy-containerized-workloads-as-Kubernetes-pods-and-deployments" class="headerlink" title="Describe how to deploy containerized workloads as Kubernetes pods and deployments"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/get-started/kube-deploy/">Describe how to deploy containerized workloads as Kubernetes pods and deployments</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f bb.yaml</span><br><span class="line">$ kubectl get pods</span><br><span class="line">$ kubectl get deploy</span><br><span class="line">$ kubectl edit deploy/mysite <span class="comment"># edit existing objects, automatic update</span></span><br><span class="line">$ kubectl scale --replicas=2 deploy/mysite <span class="comment"># rescale</span></span><br><span class="line">$ kubectl delete -f bb.yaml / kubectl delete deploy mysite</span><br></pre></td></tr></table></figure>
<h3 id="Describe-how-to-provide-configuration-to-Kubernetes-pods-using-configMaps-and-secrets"><a href="#Describe-how-to-provide-configuration-to-Kubernetes-pods-using-configMaps-and-secrets" class="headerlink" title="Describe how to provide configuration to Kubernetes pods using configMaps and secrets"></a><a target="_blank" rel="noopener" href="https://opensource.com/article/19/6/introduction-kubernetes-secrets-and-configmaps">Describe how to provide configuration to Kubernetes pods using configMaps and secrets</a></h3><ol>
<li>Secret:</li>
</ol>
<p>create the YAML file for the Secret, save as mysql-secret.yaml:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mariadb-root-password</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">S3ViZXJuZXRlc1JvY2tzIQ==</span></span><br></pre></td></tr></table></figure>
<p>create the Secret in Kubernetes:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f mysql-secret.yaml</span><br></pre></td></tr></table></figure>
<p>view the newly created Secret:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl describe secret mariadb-root-password</span><br></pre></td></tr></table></figure>
<p>view and edit the Secret:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl edit secret &lt;secretname&gt;</span><br></pre></td></tr></table></figure>
<p>could also create the secret by:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create secret generic mariadb-user-creds \</span><br><span class="line">      --from-literal=MYSQL_USER=kubeuser\</span><br><span class="line">      --from-literal=MYSQL_PASSWORD=kube-still-rocks</span><br></pre></td></tr></table></figure>
<p>validate secrets were created and stored correctly:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Get the username</span></span><br><span class="line">$ kubectl get secret mariadb-user-creds -o jsonpath=<span class="string">&#x27;&#123;.data.MYSQL_USER&#125;&#x27;</span> | <span class="built_in">base64</span> --decode -</span><br><span class="line">kubeuser</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get the password</span></span><br><span class="line">$ kubectl get secret mariadb-user-creds -o jsonpath=<span class="string">&#x27;&#123;.data.MYSQL_PASSWORD&#125;&#x27;</span> | <span class="built_in">base64</span> --decode -</span><br><span class="line">kube-still-rocks</span><br></pre></td></tr></table></figure>
<ol>
<li>ConfigMap</li>
</ol>
<p>create a file named max_allowed_packet.cnf:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">max_allowed_packet = 64M</span><br></pre></td></tr></table></figure>
<p>create configmap by:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create configmap mariadb-config --from-file=max_allowed_packet.cnf <span class="comment"># could add multiple --from-file=&lt;filename&gt;</span></span><br><span class="line">$ kubectl create configmap mariadb-config --from-file=max-packet=max_allowed_packet.cnf <span class="comment"># set max-packet as key rather than the file name</span></span><br><span class="line">configmap/mariadb-config created</span><br></pre></td></tr></table></figure>
<p>Firstvalidate that the ConfigMap was created:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get configmap mariadb-config</span><br></pre></td></tr></table></figure>
<p>viewed with the kubectl describe command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl describe cm mariadb-config</span><br></pre></td></tr></table></figure>
<p>edit configmap mariadb-config’s value:(in development)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl edit configmap mariadb-config</span><br></pre></td></tr></table></figure>
<ol>
<li>Using Secrets and ConfigMaps</li>
</ol>
<p>Create a file named mariadb-deployment.yaml:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mariadb</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mariadb-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">mariadb</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">mariadb</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mariadb</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">docker.io/mariadb:10.4</span></span><br><span class="line">        <span class="comment">#   env:</span></span><br><span class="line">        <span class="comment">#     - name: MYSQL_ROOT_PASSWORD</span></span><br><span class="line">        <span class="comment">#     valueFrom:</span></span><br><span class="line">        <span class="comment">#         secretKeyRef:</span></span><br><span class="line">        <span class="comment">#             name: mariadb-root-password</span></span><br><span class="line">        <span class="comment">#             key: password</span></span><br><span class="line">        <span class="comment">#   envFrom:</span></span><br><span class="line">        <span class="comment">#   - secretRef:</span></span><br><span class="line">        <span class="comment">#     name: mariadb-user-creds</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3306</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/lib/mysql</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">mariadb-volume-1</span></span><br><span class="line">            <span class="comment"># - mountPath: /etc/mysql/conf.d</span></span><br><span class="line">            <span class="comment">#   name: mariadb-config-volume</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">          <span class="attr">name:</span> <span class="string">mariadb-volume-1</span></span><br><span class="line">        <span class="comment"># - configMap:</span></span><br><span class="line">        <span class="comment">#   name: mariadb-config</span></span><br><span class="line">        <span class="comment">#   items:</span></span><br><span class="line">        <span class="comment">#     - key: max_allowed_packet.cnf</span></span><br><span class="line">        <span class="comment">#       path: max_allowed_packet.cnf</span></span><br><span class="line">        <span class="comment">#   name: mariadb-config-volume</span></span><br></pre></td></tr></table></figure>
<p>add the Secrets to the Deployment as environment variables, same for ConfigMaps by using configMapRef instead of secretKeyRef:<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">env:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">    <span class="attr">valueFrom:</span></span><br><span class="line">      <span class="attr">secretKeyRef:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">mariadb-root-password</span></span><br><span class="line">        <span class="attr">key:</span> <span class="string">password</span></span><br></pre></td></tr></table></figure></p>
<p>or using envFrom:<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">envFrom:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">secretRef:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">mariadb-user-creds</span></span><br></pre></td></tr></table></figure></p>
<p>create a new MariaDB instance from the YAML file:<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">create</span> <span class="string">-f</span> <span class="string">mariadb-deployment.yaml</span></span><br><span class="line"><span class="string">deployment.apps/mariadb-deployment</span> <span class="string">created</span></span><br></pre></td></tr></table></figure></p>
<p>view the running MariaDB pod:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods</span><br></pre></td></tr></table></figure></p>
<p>kubectl exec to the Pod, validate Secrets and ConfigMaps are in use:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> -it mariadb-deployment-5465c6655c-7jfqm <span class="built_in">env</span> |grep MYSQL</span><br><span class="line">MYSQL_PASSWORD=kube-still-rocks</span><br><span class="line">MYSQL_USER=kubeuser</span><br><span class="line">MYSQL_ROOT_PASSWORD=KubernetesRocks!</span><br></pre></td></tr></table></figure>
<p>check max_allowed_packet.cnf file was created in /etc/mysql/conf.d:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> -it mariadb-deployment-5465c6655c-7jfqm <span class="built_in">ls</span> /etc/mysql/conf.d</span><br><span class="line">max_allowed_packet.cnf</span><br><span class="line"></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it mariadb-deployment-5465c6655c-7jfqm <span class="built_in">cat</span> /etc/mysql/conf.d/max_allowed_packet.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">max_allowed_packet = 32M</span><br></pre></td></tr></table></figure></p>
<h2 id="Domain-2-Image-Creation-Management-and-Registry-20-of-exam"><a href="#Domain-2-Image-Creation-Management-and-Registry-20-of-exam" class="headerlink" title="Domain 2: Image Creation, Management, and Registry (20% of exam)"></a>Domain 2: Image Creation, Management, and Registry (20% of exam)</h2><h3 id="Describe-the-use-of-Dockerfile"><a href="#Describe-the-use-of-Dockerfile" class="headerlink" title="Describe the use of Dockerfile"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/builder/">Describe the use of Dockerfile</a></h3><h3 id="Describe-options-such-as-add-copy-volumes-expose-entry-point"><a href="#Describe-options-such-as-add-copy-volumes-expose-entry-point" class="headerlink" title="Describe options, such as add, copy, volumes, expose, entry point"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/builder/#from">Describe options, such as add, copy, volumes, expose, entry point</a></h3><h3 id="Identify-and-display-the-main-parts-of-a-Dockerfile"><a href="#Identify-and-display-the-main-parts-of-a-Dockerfile" class="headerlink" title="Identify and display the main parts of a Dockerfile"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/builder/#dockerfile-examples">Identify and display the main parts of a Dockerfile</a></h3><h3 id="Describe-and-demonstrate-how-to-create-an-efficient-image-via-a-Dockerfile"><a href="#Describe-and-demonstrate-how-to-create-an-efficient-image-via-a-Dockerfile" class="headerlink" title="Describe and demonstrate how to create an efficient image via a Dockerfile"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/">Describe and demonstrate how to create an efficient image via a Dockerfile</a></h3><h3 id="Describe-and-demonstrate-how-to-use-CLI-commands-to-manage-images-such-as-list-delete-prune-rmi"><a href="#Describe-and-demonstrate-how-to-use-CLI-commands-to-manage-images-such-as-list-delete-prune-rmi" class="headerlink" title="Describe and demonstrate how to use CLI commands to manage images, such as list, delete, prune, rmi"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/image/#usage">Describe and demonstrate how to use CLI commands to manage images, such as list, delete, prune, rmi</a></h3><h3 id="Describe-and-demonstrate-how-to-inspect-images-and-report-specific-attributes-using-filter-and-format"><a href="#Describe-and-demonstrate-how-to-inspect-images-and-report-specific-attributes-using-filter-and-format" class="headerlink" title="Describe and demonstrate how to inspect images and report specific attributes using filter and format"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/images/#filtering">Describe and demonstrate how to inspect images and report specific attributes using filter and format</a></h3><p>filter:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ docker images --filter <span class="string">&quot;dangling=true&quot;</span></span><br><span class="line">$ docker images --filter <span class="string">&quot;label=com.example.version&quot;</span></span><br><span class="line">$ docker images --filter <span class="string">&quot;label=com.example.version=1.0&quot;</span></span><br><span class="line">$ docker images --filter <span class="string">&quot;before=image1&quot;</span></span><br><span class="line">$ docker images --filter <span class="string">&quot;since=image3&quot;</span></span><br><span class="line">$ docker images --filter=reference=<span class="string">&#x27;busy*:*libc&#x27;</span></span><br><span class="line">$ docker images --filter=reference=<span class="string">&#x27;busy*:uclibc&#x27;</span> --filter=reference=<span class="string">&#x27;busy*:glibc&#x27;</span></span><br></pre></td></tr></table></figure></p>
<p>format:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker images --format <span class="string">&quot;&#123;&#123;.ID&#125;&#125;: &#123;&#123;.Repository&#125;&#125;&quot;</span></span><br><span class="line">$ docker images --format <span class="string">&quot;table &#123;&#123;.ID&#125;&#125;\t&#123;&#123;.Repository&#125;&#125;\t&#123;&#123;.Tag&#125;&#125;&quot;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="Describe-and-demonstrate-how-to-tag-an-image"><a href="#Describe-and-demonstrate-how-to-tag-an-image" class="headerlink" title="Describe and demonstrate how to tag an image."></a><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/tag/">Describe and demonstrate how to tag an image.</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker tag &lt;image-name/image-id&gt; fedora/httpd:version1.0 </span><br></pre></td></tr></table></figure>
<h3 id="Describe-and-demonstrate-how-to-apply-a-file-to-create-a-Docker-image"><a href="#Describe-and-demonstrate-how-to-apply-a-file-to-create-a-Docker-image" class="headerlink" title="Describe and demonstrate how to apply a file to create a Docker image"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/image_load/">Describe and demonstrate how to apply a file to create a Docker image</a></h3><h3 id="Describe-and-demonstrate-how-to-display-layers-of-a-Docker-image"><a href="#Describe-and-demonstrate-how-to-display-layers-of-a-Docker-image" class="headerlink" title="Describe and demonstrate how to display layers of a Docker image"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/image_inspect/">Describe and demonstrate how to display layers of a Docker image</a></h3><h3 id="Describe-and-demonstrate-how-to-modify-an-image-to-a-single-layer"><a href="#Describe-and-demonstrate-how-to-modify-an-image-to-a-single-layer" class="headerlink" title="Describe and demonstrate how to modify an image to a single layer"></a><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/39695031/how-make-docker-layer-to-single-layer">Describe and demonstrate how to modify an image to a single layer</a></h3><h3 id="Describe-and-demonstrate-registry-functions"><a href="#Describe-and-demonstrate-registry-functions" class="headerlink" title="Describe and demonstrate registry functions"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/registry/">Describe and demonstrate registry functions</a></h3><h3 id="Deploy-a-registry"><a href="#Deploy-a-registry" class="headerlink" title="Deploy a registry"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/registry/deploying/">Deploy a registry</a></h3><p>deploy by:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d \ </span><br><span class="line">  -e REGISTRY_HTTP_ADDR=0.0.0.0:5001 \ </span><br><span class="line">  -p 5001:5001 \ </span><br><span class="line">  --restart=always \ </span><br><span class="line">  --name registry \ </span><br><span class="line">  -v /mnt/registry:/var/lib/registry \ </span><br><span class="line">  registry:2</span><br></pre></td></tr></table></figure></p>
<p>stop and remove by:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker container stop registry &amp;&amp; docker container <span class="built_in">rm</span> -v registry</span><br></pre></td></tr></table></figure></p>
<h3 id="Log-into-a-registry"><a href="#Log-into-a-registry" class="headerlink" title="Log into a registry"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/login/">Log into a registry</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker login localhost:8080</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> ~/my_password.txt | docker login --username foo --password-stdin</span><br></pre></td></tr></table></figure>
<h3 id="Utilize-search-in-a-registry"><a href="#Utilize-search-in-a-registry" class="headerlink" title="Utilize search in a registry"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/search/">Utilize search in a registry</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ docker search busybox</span><br><span class="line">$ docker search --filter is-official=<span class="literal">true</span> --filter stars=3 busybox</span><br><span class="line">$ docker search --format <span class="string">&quot;&#123;&#123;.Name&#125;&#125;: &#123;&#123;.StarCount&#125;&#125;&quot;</span> nginx</span><br><span class="line">$ docker search --format <span class="string">&quot;table &#123;&#123;.Name&#125;&#125;\t&#123;&#123;.IsAutomated&#125;&#125;\t&#123;&#123;.IsOfficial&#125;&#125;&quot;</span> nginx</span><br></pre></td></tr></table></figure>
<h3 id="Push-an-image-to-a-registry"><a href="#Push-an-image-to-a-registry" class="headerlink" title="Push an image to a registry"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/push/">Push an image to a registry</a></h3><p>commit a container to image:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker commit c16378f943fe rhel-httpd</span><br></pre></td></tr></table></figure></p>
<p>tag and push:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker tag rhel-httpd registry-host:5000/myadmin/rhel-httpd</span><br><span class="line">$ docker push registry-host:5000/myadmin/rhel-httpd</span><br></pre></td></tr></table></figure></p>
<h3 id="Sign-an-image-in-a-registry"><a href="#Sign-an-image-in-a-registry" class="headerlink" title="Sign an image in a registry"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/trust_sign/">Sign an image in a registry</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker trust sign example/trust-demo:v2</span><br><span class="line">$ docker trust inspect --pretty example/trust-demo</span><br></pre></td></tr></table></figure>
<h3 id="Pull-and-delete-images-from-a-registry"><a href="#Pull-and-delete-images-from-a-registry" class="headerlink" title="Pull and delete images from a registry"></a><a href="ttps://docs.docker.com/engine/reference/commandline/pull/">Pull</a> and <a target="_blank" rel="noopener" href="https://docs.docker.com/registry/spec/api/#deleting-an-image">delete</a> images from a registry</h3><p>An image may be deleted from the registry via its “name” and “reference”:<br><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE /v2/&lt;name&gt;/manifests/&lt;reference&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="Domain-3-Installation-and-Configuration-15-of-exam"><a href="#Domain-3-Installation-and-Configuration-15-of-exam" class="headerlink" title="Domain 3: Installation and Configuration (15% of exam)"></a>Domain 3: Installation and Configuration (15% of exam)</h2><h3 id="Describe-sizing-requirements-for-installation"><a href="#Describe-sizing-requirements-for-installation" class="headerlink" title="Describe sizing requirements for installation"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/datacenter/ucp/2.2/guides/admin/install/system-requirements/#hardware-and-software-requirements">Describe sizing requirements for installation</a></h3><p>the following minimum requirements for Docker UCP 2.2.4 on Linux:<br>• UCP Manager nodes running DTR: 8GB of RAM with 3GB of disk space<br>• UCP Worker nodes: 4GB of RAM with 3GB of free disk space<br>Recommended requirements are:<br>• UCP Manager nodes running DTR: 8GB RAM, 4 vCPUs, and 100GB disk space<br>• UCP Worker nodes: 4GB RAM 25-100GB of free disk space</p>
<h3 id="Describe-and-demonstrate-the-setup-of-repo-selection-of-a-storage-driver-and-installation-of-the-Docker-engine-on-multiple-platforms"><a href="#Describe-and-demonstrate-the-setup-of-repo-selection-of-a-storage-driver-and-installation-of-the-Docker-engine-on-multiple-platforms" class="headerlink" title="Describe and demonstrate the setup of repo, selection of a storage driver, and installation of the Docker engine on multiple platforms"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/install/">Describe and demonstrate the setup of repo, selection of a storage driver, and installation of the Docker engine on multiple platforms</a></h3><h3 id="Describe-and-demonstrate-configuration-of-logging-drivers-splunk-journald-etc"><a href="#Describe-and-demonstrate-configuration-of-logging-drivers-splunk-journald-etc" class="headerlink" title="Describe and demonstrate configuration of logging drivers (splunk, journald, etc.)"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/config/containers/logging/configure/">Describe and demonstrate configuration of logging drivers (splunk, journald, etc.)</a></h3><h3 id="Describe-and-demonstrate-how-to-set-up-swarm-configure-managers-add-nodes-and-setup-the-backup-schedule"><a href="#Describe-and-demonstrate-how-to-set-up-swarm-configure-managers-add-nodes-and-setup-the-backup-schedule" class="headerlink" title="Describe and demonstrate how to set up swarm, configure managers, add nodes, and setup the backup schedule"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/swarm/admin_guide/">Describe and demonstrate how to set up swarm, configure managers, add nodes, and setup the backup schedule</a></h3><p>A Swarm backup is a copy of all the files in directory <code>/var/lib/docker/swarm</code>:</p>
<ol>
<li>Stop Docker on the Swarm manager node you are performing the backup from(not a good idea to perform the backup on the leader manager). This will stop all UCP containers on the node. If UCP is configured for HA, the other managers will make sure the control plane remains available.</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ service docker stop</span><br></pre></td></tr></table></figure>
<ol>
<li>Backup the Swarm config, e.x.:</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ tar -czvf swarm.bkp /var/lib/docker/swarm/</span><br><span class="line">tar: Removing leading `/<span class="string">&#x27; from member names</span></span><br><span class="line"><span class="string">/var/lib/docker/swarm/</span></span><br><span class="line"><span class="string">/var/lib/docker/swarm/docker-state.json</span></span><br><span class="line"><span class="string">/var/lib/docker/swarm/state.json</span></span><br><span class="line"><span class="string">&lt;Snip&gt;</span></span><br></pre></td></tr></table></figure>
<ol>
<li>Verify that the backup file exists. rotate, and store the backup file off-site according to your corporate backup policies.</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">ls</span> -l</span><br><span class="line">-rw-r--r-- 1 root root 450727 Jan 29 14:06 swarm.bkp</span><br></pre></td></tr></table></figure>
<ol>
<li>Restart Docker.</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ service docker restart</span><br></pre></td></tr></table></figure>
<p>recover Swarm from a backup:</p>
<ol>
<li><p>stop docker:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ service docker stop</span><br></pre></td></tr></table></figure>
</li>
<li><p>Delete any existing Swarm configuration:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">rm</span> -r /var/lib/docker/swarm</span><br></pre></td></tr></table></figure>
</li>
<li><p>Restore the Swarm configuration from backup:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tar -zxvf swarm.bkp -C /</span><br></pre></td></tr></table></figure>
</li>
<li><p>Initialize a new Swarm cluster:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker swarm init --force-new-cluster</span><br><span class="line">Swarm initialized: current node (jhsg...3l9h) is now a manager.</span><br></pre></td></tr></table></figure>
</li>
<li><p>check by:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker network <span class="built_in">ls</span></span><br><span class="line">$ docker service <span class="built_in">ls</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Add new manager and worker nodes to the Swarm, and take a fresh backup.</p>
</li>
</ol>
<h3 id="Describe-and-demonstrate-how-to-create-and-manage-user-and-teams"><a href="#Describe-and-demonstrate-how-to-create-and-manage-user-and-teams" class="headerlink" title="Describe and demonstrate how to create and manage user and teams"></a><a target="_blank" rel="noopener" href="https://success.docker.com/article/rbac-example-overview">Describe and demonstrate how to create and manage user and teams</a></h3><p>RBAC via grant:</p>
<ul>
<li>Subject</li>
<li>Role</li>
<li>Collection</li>
</ul>
<h3 id="Describe-and-demonstrate-how-to-configure-the-Docker-daemon-to-start-on-boot"><a href="#Describe-and-demonstrate-how-to-configure-the-Docker-daemon-to-start-on-boot" class="headerlink" title="Describe and demonstrate how to configure the Docker daemon to start on boot"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/install/linux-postinstall/#configure-docker-to-start-on-boot">Describe and demonstrate how to configure the Docker daemon to start on boot</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> docker</span><br></pre></td></tr></table></figure>
<p>To disable this behavior, use disable instead:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> systemctl <span class="built_in">disable</span> docker</span><br></pre></td></tr></table></figure></p>
<h3 id="Describe-and-demonstrate-how-to-use-certificate-based-client-server-authentication-to-ensure-a-Docker-daemon-has-the-rights-to-access-images-on-a-registry"><a href="#Describe-and-demonstrate-how-to-use-certificate-based-client-server-authentication-to-ensure-a-Docker-daemon-has-the-rights-to-access-images-on-a-registry" class="headerlink" title="Describe and demonstrate how to use certificate-based client-server authentication to ensure a Docker daemon has the rights to access images on a registry"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/security/certificates/">Describe and demonstrate how to use certificate-based client-server authentication to ensure a Docker daemon has the rights to access images on a registry</a></h3><h3 id="Describe-the-use-of-namespaces-cgroups-and-certificate-configuration"><a href="#Describe-the-use-of-namespaces-cgroups-and-certificate-configuration" class="headerlink" title="Describe the use of namespaces, cgroups, and certificate configuration"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/get-started/overview/#the-underlying-technology">Describe the use of namespaces, cgroups, and certificate configuration</a></h3><h3 id="Describe-and-interpret-errors-to-troubleshoot-installation-issues-without-assistance"><a href="#Describe-and-interpret-errors-to-troubleshoot-installation-issues-without-assistance" class="headerlink" title="Describe and interpret errors to troubleshoot installation issues without assistance"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/config/daemon/#troubleshoot-the-daemon">Describe and interpret errors to troubleshoot installation issues without assistance</a></h3><h3 id="Describe-and-demonstrate-the-steps-to-deploy-the-Docker-engine-UCP-and-DTR-on-AWS-and-on-premises-in-an-HA-configuration-Docker-DTR-UCP-Docker-on-AWS-and-possibly-on-premises-HA-config"><a href="#Describe-and-demonstrate-the-steps-to-deploy-the-Docker-engine-UCP-and-DTR-on-AWS-and-on-premises-in-an-HA-configuration-Docker-DTR-UCP-Docker-on-AWS-and-possibly-on-premises-HA-config" class="headerlink" title="Describe and demonstrate the steps to deploy the Docker engine, UCP, and DTR on AWS and on-premises in an HA configuration. Docker, DTR, UCP,, Docker on AWS and possibly on premises HA config"></a>Describe and demonstrate the steps to deploy the Docker engine, UCP, and DTR on AWS and on-premises in an HA configuration. <a target="_blank" rel="noopener" href="https://docs.docker.com/install/linux/docker-ce/ubuntu/">Docker,</a> <a target="_blank" rel="noopener" href="https://docs.docker.com/datacenter/dtr/2.3/guides/admin/install/">DTR,</a> <a target="_blank" rel="noopener" href="https://docs.docker.com/ee/ucp/">UCP,</a>, <a target="_blank" rel="noopener" href="https://docs.docker.com/docker-for-aws/">Docker on AWS</a> and possibly <a target="_blank" rel="noopener" href="https://docs.docker.com/engine/swarm/admin_guide/#add-manager-nodes-for-fault-tolerance">on premises HA config</a></h3><ol>
<li>DTR:</li>
</ol>
<p>If possible, you should run your DTR instances on dedicated nodes. You definitely<br>shouldn’t run user workloads on your production DTR nodes.</p>
<p>As with UCP, you should run an odd number of DTR instances. 3 or 5 is best for fault<br>tolerance. A recommended configuration for a production environment might be:</p>
<ul>
<li>3 dedicated UCP managers</li>
<li>3 dedicated DTR instances</li>
<li>However many worker nodes your application requirements demand</li>
</ul>
<p>Install DTR:</p>
<ol>
<li>Log on to the UCP web UI and click Admin &gt; Admin Settings &gt; Docker<br>Trusted Registry.</li>
<li>Fill out the DTR configuration form.</li>
</ol>
<ul>
<li>DTR EXTERNAL URL: Set this to the URL of your external load balancer.</li>
<li>UCP NODE: Select the name of the node you wish to install DTR on.</li>
<li>Disable TLS Verification For UCP: Check this box if you’re using<br>self-signed certificates.</li>
</ul>
<ol>
<li>Copy the long command at the bottom of the form.</li>
<li>Paste the command into any UCP manager node.<br>The command includes the —ucp-node flag telling UCP which node to<br>perform the install on.<br>The following is an example DTR install command that matches the configuration<br>in Figure 16.10. It assumes that you already have a load balancer<br>configured at dtr.mydns.com<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -it --<span class="built_in">rm</span> docker/dtr install \</span><br><span class="line">--dtr-external-url dtr.mydns.com \</span><br><span class="line">--ucp-node dtr1 \</span><br><span class="line">--ucp-url https://34.252.195.122 \</span><br><span class="line">--ucp-username admin --ucp-insecure-tls</span><br></pre></td></tr></table></figure></li>
<li>Once the installation is complete, point your web browser to your load<br>balancer. You will be automatically logged in to DTR.</li>
</ol>
<p>Configure DTR for high availability:</p>
<ol>
<li>Log on to the DTR console and navigate to Settings.</li>
<li>Select the Storage tab and configure the shared storage backend.</li>
</ol>
<p>DTR is now configured with a shared storage backend and ready to have additional<br>replicas.</p>
<ol>
<li>Run the following command from a manager node in the UCP cluster.<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -it --<span class="built_in">rm</span> \</span><br><span class="line">docker/dtr:2.4.1 <span class="built_in">join</span> \</span><br><span class="line">--ucp-node dtr2 \</span><br><span class="line">--existing-replica-id 47f20fb864cf \</span><br><span class="line">--ucp-insecure-tls</span><br></pre></td></tr></table></figure></li>
<li>Enter the UCP URL and port, as well as admin credentials when prompted.</li>
</ol>
<h3 id="Describe-and-demonstrate-how-to-configure-backups-for-UCP-and-DTR"><a href="#Describe-and-demonstrate-how-to-configure-backups-for-UCP-and-DTR" class="headerlink" title="Describe and demonstrate how to configure backups for UCP and DTR"></a>Describe and demonstrate how to configure backups for <a target="_blank" rel="noopener" href="https://success.docker.com/article/backup-restore-best-practices">UCP and DTR</a></h3><p>You can run the backup from any UCP manager node in the cluster, and you only<br>need to run the operation on one node (UCP replicates its configuration to all<br>manager nodes, so backing up from multiple nodes is not required).</p>
<p>Backing up UCP will stop all UCP containers on the manager that you’re executing<br>the operation on. With this in mind, you should be running a highly available UCP<br>cluster, and you should run the operation at a quiet time for the business.</p>
<p>backup UCP:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ docker container run --log-driver none --<span class="built_in">rm</span> -i --name ucp \</span><br><span class="line">-v /var/run/docker.sock:/var/run/docker.sock \</span><br><span class="line">docker/ucp:2.2.5 backup --interactive \</span><br><span class="line">--passphrase <span class="string">&quot;Password123&quot;</span> &gt; ucp.bkp</span><br></pre></td></tr></table></figure></p>
<p>recover UCP:</p>
<ol>
<li><p>Remove any existing, and potentially corrupted, UCP installations:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker container run --<span class="built_in">rm</span> -it --name ucp \</span><br><span class="line">-v /var/run/docker.sock:/var/run/docker.sock \</span><br><span class="line">docker/ucp:2.2.5 uninstall-ucp --interactive</span><br></pre></td></tr></table></figure>
</li>
<li><p>Restore UCP from the backup:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker container run --<span class="built_in">rm</span> -i --name ucp \</span><br><span class="line">-v /var/run/docker.sock:/var/run/docker.sock \</span><br><span class="line">docker/ucp:2.2.5 restore --passphrase <span class="string">&quot;Password123&quot;</span> &lt; ucp.bkp</span><br></pre></td></tr></table></figure>
</li>
<li><p>Log on to the UCP web UI and ensure that the user created earlier is still present<br>(or any other UCP objects that previously existed in your environment).</p>
</li>
</ol>
<p>Backup DTR:<br>As with UCP, DTR has a native backup command that is part of the Docker image<br>that was used to install the DTR. This native backup command will backup the DTR<br>configuration that is stored in a set of named volumes, and includes:</p>
<ul>
<li>DTR configuration</li>
<li>Repository metadata</li>
<li>Notary data</li>
<li>Certificates</li>
</ul>
<p>Images are not backed up as part of a native DTR backup. It is expected that<br>images are stored in a highly available storage backend that has its own independent<br>backup schedule using non-Docker tools.</p>
<p>Run the following command from a UCP manager node to perform a DTR backup:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">read</span> -sp <span class="string">&#x27;ucp password: &#x27;</span> UCP_PASSWORD; \</span><br><span class="line">docker run --log-driver none -i --<span class="built_in">rm</span> \</span><br><span class="line">--<span class="built_in">env</span> UCP_PASSWORD=<span class="variable">$UCP_PASSWORD</span> \</span><br><span class="line">docker/dtr:2.4.1 backup \</span><br><span class="line">--ucp-insecure-tls \</span><br><span class="line">--ucp-username admin \</span><br><span class="line">&gt; ucp.bkp</span><br></pre></td></tr></table></figure></p>
<p>Recover DTR from backups:</p>
<p>Restoring DTR from backups should be a last resort, and only attempted when the<br>majority of replicas are down and the cluster cannot be recovered any other way.<br>If you have lost a single replica and the majority are still up, you should add a new<br>replica using the <code>dtr join</code> command.</p>
<p>restore from backup, the workflow is like this:</p>
<ol>
<li>Stop and delete DTR on the node (might already be stopped)<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -it --<span class="built_in">rm</span> \</span><br><span class="line">docker/dtr:2.4.1 destroy \</span><br><span class="line">--ucp-insecure-tls</span><br></pre></td></tr></table></figure></li>
<li>Restore images to the shared storage backend (might not be required)</li>
<li>Restore DTR<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">read</span> -sp <span class="string">&#x27;ucp password: &#x27;</span> UCP_PASSWORD; \</span><br><span class="line">docker run -i --<span class="built_in">rm</span> \</span><br><span class="line">--<span class="built_in">env</span> UCP_PASSWORD=<span class="variable">$UCP_PASSWORD</span> \</span><br><span class="line">docker/dtr:2.4.1 restore \</span><br><span class="line">--ucp-url &lt;ENTER_YOUR_ucp-url&gt; \</span><br><span class="line">--ucp-node &lt;ENTER_DTR_NODE_hostname&gt; \</span><br><span class="line">--ucp-insecure-tls \</span><br><span class="line">--ucp-username admin \</span><br><span class="line">&lt; ucp.bkp</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="Domain-4-Networking-15-of-exam"><a href="#Domain-4-Networking-15-of-exam" class="headerlink" title="Domain 4: Networking (15% of exam)"></a>Domain 4: Networking (15% of exam)</h2><h3 id="Create-a-Docker-bridge-network-for-a-developer-to-use-for-their-containers"><a href="#Create-a-Docker-bridge-network-for-a-developer-to-use-for-their-containers" class="headerlink" title="Create a Docker bridge network for a developer to use for their containers"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/network/network-tutorial-standalone/">Create a Docker bridge network for a developer to use for their containers</a></h3><h3 id="Troubleshoot-container-and-engine-logs-to-understand-a-connectivity-issue-between"><a href="#Troubleshoot-container-and-engine-logs-to-understand-a-connectivity-issue-between" class="headerlink" title="[Troubleshoot container and engine logs to understand a connectivity issue between"></a>[Troubleshoot container and engine logs to understand a connectivity issue between</h3><p>  containers](<a target="_blank" rel="noopener" href="https://success.docker.com/article/troubleshooting-container-networking">https://success.docker.com/article/troubleshooting-container-networking</a>)</p>
<h3 id="Publish-a-port-so-that-an-application-is-accessible-externally"><a href="#Publish-a-port-so-that-an-application-is-accessible-externally" class="headerlink" title="Publish a port so that an application is accessible externally"></a><a target="_blank" rel="noopener" href="https://github.com/wsargent/docker-cheat-sheet#exposing-ports">Publish a port so that an application is accessible externally</a></h3><h3 id="Identify-which-IP-and-port-a-container-is-externally-accessible-on"><a href="#Identify-which-IP-and-port-a-container-is-externally-accessible-on" class="headerlink" title="Identify which IP and port a container is externally accessible on"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/port/#examples">Identify which IP and port a container is externally accessible on</a></h3><h3 id="Describe-the-different-types-and-use-cases-for-the-built-in-network-drivers"><a href="#Describe-the-different-types-and-use-cases-for-the-built-in-network-drivers" class="headerlink" title="Describe the different types and use cases for the built-in network drivers"></a><a target="_blank" rel="noopener" href="https://blog.docker.com/2016/12/understanding-docker-networking-drivers-use-cases/">Describe the different types and use cases for the built-in network drivers</a></h3><h3 id="Understand-the-Container-Network-Model-and-how-it-interfaces-with-the-Docker-engine"><a href="#Understand-the-Container-Network-Model-and-how-it-interfaces-with-the-Docker-engine" class="headerlink" title="[Understand the Container Network Model and how it interfaces with the Docker engine"></a>[Understand the Container Network Model and how it interfaces with the Docker engine</h3><p>  and network and IPAM drivers](<a target="_blank" rel="noopener" href="https://success.docker.com/article/networking/">https://success.docker.com/article/networking/</a>)</p>
<h3 id="Configure-Docker-to-use-external-DNS"><a href="#Configure-Docker-to-use-external-DNS" class="headerlink" title="Configure Docker to use external DNS"></a><a target="_blank" rel="noopener" href="https://gist.github.com/Evalle/7b21e0357c137875a03480428a7d6bf6">Configure Docker to use external DNS</a></h3><h3 id="Use-Docker-to-load-balance-HTTP-HTTPs-traffic-to-an-application-Configure-L7-load"><a href="#Use-Docker-to-load-balance-HTTP-HTTPs-traffic-to-an-application-Configure-L7-load" class="headerlink" title="[Use Docker to load balance HTTP/HTTPs traffic to an application (Configure L7 load"></a>[Use Docker to load balance HTTP/HTTPs traffic to an application (Configure L7 load</h3><p>  balancing with Docker EE)](<a target="_blank" rel="noopener" href="https://docs.docker.com/datacenter/ucp/2.2/guides/admin/configure/use-a-load-balancer/#configuration-examples">https://docs.docker.com/datacenter/ucp/2.2/guides/admin/configure/use-a-load-balancer/#configuration-examples</a>)</p>
<h3 id="Understand-and-describe-the-types-of-traffic-that-flow-between-the-Docker-engine"><a href="#Understand-and-describe-the-types-of-traffic-that-flow-between-the-Docker-engine" class="headerlink" title="[Understand and describe the types of traffic that flow between the Docker engine,"></a>[Understand and describe the types of traffic that flow between the Docker engine,</h3><p>  registry, and UCP controllers](<a target="_blank" rel="noopener" href="https://success.docker.com/article/networking/">https://success.docker.com/article/networking/</a>)</p>
<h3 id="Deploy-a-service-on-a-Docker-overlay-network"><a href="#Deploy-a-service-on-a-Docker-overlay-network" class="headerlink" title="Deploy a service on a Docker overlay network"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/network/overlay/">Deploy a service on a Docker overlay network</a></h3><ul>
<li>Describe the difference between “host” and “ingress” port publishing mode (<a target="_blank" rel="noopener" href="https://docs.docker.com/engine/swarm/services/#publish-a-services-ports-directly-on-the-swarm-node">Host</a>, <a target="_blank" rel="noopener" href="https://docs.docker.com/engine/swarm/ingress/">Ingress</a>)</li>
</ul>
<h2 id="Domain-5-Security-15-of-exam"><a href="#Domain-5-Security-15-of-exam" class="headerlink" title="Domain 5: Security (15% of exam)"></a>Domain 5: Security (15% of exam)</h2><h3 id="Describe-the-process-of-signing-an-image"><a href="#Describe-the-process-of-signing-an-image" class="headerlink" title="Describe the process of signing an image"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/security/trust/content_trust/#push-trusted-content">Describe the process of signing an image</a></h3><h3 id="Demonstrate-that-an-image-passes-a-security-scan"><a href="#Demonstrate-that-an-image-passes-a-security-scan" class="headerlink" title="Demonstrate that an image passes a security scan"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/datacenter/dtr/2.5/guides/admin/configure/set-up-vulnerability-scans/">Demonstrate that an image passes a security scan</a></h3><h3 id="Enable-Docker-Content-Trust"><a href="#Enable-Docker-Content-Trust" class="headerlink" title="Enable Docker Content Trust"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/security/trust/content_trust/">Enable Docker Content Trust</a></h3><h3 id="Configure-RBAC-in-UCP"><a href="#Configure-RBAC-in-UCP" class="headerlink" title="Configure RBAC in UCP"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/datacenter/ucp/2.2/guides/access-control/">Configure RBAC in UCP</a></h3><h3 id="Integrate-UCP-with-LDAP-AD"><a href="#Integrate-UCP-with-LDAP-AD" class="headerlink" title="Integrate UCP with LDAP/AD"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/datacenter/ucp/2.2/guides/admin/configure/external-auth/">Integrate UCP with LDAP/AD</a></h3><h3 id="Demonstrate-creation-of-UCP-client-bundles"><a href="#Demonstrate-creation-of-UCP-client-bundles" class="headerlink" title="Demonstrate creation of UCP client bundles"></a><a target="_blank" rel="noopener" href="https://blog.docker.com/2017/09/get-familiar-docker-enterprise-edition-client-bundles/">Demonstrate creation of UCP client bundles</a></h3><h3 id="Describe-default-engine-security"><a href="#Describe-default-engine-security" class="headerlink" title="Describe default engine security"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/security/security/">Describe default engine security</a></h3><h3 id="Describe-swarm-default-security"><a href="#Describe-swarm-default-security" class="headerlink" title="Describe swarm default security"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/swarm/how-swarm-mode-works/pki/">Describe swarm default security</a></h3><h3 id="Describe-MTLS"><a href="#Describe-MTLS" class="headerlink" title="Describe MTLS"></a><a target="_blank" rel="noopener" href="https://diogomonica.com/2017/01/11/hitless-tls-certificate-rotation-in-go/">Describe MTLS</a></h3><h3 id="Identity-roles"><a href="#Identity-roles" class="headerlink" title="Identity roles"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/datacenter/ucp/2.2/guides/access-control/permission-levels/#roles">Identity roles</a></h3><h3 id="Describe-the-difference-between-UCP-workers-and-managers"><a href="#Describe-the-difference-between-UCP-workers-and-managers" class="headerlink" title="Describe the difference between UCP workers and managers"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/datacenter/ucp/2.2/guides/architecture/">Describe the difference between UCP workers and managers</a></h3><ul>
<li>Describe process to use external certificates with UCP and DTR (<strong>UCP</strong> <a target="_blank" rel="noopener" href="https://success.docker.com/article/how-do-i-provide-an-externally-generated-security-certificate-during-the-ucp-command-line-installation">from cli</a>, <a target="_blank" rel="noopener" href="https://docs.docker.com/ee/ucp/admin/configure/use-your-own-tls-certificates/#configure-ucp-to-use-your-own-tls-certificates-and-keys">from GUI</a>, <a target="_blank" rel="noopener" href="https://docs.docker.com/datacenter/ucp/3.0/reference/cli/dump-certs/">print the public certificates</a>), <a target="_blank" rel="noopener" href="https://docs.docker.com/ee/dtr/admin/configure/use-your-own-tls-certificates/"><strong>DTR</strong></a>)</li>
</ul>
<h2 id="Domain-6-Storage-and-Volumes-10-of-exam"><a href="#Domain-6-Storage-and-Volumes-10-of-exam" class="headerlink" title="Domain 6: Storage and Volumes (10% of exam)"></a>Domain 6: Storage and Volumes (10% of exam)</h2><h3 id="State-which-graph-driver-should-be-used-on-which-OS"><a href="#State-which-graph-driver-should-be-used-on-which-OS" class="headerlink" title="State which graph driver should be used on which OS"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/storage/storagedriver/select-storage-driver/">State which graph driver should be used on which OS</a></h3><h3 id="Demonstrate-how-to-configure-devicemapper"><a href="#Demonstrate-how-to-configure-devicemapper" class="headerlink" title="Demonstrate how to configure devicemapper"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/storage/storagedriver/device-mapper-driver/#configure-docker-with-the-devicemapper-storage-driver">Demonstrate how to configure devicemapper</a></h3><h3 id="Compare-object-storage-to-block-storage-and-explain-which-one-is-preferable-when"><a href="#Compare-object-storage-to-block-storage-and-explain-which-one-is-preferable-when" class="headerlink" title="[Compare object storage to block storage, and explain which one is preferable when"></a>[Compare object storage to block storage, and explain which one is preferable when</h3><p>  available](<a target="_blank" rel="noopener" href="https://rancher.com/block-object-file-storage-containers/">https://rancher.com/block-object-file-storage-containers/</a>)</p>
<h3 id="Summarize-how-an-application-is-composed-of-layers-and-where-those-layers-reside-on"><a href="#Summarize-how-an-application-is-composed-of-layers-and-where-those-layers-reside-on" class="headerlink" title="[Summarize how an application is composed of layers and where those layers reside on"></a>[Summarize how an application is composed of layers and where those layers reside on</h3><p>  the filesystem](<a target="_blank" rel="noopener" href="https://docs.docker.com/storage/storagedriver/#images-and-layers">https://docs.docker.com/storage/storagedriver/#images-and-layers</a>)</p>
<h3 id="Describe-how-volumes-are-used-with-Docker-for-persistent-storage"><a href="#Describe-how-volumes-are-used-with-Docker-for-persistent-storage" class="headerlink" title="Describe how volumes are used with Docker for persistent storage"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/storage/volumes/">Describe how volumes are used with Docker for persistent storage</a></h3><ul>
<li>Identify the steps you would take to clean up unused images on a filesystem, also on DTR.<br>(<a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/image_prune/">image prune</a>, <a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/system_prune/">system prune</a> and <a target="_blank" rel="noopener" href="https://docs.docker.com/ee/dtr/user/manage-images/delete-images/">from DTR</a>)<h3 id="Demonstrate-how-storage-can-be-used-across-cluster-nodes"><a href="#Demonstrate-how-storage-can-be-used-across-cluster-nodes" class="headerlink" title="Demonstrate how storage can be used across cluster nodes"></a><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/extend/legacy_plugins/#volume-plugins">Demonstrate how storage can be used across cluster nodes</a></h3></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://xyshell.github.io/2020/06/11/DCA-note/" data-id="clywj85fp0000t895cp1q9ea9" class="article-share-link">
        Share
      </a>
      
<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker-DCA/" rel="tag">docker, DCA</a></li></ul>

    </footer>

  </div>

  

  

</article>
    
    <article id="post-docker-note" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      
  
  <h2 class="article-title" itemprop="name">
    <a href="/2020/06/08/docker-note/">Docker Note</a>
  </h2>
  
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/06/08/docker-note/" class="article-date">
  <time datetime="2020-06-08T18:40:24.000Z" itemprop="datePublished">2020-06-08</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
        <h1 id="Install-Docker"><a href="#Install-Docker" class="headerlink" title="Install Docker"></a>Install Docker</h1><h2 id="On-Debian"><a href="#On-Debian" class="headerlink" title="On Debian"></a>On Debian</h2><p>uninstall old versions:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> apt-get remove docker docker-engine docker.io containerd runc</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> apt-get update</span><br><span class="line">$ <span class="built_in">sudo</span> apt-get install \</span><br><span class="line">    apt-transport-https \</span><br><span class="line">    ca-certificates \</span><br><span class="line">    curl \</span><br><span class="line">    gnupg-agent \</span><br><span class="line">    software-properties-common</span><br><span class="line">$ curl -fsSL https://download.docker.com/linux/debian/gpg | <span class="built_in">sudo</span> apt-key add -</span><br></pre></td></tr></table></figure>
<p>Verfiy key with the fingerprint:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-key fingerprint 0EBFCD88</span><br></pre></td></tr></table></figure>
<p>For x86_64 / amd64 architecture:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> add-apt-repository \</span><br><span class="line">   <span class="string">&quot;deb [arch=amd64] https://download.docker.com/linux/debian \</span></span><br><span class="line"><span class="string">   <span class="subst">$(lsb_release -cs)</span> \</span></span><br><span class="line"><span class="string">   stable&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> apt-get update</span><br><span class="line">$ <span class="built_in">sudo</span> apt-get install docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></table></figure>
<p>Run hello world demo</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> docker run hello-world</span><br></pre></td></tr></table></figure>
<p>Avoid <code>sudo</code> when running docker:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> nano /etc/group</span><br></pre></td></tr></table></figure>
<p>add username to <code>docker:x:999:&lt;username&gt;</code>, e.x. <code>docker:x:999:admin</code></p>
<p>Or:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> usermod -a -G docker &lt;username&gt;</span><br></pre></td></tr></table></figure>
<h2 id="On-Ubuntu-by-Shell-Script"><a href="#On-Ubuntu-by-Shell-Script" class="headerlink" title="On Ubuntu by Shell Script"></a>On Ubuntu by Shell Script</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wget -qO- https://get.docker.com/ | sh</span><br></pre></td></tr></table></figure>
<p>add user accout to local unix docker group, to avoid <code>sudo</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> usermod -aG docker &lt;username&gt; <span class="comment"># e.x. admin</span></span><br></pre></td></tr></table></figure>
<h2 id="Launching-a-Docker-container"><a href="#Launching-a-Docker-container" class="headerlink" title="Launching a Docker container"></a>Launching a Docker container</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano Dockerfile</span><br></pre></td></tr></table></figure>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##############################</span></span><br><span class="line"><span class="comment"># Dockerfile to create Ubuntu webserver</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">18.04</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get install -y apache2</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&quot;Welcome to my web site&quot;</span> &gt; /var/www/html/index.html</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span></span><br><span class="line"><span class="comment">##############################</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker build -t <span class="string">&quot;webserver&quot;</span> .</span><br><span class="line">docker images</span><br><span class="line">docker run -d -p 80:80 webserver /usr/sbin/apache2ctl -D FOREGROUND</span><br><span class="line">docker ps</span><br><span class="line">curl localhost</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="Docker-Engine-Architecture"><a href="#Docker-Engine-Architecture" class="headerlink" title="Docker Engine Architecture"></a>Docker Engine Architecture</h1><h2 id="Big-Picture"><a href="#Big-Picture" class="headerlink" title="Big Picture"></a>Big Picture</h2><p><img src="/photos/docker-note/docker_engine.png" alt="docker_engine"></p>
<h2 id="Example-of-creating-a-container"><a href="#Example-of-creating-a-container" class="headerlink" title="Example of creating a container"></a>Example of creating a container</h2><p><img src="/photos/docker-note/create_container.png" alt="create_container"></p>
<p>“Daemon” can restart without affecting on containers, which means upgrading doesn’t kill containers, same for “containerd”. Can restart them, leaving all containers running, when come back, they re-discover running containers and reconnect to the shim.</p>
<h2 id="Docker-on-Windows-Native-and-Hyper-V"><a href="#Docker-on-Windows-Native-and-Hyper-V" class="headerlink" title="Docker on Windows: Native and Hyper-V"></a>Docker on Windows: Native and Hyper-V</h2><p><img src="/photos/docker-note/windows_container.png" alt="windows_container"></p>
<p>only low level difference, APIs for users are the same.<br>The idea is by VM isolation of Hyper-V(lightweight VM) might be better or more secure than Namespaces. Also, can run different OS in VM.</p>
<hr>
<h1 id="Docker-Images"><a href="#Docker-Images" class="headerlink" title="Docker Images"></a>Docker Images</h1><p><img src="/photos/docker-note/docker_image.png" alt="docker_image"></p>
<p>Image is <strong>read-only</strong> template for creating application containers. <strong>Independent</strong> layer loosely connected by a manifest file(config file).</p>
<p><img src="/photos/docker-note/docker_image_container.png" alt="docker_image_container"></p>
<p>Every container can also write by copying read-only layer(files in it) to its writable layer, and do changes there.</p>
<h2 id="Pull-a-docker-image"><a href="#Pull-a-docker-image" class="headerlink" title="Pull a docker image"></a>Pull a docker image</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker image pull redis</span><br></pre></td></tr></table></figure>
<p>In fact, we are pulling layers:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Using default tag: latest</span><br><span class="line">latest: Pulling from library/redis</span><br><span class="line">afb6ec6fdc1c: Pull complete <span class="comment"># layer</span></span><br><span class="line">608641ee4c3f: Pull complete</span><br><span class="line">668ab9e1f4bc: Pull complete</span><br><span class="line">78a12698914e: Pull complete</span><br><span class="line">d056855f4300: Pull complete</span><br><span class="line">618fdf7d0dec: Pull complete</span><br><span class="line">Digest: sha256:ec277acf143340fa338f0b1a9b2f23632335d2096940d8e754474e21476eae32</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> redis:latest</span><br><span class="line">docker.io/library/redis:latest</span><br></pre></td></tr></table></figure>
<p>Fat manifest is specified by OS architecture, to get image manifest:</p>
<p><img src="/photos/docker-note/image_manifest.png" alt="image_manifest"></p>
<p>Referencing by hash to avoid mismatch between the image asking for and the image got.</p>
<p>Using overlay2 as storage driver, those layers are stored at <code>/var/lib/docker/overlay2</code>. To see layers, run:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> <span class="built_in">ls</span> -l /var/lib/docker/overlay2</span><br></pre></td></tr></table></figure>
<p>to get content of layer, run:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> <span class="built_in">ls</span> -l /var/lib/docker/overlay2/&lt;sha256&gt;</span><br></pre></td></tr></table></figure>
<p>Layer structure, e.x.:</p>
<ol>
<li>Base layer (OS files and objects)</li>
<li>App codes</li>
<li>Updates …</li>
</ol>
<p>-&gt; a single unified file system.</p>
<h2 id="Check-images"><a href="#Check-images" class="headerlink" title="Check images"></a>Check images</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ docker image <span class="built_in">ls</span>  / $ docker images</span><br><span class="line">$ docker image <span class="built_in">ls</span> --digests <span class="comment"># get sha256</span></span><br><span class="line">$ docker image <span class="built_in">ls</span> --filter dangling=<span class="literal">true</span> <span class="comment"># get &lt;none&gt;:&lt;none&gt;</span></span><br><span class="line">$ docker image <span class="built_in">ls</span> --filter=reference=<span class="string">&quot;*:latest&quot;</span></span><br><span class="line">$ docker image <span class="built_in">ls</span> --format <span class="string">&quot;&#123;&#123;.Size&#125;&#125;&quot;</span></span><br><span class="line">$ docker image <span class="built_in">ls</span> --format <span class="string">&quot;&#123;&#123;.Repository&#125;&#125;: &#123;&#123;.Tag&#125;&#125;: &#123;&#123;.Size&#125;&#125;&quot;</span></span><br><span class="line">$ docker image <span class="built_in">ls</span> --format <span class="string">&quot;&#123;&#123;json .&#125;&#125;&quot;</span> <span class="comment"># print in json format</span></span><br></pre></td></tr></table></figure>
<p>to see operation history of one image, run:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="built_in">history</span> redis</span><br></pre></td></tr></table></figure>
<p>every non-zero size creates a new layer, the rests add something to image’s json config file.</p>
<p>to get configs and layers of one image, run:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker image inspect redis</span><br></pre></td></tr></table></figure>
<h2 id="Delete-images"><a href="#Delete-images" class="headerlink" title="Delete images"></a>Delete images</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ docker image <span class="built_in">rm</span> redis</span><br><span class="line">$ docker rmi alpine</span><br><span class="line">$ docker image prune <span class="comment"># delete all dangle images</span></span><br><span class="line">$ docker image prune -a <span class="comment"># delete all unused images, not used by any container</span></span><br></pre></td></tr></table></figure>
<h2 id="Registries"><a href="#Registries" class="headerlink" title="Registries"></a>Registries</h2><p>Images live in registries. When <code>docker image pull &lt;some-image&gt;</code>, defaultly pulling from Docker Hub.</p>
<p>Official images live in the top level of Docker Hub namespaces, e.x. docker.io/redis, docker.io/nginx. Can ignore registry name “docker.io/“ by default, then do repo name “redis”, then do tag name “latest”, which is an image actually. So the full version is `docker image pull docker.io/redis:4.0.1</p>
<p>Unofficial ones, e.x. nigelpoulton/tu-demo</p>
<p>To pull all tags of images from repo, run</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker image pull &lt;some-image&gt; -a</span><br></pre></td></tr></table></figure>
<p>Content hashes for host, compressed hashes(distribution hashes) for wire, to verify. UIDs used for storing layers are random.</p>
<p>run sha256 on content of layer -&gt; layer’s hash as ID;<br>run sha256 on image config file -&gt; image’s hash as ID.</p>
<hr>
<h1 id="Containerizing"><a href="#Containerizing" class="headerlink" title="Containerizing"></a>Containerizing</h1><h2 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h2><p>Dockerfile is list of instructions for building images with an app inside(document the app).</p>
<p>Good practice: put Dockerfile in root folder of app.</p>
<p>Good practice: <code>LABEL maintainer=&quot;xxx@gmail.com&quot;</code></p>
<p>notes:</p>
<ul>
<li>CAPITALIZE instructions</li>
<li><code>&lt;INSTRUCTION&gt; &lt;value&gt;</code>, e.x. <code>FROM alpine</code></li>
<li><code>FROM</code> always first instruction, as base image</li>
<li><code>RUN</code> execute command and create layer</li>
<li><code>COPY</code> copy code into image as new layer</li>
<li>instructions like <code>WORKDIR</code> are adding metadata instead of layers</li>
<li><code>ENTRYPOINT</code> default app for image/container, metadata</li>
<li><code>CMD</code> run-time arguments override CMD instructions, append to <code>ENTRYPOINT</code></li>
</ul>
<p>e.x.:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> alpine</span><br><span class="line"></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> maintainer=<span class="string">&quot;xyshell@bu.edu&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apk add --update nodejs nodejs-npm</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . /src</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /src</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm install</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;node&quot;</span>, <span class="string">&quot;./app.js&quot;</span>] <span class="comment"># relative to WORKDIR</span></span></span><br></pre></td></tr></table></figure>
<p>code: <a target="_blank" rel="noopener" href="https://github.com/nigelpoulton/psweb">https://github.com/nigelpoulton/psweb</a></p>
<h2 id="Build-image"><a href="#Build-image" class="headerlink" title="Build image"></a>Build image</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker image build -t &lt;image-name&gt; . <span class="comment"># current folder</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker image build -t psweb https://github.com/nigelpoulton/psweb.git <span class="comment"># git repo</span></span><br></pre></td></tr></table></figure>
<p><code>docker image ls</code> to check it exists.</p>
<p>During each step, docker spins up temporary containers, once the following layer is built, the container is removed.</p>
<h2 id="Run-container"><a href="#Run-container" class="headerlink" title="Run container"></a>Run container</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker container run -d --name &lt;app-name&gt; -p 8080:8080 &lt;image&gt; <span class="comment"># detach mode</span></span><br><span class="line">$ docker run -dit --name alpine1 alpine ash <span class="comment"># iterative and detach, can docker attach alpine1 later</span></span><br></pre></td></tr></table></figure>
<h2 id="Multi-stage-Builds"><a href="#Multi-stage-Builds" class="headerlink" title="Multi-stage Builds"></a>Multi-stage Builds</h2><p>use multiple FROM statements in Dockerfile.</p>
<p>Each FROM instruction can use a different base, and each of them begins a new stage of the build.</p>
<p>can selectively copy artifacts from one stage to another, leaving behind everything you don’t want in the final image.</p>
<ul>
<li><code>FROM ... AS ...</code></li>
<li><code>COPY --from==...</code></li>
</ul>
<p>example 1:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> node:latest AS storefront</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /usr/src/atsea/app/react-app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> react-app .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm install</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm run build</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> maven:latest AS appserver</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /usr/src/atsea</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> pom.xml .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> mvn -B -f pom.xml -s /usr/share/maven/ref/settings-docker.xml dependency:resolve</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> mvn -B -s /usr/share/maven/ref/settings-docker.xml package -DskipTests</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> java:<span class="number">8</span>-jdk-alpine</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> adduser -Dh /home/gordon gordon</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /static</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=storefront /usr/src/atsea/app/react-app/build/ .</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=appserver /usr/src/atsea/target/AtSea-0.0.1-SNAPSHOT.jar .</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;java&quot;</span>, <span class="string">&quot;-jar&quot;</span>, <span class="string">&quot;/app/AtSea-0.0.1-SNAPSHOT.jar&quot;</span>]</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;--spring.profiles.active=postgres&quot;</span>]</span></span><br></pre></td></tr></table></figure>
<p>source: <a target="_blank" rel="noopener" href="https://github.com/dockersamples/atsea-sample-shop-app/blob/master/app/Dockerfile">https://github.com/dockersamples/atsea-sample-shop-app/blob/master/app/Dockerfile</a></p>
<p>example 2:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> golang:<span class="number">1.7</span>.<span class="number">3</span> AS builder</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /go/src/github.com/alexellis/href-counter/</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> go get -d -v golang.org/x/net/html</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> app.go    .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o app .</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> alpine:latest</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apk --no-cache add ca-certificates</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /root/</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /go/src/github.com/alexellis/href-counter/app .</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;./app&quot;</span>]</span></span><br></pre></td></tr></table></figure>
<p>source: <a target="_blank" rel="noopener" href="https://docs.docker.com/develop/develop-images/multistage-build/#name-your-build-stages">https://docs.docker.com/develop/develop-images/multistage-build/#name-your-build-stages</a></p>
<p>When building image, don’t have to build the entire Dockerfile including every stage. Can specify a target build stage, and stop at that stage.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker build --target builder -t alexellis2/href-counter:latest .</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="Docker-containers"><a href="#Docker-containers" class="headerlink" title="Docker containers"></a>Docker containers</h1><p>Most atomic unit in docker is container.</p>
<p>microservices instead of monolith, glue by APIs. Containers should be as small and simple as possible. Single process per container.</p>
<p>modernize traditional apps:</p>
<p><img src="/photos/docker-note/modernize_traditional_apps.png" alt="modernize_traditional_apps"></p>
<p>container should be ephemeral and immutable.</p>
<h2 id="Check-status"><a href="#Check-status" class="headerlink" title="Check status"></a>Check status</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker ps / $ docker container <span class="built_in">ls</span> <span class="comment"># running containers</span></span><br><span class="line">$ docker ps -a <span class="comment"># all containers</span></span><br><span class="line">$ docker port &lt;container&gt; <span class="comment"># Port mapping e.x. 80/tcp -&gt; 0.0.0.0:80</span></span><br></pre></td></tr></table></figure>
<h2 id="Run-containers"><a href="#Run-containers" class="headerlink" title="Run containers"></a>Run containers</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker container run ... / docker run ...</span><br><span class="line">$ docker container run -it alpine sh <span class="comment"># iterative terminal</span></span><br><span class="line">$ docker container run -d alpine <span class="built_in">sleep</span> 1d <span class="comment"># detached mode, command</span></span><br></pre></td></tr></table></figure>
<h2 id="Stop-containers"><a href="#Stop-containers" class="headerlink" title="Stop containers"></a>Stop containers</h2><p>Stopping a container sends signal to main process in the container (PID1), gives 10s before force stop.</p>
<p>Stopping and restarting a container doesn’t destory data.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker container stop &lt;container&gt;</span><br></pre></td></tr></table></figure>
<h2 id="Start-containers"><a href="#Start-containers" class="headerlink" title="Start containers"></a>Start containers</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker container start &lt;container&gt;</span><br></pre></td></tr></table></figure>
<h2 id="Enter-containers"><a href="#Enter-containers" class="headerlink" title="Enter containers"></a>Enter containers</h2><p>execing into a container starts a new process</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker container <span class="built_in">exec</span> -it &lt;container&gt; sh</span><br><span class="line">$ docker container <span class="built_in">exec</span> &lt;container&gt; <span class="built_in">ls</span> -l</span><br><span class="line">$ docker container <span class="built_in">exec</span> &lt;container&gt; <span class="built_in">cat</span> &lt;file-name&gt;</span><br></pre></td></tr></table></figure>
<p>exiting by <code>exit</code> kills the process, if it’s the only one, container exits. However, ctrl+P+Q gets out of container without terminating its main process (can <code>docker attach</code> to it).</p>
<h2 id="Remove-containers"><a href="#Remove-containers" class="headerlink" title="Remove containers"></a>Remove containers</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker container <span class="built_in">rm</span> &lt;container&gt;</span><br><span class="line">$ docker container <span class="built_in">rm</span> $(docker container <span class="built_in">ls</span> -aq) -f <span class="comment"># remove all containers, force</span></span><br></pre></td></tr></table></figure>
<h2 id="Log"><a href="#Log" class="headerlink" title="Log"></a>Log</h2><p>Engine/daemon logs and Container/App logs</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker logs &lt;container&gt;</span><br></pre></td></tr></table></figure>
<p><img src="/photos/docker-note/logging.png" alt="logging"></p>
<h1 id="Swarm-and-Services"><a href="#Swarm-and-Services" class="headerlink" title="Swarm and Services"></a>Swarm and Services</h1><h2 id="Swarm"><a href="#Swarm" class="headerlink" title="Swarm"></a>Swarm</h2><p>swarm is a secure cluster of docker nodes, including “secure cluster” and “orchestrator”</p>
<p>can do native swarm work and kubernetes on swarm cluster</p>
<p>single-engine mode: install individual docker instances VS swarm mode: working on a cluster of docker instances.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker system info <span class="comment">#  Swarm: inactive/active</span></span><br></pre></td></tr></table></figure>
<h3 id="Single-docker-node-to-swarm-mode"><a href="#Single-docker-node-to-swarm-mode" class="headerlink" title="Single docker node to swarm mode"></a>Single docker node to swarm mode</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker swarm init</span><br><span class="line">$ docker swarm init --external-ca</span><br></pre></td></tr></table></figure>
<p>if it’s the first manager of swarm, it’s automatically elected as its leader(root CA).</p>
<ul>
<li>issue itself a client certificate.</li>
<li>Build a secure cluster store(ETD) and automatically distributed to every other manager in the swarm, encrypted.</li>
<li>default certificate rotation policy.</li>
<li>a set of cryptographic join tokens, one for joining new managers, another for joining new workers.</li>
</ul>
<p>on manager node, query cluster store to check all nodes:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker node <span class="built_in">ls</span> <span class="comment"># lists all nodes in the swarm</span></span><br><span class="line">$ docker node <span class="built_in">ls</span> --filter role=manager/worker</span><br></pre></td></tr></table></figure>
<h3 id="Join-another-manager-and-workers"><a href="#Join-another-manager-and-workers" class="headerlink" title="Join another manager and workers"></a>Join another manager and workers</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker swarm <span class="built_in">join</span></span><br></pre></td></tr></table></figure>
<p><img src="/photos/docker-note/swarm.png" alt="swarm"></p>
<p>Every swarm has a <strong>single leader manager</strong>, the rest are follower managers.</p>
<p>Commands could be issued to any manager, hitting a follower manager will proxy commands to the leader.</p>
<p>If the leader fails, another one gets selected as a new leader.</p>
<p>Best practice: ideal number of managers is 3, 5, 7. Make sure its odd number, to increase chance of achieving quorum.</p>
<p>Connect managers by fast and reliable network. e.x. in AWS, put in same region, could cross availability zones.</p>
<p>Workers doesn’t join cluster store, which is just for managers.</p>
<p>Workers have a full list of IPs for all managers. If one manager dies, workders talk to another.</p>
<p>get join token:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ docker swarm join-token manager</span><br><span class="line">SWMTKN-1-36xjjuzeryn11xc2xtrnjjxy288aef43o2r8o8grrpela5gsq4-2pvht1x50o3s8hm5rcur5cizo 192.168.0.31:2377</span><br><span class="line">$ docker swarm join-token worker</span><br><span class="line">SWMTKN-1-36xjjuzeryn11xc2xtrnjjxy288aef43o2r8o8grrpela5gsq4-5rzpk82wtde7durxwiu1mmh14 192.168.0.31:2377</span><br></pre></td></tr></table></figure>
<p>note:</p>
<ul>
<li>SWMTKN: identifier</li>
<li>36xjju: cluster identifier, hash of cluster certificate (same for same swarm cluster)</li>
<li>2pvht1 or 5rzpk8: determines worker or manager (could change by rotation)</li>
</ul>
<p>switch to another node:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker swarm <span class="built_in">join</span> --token ...</span><br></pre></td></tr></table></figure>
<p>to rotate token(change password):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker swarm join-token --rotate worker</span><br><span class="line">$ docker swarm join-token --rotate manager</span><br></pre></td></tr></table></figure>
<p>The existing managers and workers stay unaffected.</p>
<p>to get client certificates:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> openssl x509 -<span class="keyword">in</span> /var/lib/docker/swarm/certificates/swarm-node.crt -text</span><br></pre></td></tr></table></figure>
<p>in Subject field:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Subject: O = pn6210vdux6ppj3uef0kqn8cv, OU = swarm-manager, CN = dkyneha22mdz384n3b3mdvjk7</span><br></pre></td></tr></table></figure>
<p>note:</p>
<ul>
<li>O: organization, swarm ID</li>
<li>OU: organizational unit, node’s role(swarm-manager/workder)</li>
<li>CN: canonical name, cryptographic node ID</li>
</ul>
<h3 id="Remmove-swarm-node"><a href="#Remmove-swarm-node" class="headerlink" title="Remmove swarm node"></a>Remmove swarm node</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker node demote &lt;NODE&gt; <span class="comment"># To demote the node</span></span><br><span class="line">$ docker node <span class="built_in">rm</span> &lt;NODE&gt; <span class="comment"># To remove the node from the swarm</span></span><br><span class="line">$ docker swarm leave</span><br></pre></td></tr></table></figure>
<h3 id="Autolock-swarm"><a href="#Autolock-swarm" class="headerlink" title="Autolock swarm"></a>Autolock swarm</h3><ul>
<li>prevents restarted managers(not applied to workers) from automatically re-joining the swarm</li>
<li>pervents accidentally restoring old copies of the swarm</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker swarm init --autolock <span class="comment"># autolock new swarm</span></span><br><span class="line">$ docker swarm update --autolock=<span class="literal">true</span> <span class="comment"># autolock existing swarm</span></span><br><span class="line">SWMKEY-1-7e7w/gsGI2iGL9dqRtY/JqOOffnP5INPRw5uME2o+hM <span class="comment"># jot down unlock key</span></span><br></pre></td></tr></table></figure>
<p>Then if manager restarts by:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> service docker restart</span><br></pre></td></tr></table></figure>
<p>Inspecting the cluster by <code>docker node ls</code> gives raft logs saying swarm is encrypted.</p>
<p>re-join the swarm by:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker swarm unlock</span><br><span class="line">Please enter unlock key: SWMKEY-1-7e7w/gsGI2iGL9dqRtY/JqOOffnP5INPRw5uME2o+hM</span><br></pre></td></tr></table></figure>
<p>check again by <code>docker node ls</code> to confirm.</p>
<h3 id="Update-certificate-expiry-time"><a href="#Update-certificate-expiry-time" class="headerlink" title="Update certificate expiry time"></a>Update certificate expiry time</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker swarm update --cert-expiry 48h</span><br></pre></td></tr></table></figure>
<p>check by <code>docker system info</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CA Configuration:</span><br><span class="line">  Expiry Duration: 2 days</span><br></pre></td></tr></table></figure>
<h3 id="Update-a-node"><a href="#Update-a-node" class="headerlink" title="Update a node"></a>Update a node</h3><p>Add label metadata to a node by:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker node update --label-add foo worker1</span><br><span class="line">$ docker node update --label-add foo --label-add bar worker1</span><br></pre></td></tr></table></figure>
<p>then node labels used a placement constraint when creating service.</p>
<h3 id="Orchestration-intro"><a href="#Orchestration-intro" class="headerlink" title="Orchestration intro"></a>Orchestration intro</h3><p><img src="/photos/docker-note/orchestration_intro.png" alt="orchestration_intro"></p>
<hr>
<h2 id="Services"><a href="#Services" class="headerlink" title="Services"></a>Services</h2><p>There are two types of service deployments, replicated and global:</p>
<ul>
<li>For a replicated service, you specify the number of identical tasks you want to run. For example, you decide to deploy an HTTP service with three replicas, each serving the same content.</li>
<li>A global service is a service that runs one task on every node. There is no pre-specified number of tasks. Each time you add a node to the swarm, the orchestrator creates a task and the scheduler assigns the task to the new node. Good candidates for global services are monitoring agents, an anti-virus scanners or other types of containers that you want to run on every node in the swarm.</li>
</ul>
<h3 id="Create-service"><a href="#Create-service" class="headerlink" title="Create service"></a>Create service</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker service create --replicas 5 &lt;service&gt; <span class="comment"># default replicated mode</span></span><br><span class="line">$ docker service create --mode global &lt;service&gt; <span class="comment"># global mode</span></span><br></pre></td></tr></table></figure>
<h3 id="Check-status-1"><a href="#Check-status-1" class="headerlink" title="Check status"></a>Check status</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ docker service <span class="built_in">ls</span> <span class="comment"># list all services</span></span><br><span class="line">$ docker service ps &lt;service&gt; <span class="comment"># list all tasks</span></span><br><span class="line">$ docker service inspect &lt;service&gt; --pretty <span class="comment"># details</span></span><br><span class="line">$ docker service inspect &lt;service&gt; | jq -r <span class="string">&#x27;.[].CreatedAt&#x27;</span> </span><br><span class="line">$ docker service ps &lt;service&gt; --format <span class="string">&quot;&#123;&#123;json .&#125;&#125;&quot;</span> --filter <span class="string">&quot;desired-state=running&quot;</span> | jq -r .ID</span><br><span class="line">$ docker inspect &lt;task&gt; | jq -r <span class="string">&#x27;.[].Status.ContainerStatus.ContainerID&#x27;</span></span><br></pre></td></tr></table></figure>
<h3 id="Remove-services"><a href="#Remove-services" class="headerlink" title="Remove services"></a>Remove services</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker service <span class="built_in">rm</span> $(docker service <span class="built_in">ls</span> -q) <span class="comment"># remove all services</span></span><br></pre></td></tr></table></figure>
<h3 id="Update-services"><a href="#Update-services" class="headerlink" title="Update services"></a>Update services</h3><p>rescale services by:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker service scale &lt;service&gt;=20</span><br></pre></td></tr></table></figure>
<p>update service’s image by:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ docker service update \</span><br><span class="line">  --image nigelpoulton/tu-demo:v2 \</span><br><span class="line">  --update-parallelism 2 \</span><br><span class="line">  --update-delay 20s &lt;service&gt;</span><br></pre></td></tr></table></figure>
<p>then update parallelism and update delay settings are now part of the service definition.</p>
<p>update service’s network by:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ docker service update \</span><br><span class="line">  --network-add &lt;new-network&gt; \</span><br><span class="line">  --network-rm &lt;old-network \</span><br><span class="line">  &lt;service&gt;</span><br></pre></td></tr></table></figure>
<h3 id="Logs"><a href="#Logs" class="headerlink" title="Logs"></a>Logs</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ docker service logs &lt;service&gt;</span><br><span class="line">  --follow</span><br><span class="line">  --<span class="built_in">tail</span> 1000</span><br><span class="line">  --details</span><br></pre></td></tr></table></figure>
<h1 id="Container-Networking"><a href="#Container-Networking" class="headerlink" title="Container Networking"></a>Container Networking</h1><p>See the current network:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker network <span class="built_in">ls</span></span><br></pre></td></tr></table></figure>
<p>Every container goes onto bridge (nat on Windows) network by default.</p>
<p><img src="/photos/docker-note/container_network.png" alt="container_network"></p>
<h2 id="Network-types"><a href="#Network-types" class="headerlink" title="Network types"></a>Network types</h2><p>containers talk to each other, VMs, physicals and internet. Vice versa.</p>
<h3 id="Bridge-Networking"><a href="#Bridge-Networking" class="headerlink" title="Bridge Networking"></a>Bridge Networking</h3><p>a.k.a single-host networking, docker0.</p>
<p>can only connect containers on the same host. Isolated layer-two network, even on the same host. Get in/out traffic by mapping port to the host.</p>
<p><img src="/photos/docker-note/bridge_network.png" alt="bridge_network"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker network inspect bridge <span class="comment"># default bridge network</span></span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bridge&quot;</span><span class="punctuation">,</span> <span class="comment">//</span></span><br><span class="line">  <span class="attr">&quot;Id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;f904473bbf1f625413c0cd2e1b7c0271253056709731cab4271ee95906ef270c&quot;</span><span class="punctuation">,</span> <span class="comment">//</span></span><br><span class="line">  <span class="attr">&quot;Created&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2020-06-09T21:03:39.158623688Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;Scope&quot;</span><span class="punctuation">:</span> <span class="string">&quot;local&quot;</span><span class="punctuation">,</span> <span class="comment">//</span></span><br><span class="line">  <span class="attr">&quot;Driver&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bridge&quot;</span><span class="punctuation">,</span> <span class="comment">//</span></span><br><span class="line">  <span class="attr">&quot;EnableIPv6&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;IPAM&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Driver&quot;</span><span class="punctuation">:</span> <span class="string">&quot;default&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Options&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Config&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Subnet&quot;</span><span class="punctuation">:</span> <span class="string">&quot;172.17.0.0/16&quot;</span> <span class="comment">// ip range</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;Internal&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;Attachable&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;Ingress&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ConfigFrom&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ConfigOnly&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;Containers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="comment">// currently no containers</span></span><br><span class="line">  <span class="attr">&quot;Options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;com.docker.network.bridge.default_bridge&quot;</span><span class="punctuation">:</span> <span class="string">&quot;true&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;com.docker.network.bridge.enable_icc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;true&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;com.docker.network.bridge.enable_ip_masquerade&quot;</span><span class="punctuation">:</span> <span class="string">&quot;true&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;com.docker.network.bridge.host_binding_ipv4&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.0.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;com.docker.network.bridge.name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;docker0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;com.docker.network.driver.mtu&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1500&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;Labels&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>create a container without specifying network by <code>$ docker container run --rm -d alpine sleep 1d</code>, then inspect again:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Containers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;4ea75ff740542150570357239d2f61f236f18d3840cffb3bdeae1df2745a9c2e&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cool_haibt&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;EndpointID&quot;</span><span class="punctuation">:</span> <span class="string">&quot;f0dc9a4302cd78d262a1ec562fae8ae635d2cebb2733c60cfa40d5eb00d04564&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;MacAddress&quot;</span><span class="punctuation">:</span> <span class="string">&quot;02:42:ac:11:00:02&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;IPv4Address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;172.17.0.2/16&quot;</span><span class="punctuation">,</span> <span class="comment">//ip address</span></span><br><span class="line">      <span class="attr">&quot;IPv6Address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>to talk to outside, need port mapping:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker container run --<span class="built_in">rm</span> -d --name web -p 8080:80 nginx <span class="comment"># host port 8080 to container port 80</span></span><br><span class="line"><span class="comment"># --rm: remove the container once it exits/stops</span></span><br></pre></td></tr></table></figure>
<p>show port mapping by:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker port &lt;container&gt;</span><br><span class="line">80/tcp -&gt; 0.0.0.0:8080 <span class="comment"># container port -&gt; host port</span></span><br></pre></td></tr></table></figure>
<p>then can visit the web by <code>localhost:8080</code></p>
<p>create a bridge network:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker network create -d bridge &lt;network-name&gt;</span><br></pre></td></tr></table></figure>
<p>check by <code>docker network ls</code>. To run containers in it:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker container run --<span class="built_in">rm</span> -d --network &lt;network-name&gt; alpine <span class="built_in">sleep</span> 1d</span><br></pre></td></tr></table></figure>
<p>to switch container between networks:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker network disconnect &lt;network1&gt; web <span class="comment"># even when container is running</span></span><br><span class="line">$ docker network connect &lt;network2&gt; web</span><br></pre></td></tr></table></figure>
<h3 id="Overlay-Networking"><a href="#Overlay-Networking" class="headerlink" title="Overlay Networking"></a>Overlay Networking</h3><p>a.k.a multi-host networking.</p>
<p>Single layer-two network spanning multiple hosts</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker network create</span><br><span class="line">$ docker network create -o encrypted <span class="comment"># encrypt data plane</span></span><br></pre></td></tr></table></figure>
<p>built-in overlay is container to container only (not applied to VM, physicals)</p>
<p><img src="/photos/docker-note/overlay_network.png" alt="overlay_network"></p>
<p>To create a overlay network:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker network create -d overlay &lt;network-name&gt;</span><br></pre></td></tr></table></figure>
<p>check by <code>docker network ls</code>, note its scope is “swarm”, which means availabel on every node in the swarm.</p>
<p>create a service to use this overlay network:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker service create -d --name &lt;service&gt; --replicas 2 --network overnet alpine <span class="built_in">sleep</span> 1d <span class="comment"># default replicated mode</span></span><br></pre></td></tr></table></figure>
<p>check by <code>docker service ls</code>, check which nodes are running the service by <code>docker service ps &lt;service&gt;</code>, more details run <code>docker service inspect &lt;service&gt;</code></p>
<p>switch to one node which runs this service and run <code>docker network inspect &lt;network-name&gt;</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Containers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;7df4738446ac44a577d026a11ad73401c6cbdaaafcddbe75028954e7191fe1a1&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pinger.1.neku7xixs6g8oe2r8otlnqnep&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;EndpointID&quot;</span><span class="punctuation">:</span> <span class="string">&quot;9a2dbdda2c15b991eeba7c1ab6fabd93e42b5ed4495b2f47d038dc871143a409&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;MacAddress&quot;</span><span class="punctuation">:</span> <span class="string">&quot;02:42:0a:00:01:04&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;IPv4Address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10.0.1.4/24&quot;</span><span class="punctuation">,</span> <span class="comment">// jot down ip address</span></span><br><span class="line">      <span class="attr">&quot;IPv6Address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;lb-overnet&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;overnet-endpoint&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;EndpointID&quot;</span><span class="punctuation">:</span> <span class="string">&quot;45c5d95a4d21eadcd2f99d0ff982ec4bc6d0c6a7f136136a93aeeb8c7d959898&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;MacAddress&quot;</span><span class="punctuation">:</span> <span class="string">&quot;02:42:0a:00:01:06&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;IPv4Address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10.0.1.6/24&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;IPv6Address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>switch to the other node, exec into the container by <code>docker container exec -it &lt;container&gt; sh</code>, <code>ping 10.0.1.4</code>, check success.</p>
<h3 id="MACVLAN"><a href="#MACVLAN" class="headerlink" title="MACVLAN"></a>MACVLAN</h3><p>Containers also need to talk to VMs or physicals on existing VLANs.</p>
<p>Gives every container its own IP address and MAC address on the existing network (directly on the wire, no bridges, no port mapping)</p>
<p>requires promiscuous mode on the host. (cloud providers generally don’t allow. look for IPVLAN instead, which doesn’t require promiscuous mode)</p>
<h2 id="Network-services"><a href="#Network-services" class="headerlink" title="Network services"></a>Network services</h2><ul>
<li><p>Service discovery: locate services in a swarm</p>
</li>
<li><p>Load Balancing: access a service from any node in swarm (even nodes not hosting the service)</p>
</li>
</ul>
<h3 id="Service-discovery"><a href="#Service-discovery" class="headerlink" title="Service discovery"></a>Service discovery</h3><p>Every service gets a name, registered with swarm DNS, uses swarm DNS</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker service create -d --name ping --network &lt;overlay&gt; --replicas 3 alpine <span class="built_in">sleep</span> 1d</span><br><span class="line">$ docker service create -d --name pong --network &lt;overlay&gt; --replicas 3 alpine <span class="built_in">sleep</span> 1d</span><br></pre></td></tr></table></figure>
<p>check <code>docker service ls</code> to confirm (also check <code>docker container ls</code>), can locate other service in same overlay network by name, e.x.:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker container <span class="built_in">exec</span> -it &lt;container&gt; sh</span><br><span class="line">$ ping pong <span class="comment"># sucesss</span></span><br><span class="line">$ ping -c 2 pong <span class="comment"># -c 2: only two ping attempts.</span></span><br></pre></td></tr></table></figure>
<h3 id="Load-Balancing"><a href="#Load-Balancing" class="headerlink" title="Load Balancing"></a>Load Balancing</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ docker service create -d --name web --network overnet --replicas 1 -p 8080:80 nginx</span><br><span class="line">$ docker service inspect web --pretty</span><br><span class="line">Ports:</span><br><span class="line"> PublishedPort = 8080 <span class="comment">#</span></span><br><span class="line">  Protocol = tcp</span><br><span class="line">  TargetPort = 80 <span class="comment">#</span></span><br><span class="line">  PublishMode = ingress <span class="comment"># default mode</span></span><br></pre></td></tr></table></figure>
<p>ingress mode: publish a port on every node in the swarm — even nodes not running service replicas. then can access by any node in the network by port 8080.</p>
<p>The alternative mode is host mode which only publishes the service on swarm nodes running replicas. by adding mode=host to the —publish output, using —mode global instead of —replicas=5, since only one service task can bind a given port on a given node.</p>
<h1 id="Volumes"><a href="#Volumes" class="headerlink" title="Volumes"></a>Volumes</h1><p>running a new container automatically gets its own non-persistent, ephemeral graph driver storage (copy-on-write union mount, /var/lib/docker). However, volume is to store persistent data, entirely decoupled from containers, seamlessly plugs into containers.</p>
<p>a directory on the docker(also remote hosts or cloud providers by volume drivers), mounted into container at a specific mount point.</p>
<p>can exist not only on local storage of docker host, but also on high-end external systems like SAN and NAS. Pluggable by docker store drive.</p>
<h2 id="Create-Volumes"><a href="#Create-Volumes" class="headerlink" title="Create Volumes"></a>Create Volumes</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker volume create &lt;volume&gt;</span><br></pre></td></tr></table></figure>
<h2 id="Check-status-2"><a href="#Check-status-2" class="headerlink" title="Check status"></a>Check status</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker volume <span class="built_in">ls</span></span><br><span class="line">$ docker volume inspect &lt;volume&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;CreatedAt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2020-06-10T16:29:30Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Driver&quot;</span><span class="punctuation">:</span> <span class="string">&quot;local&quot;</span><span class="punctuation">,</span> <span class="comment">// default</span></span><br><span class="line">    <span class="attr">&quot;Labels&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Mountpoint&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/var/lib/docker/volumes/myvol/_data&quot;</span><span class="punctuation">,</span> <span class="comment">// inspect by ls -l /var/lib/docker/volumes/</span></span><br><span class="line">    <span class="attr">&quot;Name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;myvol&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Scope&quot;</span><span class="punctuation">:</span> <span class="string">&quot;local&quot;</span> <span class="comment">//</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>
<h2 id="Delete-volume"><a href="#Delete-volume" class="headerlink" title="Delete volume"></a>Delete volume</h2><p>to delete a specific volume:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker volume <span class="built_in">rm</span> &lt;volume&gt;</span><br></pre></td></tr></table></figure>
<p>rm an in-use volume causes error message.</p>
<p>to delete all unused volumes:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker volume prune <span class="comment"># delete unused volume</span></span><br></pre></td></tr></table></figure>
<h2 id="Attach-volume"><a href="#Attach-volume" class="headerlink" title="Attach volume"></a>Attach volume</h2><p>to attach volume to a container, either by —mount or -v:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d --name &lt;container&gt; --mount <span class="built_in">source</span>=&lt;volume&gt;,target=/vol &lt;image&gt;</span><br><span class="line">$ docker run -d --name &lt;container&gt; -v &lt;volume&gt;:/vol &lt;image&gt;</span><br></pre></td></tr></table></figure>
<p>note:</p>
<ul>
<li><code>source=&lt;volume&gt;</code>: if volume doesn’t exist for now, will be created.</li>
<li><code>target=/vol</code>: where in the container to mount it, check by exec into container and <code>ls -l /vol/</code></li>
<li>if the container has files or directories in the directory to be mounted, the directory’s contents are copied into the volume.</li>
</ul>
<p>check by <code>docker inspect &lt;container&gt;</code>:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;Mounts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;volume&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;myvol&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/var/lib/docker/volumes/myvol/_data&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Destination&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/vol&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Driver&quot;</span><span class="punctuation">:</span> <span class="string">&quot;local&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;RW&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Propagation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>
<p>Then, container can write data to <code>/vol</code> (e.x. <code>echo &quot;some data&quot; &gt; /vol/newfile</code>), accessible in <code>/var/lib/docker/volumes/</code> as well, even if the container is removed.</p>
<p>—mount works with service as well.</p>
<p>Also useful in Dockerfile’s volume instruction.</p>
<h2 id="Volume-for-service"><a href="#Volume-for-service" class="headerlink" title="Volume for service"></a>Volume for service</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ docker service create -d \</span><br><span class="line">  --replicas=4 \</span><br><span class="line">  --name &lt;service&gt; \</span><br><span class="line">  --mount <span class="built_in">source</span>=myvol,target=/app \</span><br><span class="line">  &lt;image&gt;</span><br></pre></td></tr></table></figure>
<p>note:</p>
<ul>
<li>docker service create command does not support the -v or —volume</li>
</ul>
<h2 id="Read-only-volume"><a href="#Read-only-volume" class="headerlink" title="Read only volume"></a>Read only volume</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d \</span><br><span class="line">  --name=nginxtest \</span><br><span class="line">  --mount <span class="built_in">source</span>=nginx-vol,destination=/usr/share/nginx/html,<span class="built_in">readonly</span> \</span><br><span class="line">  nginx:latest</span><br></pre></td></tr></table></figure>
<p>verfify by <code>docker inspect nginxtest</code>:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;Mounts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;volume&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nginx-vol&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/var/lib/docker/volumes/nginx-vol/_data&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Destination&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/usr/share/nginx/html&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Driver&quot;</span><span class="punctuation">:</span> <span class="string">&quot;local&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;RW&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span> <span class="comment">//</span></span><br><span class="line">    <span class="attr">&quot;Propagation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>
<h1 id="Secrets"><a href="#Secrets" class="headerlink" title="Secrets"></a>Secrets</h1><p>string &lt;= 500k, swarm mode for services only(not containers)</p>
<p><img src="/photos/docker-note/secret.png" alt="secret"></p>
<p>note:<br>/run/secrets/: stay in memory</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker secret create &lt;secret&gt; &lt;file&gt;</span><br></pre></td></tr></table></figure>
<p>check by <code>docker secret ls</code>. inspect by <code>docker secret inspect &lt;secret&gt;</code></p>
<p>create a service, using secret:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker service create -d --name &lt;service&gt; --secret &lt;secret&gt; --replicas 2 ...</span><br></pre></td></tr></table></figure>
<p>inpect by <code>docker service inspect &lt;service&gt;</code> and look at secrets section. exec into containers by <code>docker container exec -it &lt;container&gt; sh</code>, find secret by <code>ls -l /run/secrets</code>, accessible</p>
<p>can’t delete an in-use secret by <code>docker secret rm &lt;secret&gt;</code>, need to delete service first.</p>
<h1 id="Docker-Compose-and-Stack"><a href="#Docker-Compose-and-Stack" class="headerlink" title="Docker Compose and Stack"></a>Docker Compose and Stack</h1><h2 id="Docker-compose"><a href="#Docker-compose" class="headerlink" title="Docker compose"></a>Docker compose</h2><h3 id="Install-on-linux"><a href="#Install-on-linux" class="headerlink" title="Install on linux"></a>Install on linux</h3><ol>
<li>Download the current stable release of Docker Compose:</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -L <span class="string">&quot;https://github.com/docker/compose/releases/download/1.26.0/docker-compose-<span class="subst">$(uname -s)</span>-<span class="subst">$(uname -m)</span>&quot;</span> -o /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure>
<ol>
<li>Make it executable:</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">chmod</span> +x /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure>
<h3 id="Compose-files"><a href="#Compose-files" class="headerlink" title="Compose files"></a>Compose files</h3><p>Compose uses YAML files to define multi-service applications.</p>
<p>The default name for the Compose YAML file is docker-compose.yml</p>
<p>Flask app example:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.5&quot;</span> <span class="comment"># mandatory</span></span><br><span class="line"><span class="attr">services:</span> <span class="comment"># application services</span></span><br><span class="line">  <span class="attr">web-fe:</span> <span class="comment"># create a web front-end container called web-fe</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span> <span class="comment"># build a new image by Dockerfile in &#x27;.&#x27; to create container for web-fe</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">python</span> <span class="string">app.py</span> <span class="comment"># Override CMD in Dockerfile, which has Python and app.py</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">target:</span> <span class="number">5000</span> <span class="comment"># container port</span></span><br><span class="line">        <span class="attr">published:</span> <span class="number">5000</span> <span class="comment"># host port</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">counter-net</span> <span class="comment"># already exist or to be defined</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">volume</span></span><br><span class="line">      <span class="attr">source:</span> <span class="string">counter-vol</span> <span class="comment"># already exist or to be defined</span></span><br><span class="line">      <span class="attr">target:</span> <span class="string">/code</span> <span class="comment"># mount to container</span></span><br><span class="line">  <span class="attr">redis:</span> <span class="comment"># create an in-memory database container called redis</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;redis:alpine&quot;</span> <span class="comment"># pulled from Docker Hub.</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="attr">counter-net:</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">networks:</span> <span class="comment"># create new networks, bridge by default</span></span><br><span class="line">    <span class="attr">counter-net:</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">volumes:</span> <span class="comment"># create new volumes</span></span><br><span class="line">    <span class="attr">counter-vol:</span></span><br></pre></td></tr></table></figure>
<p>note:</p>
<ul>
<li>4 top-level keys: version, services, networks, volumes, (secrets, configs…)</li>
<li>use the driver property to specify different network types:</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">over-net:</span></span><br><span class="line">  <span class="attr">driver:</span> <span class="string">overlay</span></span><br><span class="line">  <span class="attr">attachable:</span> <span class="literal">true</span> <span class="comment"># for standalone containers(instead of Docker Services)</span></span><br></pre></td></tr></table></figure>
<p>source: <a target="_blank" rel="noopener" href="https://github.com/nigelpoulton/counter-app">https://github.com/nigelpoulton/counter-app</a></p>
<h3 id="Run-compose-app"><a href="#Run-compose-app" class="headerlink" title="Run compose app"></a>Run compose app</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ docker-compose up <span class="comment"># docker-compose.yml in current folder</span></span><br><span class="line">$ docker-compose up &amp; <span class="comment"># ctrl+c doesn&#x27;t kill container</span></span><br><span class="line">$ docker-compose up -d <span class="comment"># run in daemon</span></span><br><span class="line">$ docker-compose -f prod-equus-bass.yml up <span class="comment"># -f flag</span></span><br></pre></td></tr></table></figure>
<p>check the current state of the app by <code>docker-compose ps</code>.</p>
<p>list the processes running inside of each<br>service (container) by <code>docker-compose top</code>.</p>
<h3 id="Stop-Restart-and-Delete-App"><a href="#Stop-Restart-and-Delete-App" class="headerlink" title="Stop, Restart and Delete App"></a>Stop, Restart and Delete App</h3><p>stop without deleting:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker-compose stop</span><br></pre></td></tr></table></figure>
<p>could restart by:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker-compose restart</span><br></pre></td></tr></table></figure>
<p>If changed app after stopping, these changes won’t apply in restarted app. Need to re-deploy.</p>
<p>delete a stopped Compose app and networks:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker-compose <span class="built_in">rm</span></span><br></pre></td></tr></table></figure>
<p>stop and delete containers and networks by:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker-compose down</span><br></pre></td></tr></table></figure>
<h2 id="Stack"><a href="#Stack" class="headerlink" title="Stack"></a>Stack</h2><p>swarm only</p>
<p>stacks manage a bunch of services as a single app, highest layer of docker application hierarchy.</p>
<p><img src="/photos/docker-note/stack.png" alt="stack"></p>
<p>can run on Docker CLI, Docker UCP, Docker Cloud.</p>
<p>docker-stack.yml: YAML config file including <strong>version</strong>, <strong>services</strong>, <strong>network</strong>, <strong>volumes</strong>, documenting the app. Can do version control.</p>
<p><img src="/photos/docker-note/stack_file.png" alt="stack_file"></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3&quot;</span> <span class="comment"># &gt;=3</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">redis:</span> <span class="comment"># service 1st</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:alpine</span> <span class="comment">#</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">frontend</span></span><br><span class="line">    <span class="attr">deploy:</span> <span class="comment"># new in version 3</span></span><br><span class="line">      <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">update_config:</span></span><br><span class="line">        <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">restart_policy:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">on-failure</span></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres:9.4</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">POSTGRES_USER:</span> <span class="string">&quot;postgres&quot;</span></span><br><span class="line">      <span class="attr">POSTGRES_PASSWORD:</span> <span class="string">&quot;postgres&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db-data:/var/lib/postgresql/data</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">backend</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">placement:</span></span><br><span class="line">        <span class="attr">constraints:</span> [<span class="string">node.role</span> <span class="string">==</span> <span class="string">manager</span>] <span class="comment"># only run on manager nodes</span></span><br><span class="line">  <span class="attr">vote:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">dockersamples/examplevotingapp_vote:before</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">5000</span><span class="string">:80</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">frontend</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">update_config:</span></span><br><span class="line">        <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">restart_policy:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">on-failure</span></span><br><span class="line">  <span class="attr">result:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">dockersamples/examplevotingapp_result:before</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">5001</span><span class="string">:80</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">backend</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">update_config:</span></span><br><span class="line">        <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">restart_policy:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">on-failure</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">worker:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">dockersamples/examplevotingapp_worker</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">frontend</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">backend</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">replicated</span></span><br><span class="line">      <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">labels:</span> [<span class="string">APP=VOTING</span>]</span><br><span class="line">      <span class="attr">restart_policy:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">on-failure</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">10s</span></span><br><span class="line">        <span class="attr">max_attempts:</span> <span class="number">3</span></span><br><span class="line">        <span class="attr">window:</span> <span class="string">120s</span></span><br><span class="line">      <span class="attr">placement:</span></span><br><span class="line">        <span class="attr">constraints:</span> [<span class="string">node.role</span> <span class="string">==</span> <span class="string">manager</span>]</span><br><span class="line"></span><br><span class="line">  <span class="attr">visualizer:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">dockersamples/visualizer:stable</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">    <span class="attr">stop_grace_period:</span> <span class="string">1m30s</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/var/run/docker.sock:/var/run/docker.sock&quot;</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">placement:</span></span><br><span class="line">        <span class="attr">constraints:</span> [<span class="string">node.role</span> <span class="string">==</span> <span class="string">manager</span>]</span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">frontend:</span></span><br><span class="line">  <span class="attr">backend:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">db-data:</span></span><br></pre></td></tr></table></figure>
<p>source: <a target="_blank" rel="noopener" href="https://github.com/dockersamples/example-voting-app/docker-stack.yml">https://github.com/dockersamples/example-voting-app/docker-stack.yml</a></p>
<p>Check <a target="_blank" rel="noopener" href="https://docs.docker.com/compose/compose-file/">Compose file version 3 reference</a></p>
<p>Placement constraints:</p>
<ul>
<li>Node ID: node.id == o2p4kw2uuw2a</li>
<li>Node name: node.hostname == wrk-12</li>
<li>Role: node.role != manager</li>
<li>Engine labels: engine.labels.operatingsystem==ubuntu 16.04</li>
<li>Custom node labels: node.labels.zone == prod1 <strong>zone: prod1</strong></li>
</ul>
<p><code>service.&lt;service&gt;.deploy.update_config</code>:<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">update_config:</span></span><br><span class="line">  <span class="attr">parallelism:</span> <span class="number">2</span> <span class="comment"># update two replicas at-atime</span></span><br><span class="line">  <span class="attr">failure_action:</span> <span class="string">rollback</span> <span class="comment"># [pause, continue, rollback]</span></span><br></pre></td></tr></table></figure></p>
<p><code>services.&lt;service&gt;.deploy.restart-policy</code>:<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">restart_policy:</span></span><br><span class="line">  <span class="attr">condition:</span> <span class="string">on-failure</span> <span class="comment"># non-zero exit code</span></span><br><span class="line">  <span class="attr">delay:</span> <span class="string">5s</span> <span class="comment"># between each of the restart attempts</span></span><br><span class="line">  <span class="attr">max_attempts:</span> <span class="number">3</span> </span><br><span class="line">  <span class="attr">window:</span> <span class="string">120s</span> <span class="comment"># wait up to 120 seconds to decide if the restart worked</span></span><br></pre></td></tr></table></figure></p>
<p><code>services.&lt;service&gt;.stop_grace_period</code>:<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">stop_grace_period:</span> <span class="string">1m30s</span> <span class="comment"># for PID 1 to handle SIGTERM, default 10s, then SIGKILL.</span></span><br></pre></td></tr></table></figure></p>
<h3 id="Deploy-the-stack"><a href="#Deploy-the-stack" class="headerlink" title="Deploy the stack"></a>Deploy the stack</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker stack deploy -c &lt;stackfile&gt; &lt;stack&gt; <span class="comment"># -c: --compose-file</span></span><br></pre></td></tr></table></figure>
<h3 id="Check-status-3"><a href="#Check-status-3" class="headerlink" title="Check status"></a>Check status</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker stack <span class="built_in">ls</span></span><br><span class="line">$ docker stack ps &lt;stack&gt;</span><br><span class="line">$ docker stack services &lt;stack&gt;</span><br></pre></td></tr></table></figure>
<h3 id="Update-stack"><a href="#Update-stack" class="headerlink" title="Update stack"></a>Update stack</h3><p>update config file, and re-deploy by:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker stack deploy -c &lt;stackfile&gt; &lt;stack&gt;</span><br></pre></td></tr></table></figure>
<p>will update every service in the stack.</p>
<h1 id="Enterprise-Edition-EE"><a href="#Enterprise-Edition-EE" class="headerlink" title="Enterprise Edition(EE)"></a>Enterprise Edition(EE)</h1><ul>
<li>a hardened Docker Engine</li>
<li>Ops UI</li>
<li>Secure on-premises registry</li>
</ul>
<p><img src="/photos/docker-note/EECE.png" alt="EECE"></p>
<h2 id="Universal-Control-Plane-UCP"><a href="#Universal-Control-Plane-UCP" class="headerlink" title="Universal Control Plane(UCP)"></a>Universal Control Plane(UCP)</h2><p>based on EE, the operations GUI from Docker Inc, to manage swarm and k8s apps.</p>
<p><img src="/photos/docker-note/UCP.png" alt="UCP"></p>
<h2 id="Docker-Trusted-Registry-DTR"><a href="#Docker-Trusted-Registry-DTR" class="headerlink" title="Docker Trusted Registry(DTR)"></a>Docker Trusted Registry(DTR)</h2><p>based on EE and UCP, a registry to store images, a containerized app.</p>
<p><img src="/photos/docker-note/DTR.png" alt="DTR"></p>
<h2 id="Role-based-Access-Control-RBAC"><a href="#Role-based-Access-Control-RBAC" class="headerlink" title="Role-based Access Control(RBAC)"></a>Role-based Access Control(RBAC)</h2><ul>
<li>subject: user, team</li>
<li>role: permissions</li>
<li>collection: resources(docker node)</li>
</ul>
<p><img src="/photos/docker-note/RBAC.png" alt="RBAC"></p>
<h2 id="Image-scanning"><a href="#Image-scanning" class="headerlink" title="Image scanning"></a>Image scanning</h2><p>after update the image in local, need to push into registry.</p>
<p>Tag the updated image:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker image tag &lt;image&gt; &lt;dtr-dns&gt;/&lt;repo&gt;/&lt;image&gt;:latest</span><br></pre></td></tr></table></figure>
<p>check by <code>docker image ls</code> to see a new tagged image.</p>
<p>login:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$  docker login &lt;dtr-dns&gt; <span class="comment"># username, passwork, user needs permission to write in the repo</span></span><br></pre></td></tr></table></figure>
<p>ensure image scanning sets to “scan on push” in UCP’s DTR’s repo setting. Then push:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker image push &lt;tagged-image&gt;</span><br></pre></td></tr></table></figure>
<p>Check in DTR’s repo’s images’ vulnerabilities field.</p>
<h2 id="HTTP-Routing-Mesh-HRM"><a href="#HTTP-Routing-Mesh-HRM" class="headerlink" title="HTTP Routing Mesh(HRM)"></a>HTTP Routing Mesh(HRM)</h2><p>For Docker CE’s Routing Mesh(Swarm-mode Routing Mesh), Transport layer(L4).</p>
<p><img src="/photos/docker-note/routing_mesh.png" alt="routing_mesh"></p>
<p>For Docker EE’s HRM, Application layer(L7). Route based on host header.</p>
<p><img src="/photos/docker-note/HRM.png" alt="HRM"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://xyshell.github.io/2020/06/08/docker-note/" data-id="clywj85g4000ft895htg76gk2" class="article-share-link">
        Share
      </a>
      
<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/" rel="tag">docker</a></li></ul>

    </footer>

  </div>

  

  

</article>
    
    <article id="post-aws-note" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      
  
  <h2 class="article-title" itemprop="name">
    <a href="/2020/06/08/aws-note/">AWS Note</a>
  </h2>
  
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/06/08/aws-note/" class="article-date">
  <time datetime="2020-06-08T06:30:49.000Z" itemprop="datePublished">2020-06-08</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
        <h1 id="AWS-Basics"><a href="#AWS-Basics" class="headerlink" title="AWS Basics"></a>AWS Basics</h1><h2 id="AWS-website"><a href="#AWS-website" class="headerlink" title="AWS website"></a>AWS website</h2><p><a target="_blank" rel="noopener" href="https://infrastructure.aws/">infrastructure.aws</a></p>
<p><a target="_blank" rel="noopener" href="http://awstcocalculator.com/">TCO(total cost of ownership) Calculator</a></p>
<p><a target="_blank" rel="noopener" href="https://calculator.aws/#/">Pricing Calculator</a></p>
<h2 id="Install"><a href="#Install" class="headerlink" title="Install"></a>Install</h2><h3 id="AWS-CLI-and-Boto3"><a href="#AWS-CLI-and-Boto3" class="headerlink" title="AWS CLI and Boto3"></a>AWS CLI and Boto3</h3><h4 id="Amazon-Linux-2"><a href="#Amazon-Linux-2" class="headerlink" title="Amazon Linux 2"></a>Amazon Linux 2</h4><p>The AWS CLI is already installed on Amazon Linux 2.</p>
<p>Install Python 3:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> yum install -y python3-pip python3 python3-setuptools</span><br></pre></td></tr></table></figure>
<p>Install Boto3:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install boto3 --user</span><br></pre></td></tr></table></figure>
<h4 id="macOS"><a href="#macOS" class="headerlink" title="macOS"></a>macOS</h4><p>Install Python3 using Homebrew:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ruby -e <span class="string">&quot;<span class="subst">$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)</span>&quot;</span></span><br></pre></td></tr></table></figure>
<p>Install Python 3:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install python</span><br></pre></td></tr></table></figure>
<p>Insert the Homebrew Python directory at the top of your PATH environment variable:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=<span class="string">&quot;/usr/local/opt/python/libexec/bin:<span class="variable">$PATH</span>&quot;</span></span><br></pre></td></tr></table></figure>
<p>Verify you are using Python 3:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python --version</span><br></pre></td></tr></table></figure>
<p>Install the AWS CLI and Boto3:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install awscli boto3 --upgrade --user</span><br></pre></td></tr></table></figure>
<h3 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> amazon-linux-extras install docker</span><br></pre></td></tr></table></figure>
<h2 id="Configuring-your-AWS-environment"><a href="#Configuring-your-AWS-environment" class="headerlink" title="Configuring your AWS environment"></a>Configuring your AWS environment</h2><p>Obtain your AWS access key and secret access key from the AWS Management Console. Run the following command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws configure</span><br></pre></td></tr></table></figure>
<p>This sets up a text file that the AWS CLI and Boto3 libraries look at by default for your credentials: <code>~/.aws/credentials</code>.</p>
<p>The file should look like this:</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[default]</span><br><span class="line">aws_access_key_id = AKIAIOSFODNN7EXAMPLE</span><br><span class="line">aws_secret_access_key = wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY</span><br></pre></td></tr></table></figure>
<h2 id="Test-Your-Credentials"><a href="#Test-Your-Credentials" class="headerlink" title="Test Your Credentials"></a>Test Your Credentials</h2><p>AWS CLI<br>Run the following command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws sts get-caller-identity</span><br></pre></td></tr></table></figure>
<p>The output should look like this:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;UserId&quot;</span>: <span class="string">&quot;AIDAJKLMNOPQRSTUVWXYZ&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Account&quot;</span>: <span class="string">&quot;123456789012&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Arn&quot;</span>: <span class="string">&quot;arn:aws:iam::123456789012:userdevuser&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="AWS-CLI"><a href="#AWS-CLI" class="headerlink" title="AWS CLI"></a>AWS CLI</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aws configure</span><br><span class="line">aws sts get-caller-identity</span><br></pre></td></tr></table></figure>
<h2 id="S3"><a href="#S3" class="headerlink" title="S3"></a>S3</h2><p>Upload folder to s3:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws s3 <span class="built_in">cp</span> &lt;path-to-source-folder&gt; s3://&lt;path-to-target-folder&gt; --recursive --exclude <span class="string">&quot;.DS_Store&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="Dynamodb"><a href="#Dynamodb" class="headerlink" title="Dynamodb"></a>Dynamodb</h2><p>create table:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">aws dynamodb create-table \</span><br><span class="line">    --table-name Music \</span><br><span class="line">    --key-schema AttributeName=Artist,KeyType=HASH \</span><br><span class="line">                 AttributeName=SongTitle,KeyType=RANGE \</span><br><span class="line">    --attribute-definitions \</span><br><span class="line">        AttributeName=Artist,AttributeType=S \</span><br><span class="line">        AttributeName=SongTitle,AttributeType=S \</span><br><span class="line">    --provisioned-throughput \</span><br><span class="line">        ReadCapacityUnits=5,WriteCapacityUnits=5</span><br></pre></td></tr></table></figure>
<p>describe table:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws dynamodb describe-table --table-name Music</span><br></pre></td></tr></table></figure>
<p>put item:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">aws dynamodb put-item \</span><br><span class="line">    --table-name Music \</span><br><span class="line">    --item <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">        &quot;Artist&quot;: &#123;&quot;S&quot;: &quot;Dream Theater&quot;&#125;,</span></span><br><span class="line"><span class="string">        &quot;AlbumTitle&quot;: &#123;&quot;S&quot;: &quot;Images and Words&quot;&#125;,</span></span><br><span class="line"><span class="string">        &quot;SongTitle&quot;: &#123;&quot;S&quot;: &quot;Under a Glass Moon&quot;&#125; &#125;&#x27;</span></span><br></pre></td></tr></table></figure>
<p>scan table:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws dynamodb scan --table-name Music</span><br></pre></td></tr></table></figure>
<h1 id="Boto3-EC2"><a href="#Boto3-EC2" class="headerlink" title="Boto3 - EC2"></a>Boto3 - EC2</h1><p>This section follows <a target="_blank" rel="noopener" href="https://github.com/linuxacademy/content-dynamodb-deepdive">https://github.com/linuxacademy/content-dynamodb-deepdive</a></p>
<h2 id="HelloWorld"><a href="#HelloWorld" class="headerlink" title="HelloWorld"></a>HelloWorld</h2><h3 id="List-all-S3-bucket-name"><a href="#List-all-S3-bucket-name" class="headerlink" title="List all S3 bucket name:"></a>List all S3 bucket name:</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line">s3 = boto3.resource(<span class="string">&#x27;s3&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> bucket <span class="keyword">in</span> s3.buckets.<span class="built_in">all</span>():</span><br><span class="line">    <span class="built_in">print</span>(bucket.name)</span><br></pre></td></tr></table></figure>
<h3 id="Spin-up-an-ec2-instance"><a href="#Spin-up-an-ec2-instance" class="headerlink" title="Spin up an ec2 instance"></a>Spin up an ec2 instance</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line">ec2 = boto3.client(<span class="string">&#x27;ec2&#x27;</span>)</span><br><span class="line">response = ec2.run_instances(</span><br><span class="line">    ImageId=<span class="string">&#x27;ami-0947d2ba12ee1ff75&#x27;</span>, <span class="comment"># Amazon Linux 2 AMI (HVM), SSD Volume Type</span></span><br><span class="line">    InstanceType=<span class="string">&#x27;t2.micro&#x27;</span>,</span><br><span class="line">    KeyName=<span class="string">&#x27;xyshell&#x27;</span>,</span><br><span class="line">    MinCount=<span class="number">1</span>,</span><br><span class="line">    MaxCount=<span class="number">1</span>,</span><br><span class="line">    SubnetId=<span class="string">&#x27;subnet-05b78e3323bcabddc&#x27;</span></span><br><span class="line">)</span><br><span class="line"><span class="built_in">print</span>(response[<span class="string">&#x27;Instances&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;InstanceId&#x27;</span>])</span><br></pre></td></tr></table></figure>
<h2 id="Stopping-EC2-Instances-Nightly"><a href="#Stopping-EC2-Instances-Nightly" class="headerlink" title="Stopping EC2 Instances Nightly"></a>Stopping EC2 Instances Nightly</h2><p><img src="/photos/aws-note/Stopping-EC2-Instances-Nightly.png" alt="Stopping-EC2-Instances-Nightly.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># lambda_function.py</span></span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line">    ec2_client = boto3.client(<span class="string">&#x27;ec2&#x27;</span>)</span><br><span class="line">    <span class="comment"># get list of regions</span></span><br><span class="line">    regions = [region[<span class="string">&#x27;RegionName&#x27;</span>] <span class="keyword">for</span> region <span class="keyword">in</span> ec2_client.describe_regions()[<span class="string">&#x27;Regions&#x27;</span>]]</span><br><span class="line">    <span class="comment"># iterate over each region</span></span><br><span class="line">    <span class="keyword">for</span> region <span class="keyword">in</span> regions:</span><br><span class="line">        ec2 = boto3.resource(<span class="string">&#x27;ec2&#x27;</span>, region_name=region)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Region:&#x27;</span>, region)</span><br><span class="line">        <span class="comment"># get only running instances</span></span><br><span class="line">        instances = ec2.instances.<span class="built_in">filter</span>(</span><br><span class="line">            Filters=[</span><br><span class="line">                &#123;<span class="string">&#x27;Name&#x27;</span>: <span class="string">&#x27;instance-state-name&#x27;</span>,</span><br><span class="line">                 <span class="string">&#x27;Values&#x27;</span>: [<span class="string">&#x27;running&#x27;</span>]&#125;</span><br><span class="line">            ]</span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># stop instances</span></span><br><span class="line">        <span class="keyword">for</span> instance <span class="keyword">in</span> instances:</span><br><span class="line">            instance.stop()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;stopped instance:&#x27;</span>, instance.<span class="built_in">id</span>)</span><br></pre></td></tr></table></figure>
<h2 id="Backing-Up-EC2-Instances"><a href="#Backing-Up-EC2-Instances" class="headerlink" title="Backing Up EC2 Instances"></a>Backing Up EC2 Instances</h2><p><img src="/photos/aws-note/Backing-Up-EC2-Instances.png" alt="Backing-Up-EC2-Instances"></p>
<h3 id="Create-Backups"><a href="#Create-Backups" class="headerlink" title="Create-Backups"></a>Create-Backups</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line"></span><br><span class="line">    ec2_client = boto3.client(<span class="string">&#x27;ec2&#x27;</span>)</span><br><span class="line">    regions = [region[<span class="string">&#x27;RegionName&#x27;</span>]</span><br><span class="line">               <span class="keyword">for</span> region <span class="keyword">in</span> ec2_client.describe_regions()[<span class="string">&#x27;Regions&#x27;</span>]]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> region <span class="keyword">in</span> regions:</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Instances in EC2 Region &#123;0&#125;:&#x27;</span>.<span class="built_in">format</span>(region))</span><br><span class="line">        ec2 = boto3.resource(<span class="string">&#x27;ec2&#x27;</span>, region_name=region)</span><br><span class="line"></span><br><span class="line">        instances = ec2.instances.<span class="built_in">filter</span>(</span><br><span class="line">            Filters=[</span><br><span class="line">                &#123;<span class="string">&#x27;Name&#x27;</span>: <span class="string">&#x27;tag:backup&#x27;</span>, <span class="string">&#x27;Values&#x27;</span>: [<span class="string">&#x27;true&#x27;</span>]&#125;</span><br><span class="line">            ]</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ISO 8601 timestamp, i.e. 2019-01-31T14:01:58</span></span><br><span class="line">        timestamp = datetime.utcnow().replace(microsecond=<span class="number">0</span>).isoformat()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> instances.<span class="built_in">all</span>():</span><br><span class="line">            <span class="keyword">for</span> v <span class="keyword">in</span> i.volumes.<span class="built_in">all</span>():</span><br><span class="line"></span><br><span class="line">                desc = <span class="string">&#x27;Backup of &#123;0&#125;, volume &#123;1&#125;, created &#123;2&#125;&#x27;</span>.<span class="built_in">format</span>(</span><br><span class="line">                    i.<span class="built_in">id</span>, v.<span class="built_in">id</span>, timestamp)</span><br><span class="line">                <span class="built_in">print</span>(desc)</span><br><span class="line"></span><br><span class="line">                snapshot = v.create_snapshot(Description=desc)</span><br><span class="line"></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Created snapshot:&quot;</span>, snapshot.<span class="built_in">id</span>)</span><br></pre></td></tr></table></figure>
<h3 id="Prune-Backups"><a href="#Prune-Backups" class="headerlink" title="Prune-Backups"></a>Prune-Backups</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line"></span><br><span class="line">    account_id = boto3.client(<span class="string">&#x27;sts&#x27;</span>).get_caller_identity().get(<span class="string">&#x27;Account&#x27;</span>)</span><br><span class="line">    ec2 = boto3.client(<span class="string">&#x27;ec2&#x27;</span>)</span><br><span class="line">    regions = [region[<span class="string">&#x27;RegionName&#x27;</span>]</span><br><span class="line">               <span class="keyword">for</span> region <span class="keyword">in</span> ec2.describe_regions()[<span class="string">&#x27;Regions&#x27;</span>]]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> region <span class="keyword">in</span> regions:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Region:&quot;</span>, region)</span><br><span class="line">        ec2 = boto3.client(<span class="string">&#x27;ec2&#x27;</span>, region_name=region)</span><br><span class="line">        response = ec2.describe_snapshots(OwnerIds=[account_id])</span><br><span class="line">        snapshots = response[<span class="string">&quot;Snapshots&quot;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Sort snapshots by date ascending</span></span><br><span class="line">        snapshots.sort(key=<span class="keyword">lambda</span> x: x[<span class="string">&quot;StartTime&quot;</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Remove snapshots we want to keep (i.e. 3 most recent)</span></span><br><span class="line">        snapshots = snapshots[:-<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> snapshot <span class="keyword">in</span> snapshots:</span><br><span class="line">            <span class="built_in">id</span> = snapshot[<span class="string">&#x27;SnapshotId&#x27;</span>]</span><br><span class="line">            <span class="keyword">try</span>: <span class="comment"># EBS might be using this snapshot</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Deleting snapshot:&quot;</span>, <span class="built_in">id</span>)</span><br><span class="line">                ec2.delete_snapshot(SnapshotId=<span class="built_in">id</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Snapshot &#123;&#125; in use, skipping.&quot;</span>.<span class="built_in">format</span>(<span class="built_in">id</span>))</span><br><span class="line">                <span class="keyword">continue</span></span><br></pre></td></tr></table></figure>
<h3 id="Removing-Unattached-EBS-Volumes"><a href="#Removing-Unattached-EBS-Volumes" class="headerlink" title="Removing Unattached EBS Volumes"></a>Removing Unattached EBS Volumes</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params"><span class="built_in">object</span>, context</span>):</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Get list of regions</span></span><br><span class="line">    ec2_client = boto3.client(<span class="string">&#x27;ec2&#x27;</span>)</span><br><span class="line">    regions = [region[<span class="string">&#x27;RegionName&#x27;</span>]</span><br><span class="line">               <span class="keyword">for</span> region <span class="keyword">in</span> ec2_client.describe_regions()[<span class="string">&#x27;Regions&#x27;</span>]]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> region <span class="keyword">in</span> regions:</span><br><span class="line">        ec2 = boto3.resource(<span class="string">&#x27;ec2&#x27;</span>, region_name=region)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Region:&quot;</span>, region)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># List only unattached volumes (&#x27;available&#x27; vs. &#x27;in-use&#x27;)</span></span><br><span class="line">        volumes = ec2.volumes.<span class="built_in">filter</span>(</span><br><span class="line">            Filters=[&#123;<span class="string">&#x27;Name&#x27;</span>: <span class="string">&#x27;status&#x27;</span>, <span class="string">&#x27;Values&#x27;</span>: [<span class="string">&#x27;available&#x27;</span>]&#125;])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> volume <span class="keyword">in</span> volumes:</span><br><span class="line">            v = ec2.Volume(volume.<span class="built_in">id</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Deleting EBS volume: &#123;&#125;, Size: &#123;&#125; GiB&quot;</span>.<span class="built_in">format</span>(v.<span class="built_in">id</span>, v.size))</span><br><span class="line">            v.delete()</span><br></pre></td></tr></table></figure>
<h3 id="Deregistering-Old-AMIs"><a href="#Deregistering-Old-AMIs" class="headerlink" title="Deregistering Old AMIs"></a>Deregistering Old AMIs</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> dateutil.parser <span class="keyword">import</span> parse</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">days_old</span>(<span class="params">date</span>):</span><br><span class="line">    parsed = parse(date).replace(tzinfo=<span class="literal">None</span>)</span><br><span class="line">    diff = datetime.datetime.now() - parsed</span><br><span class="line">    <span class="keyword">return</span> diff.days</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Get list of regions</span></span><br><span class="line">    ec2_client = boto3.client(<span class="string">&#x27;ec2&#x27;</span>)</span><br><span class="line">    regions = [region[<span class="string">&#x27;RegionName&#x27;</span>]</span><br><span class="line">               <span class="keyword">for</span> region <span class="keyword">in</span> ec2_client.describe_regions()[<span class="string">&#x27;Regions&#x27;</span>]]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> region <span class="keyword">in</span> regions:</span><br><span class="line">        ec2 = boto3.client(<span class="string">&#x27;ec2&#x27;</span>, region_name=region)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Region:&quot;</span>, region)</span><br><span class="line"></span><br><span class="line">        amis = ec2.describe_images(Owners=[<span class="string">&#x27;self&#x27;</span>])[<span class="string">&#x27;Images&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> ami <span class="keyword">in</span> amis:</span><br><span class="line">            creation_date = ami[<span class="string">&#x27;CreationDate&#x27;</span>]</span><br><span class="line">            age_days = days_old(creation_date)</span><br><span class="line">            image_id = ami[<span class="string">&#x27;ImageId&#x27;</span>]</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;ImageId: &#123;&#125;, CreationDate: &#123;&#125; (&#123;&#125; days old)&#x27;</span>.<span class="built_in">format</span>(</span><br><span class="line">                image_id, creation_date, age_days))</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> age_days &gt;= <span class="number">2</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;Deleting ImageId:&#x27;</span>, image_id)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># Deregister the AMI</span></span><br><span class="line">                ec2.deregister_image(ImageId=image_id)</span><br></pre></td></tr></table></figure>
<h1 id="Boto3-Dynamodb"><a href="#Boto3-Dynamodb" class="headerlink" title="Boto3 - Dynamodb"></a>Boto3 - Dynamodb</h1><p>This chapter follows <a target="_blank" rel="noopener" href="https://github.com/linuxacademy/content-lambda-boto3">https://github.com/linuxacademy/content-lambda-boto3</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line">client = boto3.client(<span class="string">&#x27;dynamodb&#x27;</span>, endpoint_url=<span class="string">&#x27;http://localhost:8000&#x27;</span>) <span class="comment"># dynamodb-local</span></span><br><span class="line">client.list_tables()</span><br></pre></td></tr></table></figure>
<h3 id="Create-Tables"><a href="#Create-Tables" class="headerlink" title="Create Tables"></a>Create Tables</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">dynamodb = boto3.resource(<span class="string">&#x27;dynamodb&#x27;</span>)</span><br><span class="line"></span><br><span class="line">table = dynamodb.create_table(</span><br><span class="line">    TableName=<span class="string">&#x27;Movies&#x27;</span>,</span><br><span class="line">    KeySchema=[</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&#x27;AttributeName&#x27;</span>: <span class="string">&#x27;year&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;KeyType&#x27;</span>: <span class="string">&#x27;HASH&#x27;</span>  <span class="comment"># Partition key</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&#x27;AttributeName&#x27;</span>: <span class="string">&#x27;title&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;KeyType&#x27;</span>: <span class="string">&#x27;RANGE&#x27;</span>  <span class="comment"># Sort key</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    AttributeDefinitions=[</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&#x27;AttributeName&#x27;</span>: <span class="string">&#x27;year&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;AttributeType&#x27;</span>: <span class="string">&#x27;N&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&#x27;AttributeName&#x27;</span>: <span class="string">&#x27;title&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;AttributeType&#x27;</span>: <span class="string">&#x27;S&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">    ],</span><br><span class="line">    ProvisionedThroughput=&#123;</span><br><span class="line">        <span class="string">&#x27;ReadCapacityUnits&#x27;</span>: <span class="number">5</span>,</span><br><span class="line">        <span class="string">&#x27;WriteCapacityUnits&#x27;</span>: <span class="number">5</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Table status:&#x27;</span>, table.table_status)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Waiting for&#x27;</span>, table.name, <span class="string">&#x27;to complete creating...&#x27;</span>)</span><br><span class="line">table.meta.client.get_waiter(<span class="string">&#x27;table_exists&#x27;</span>).wait(TableName=<span class="string">&#x27;Movies&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Table status:&#x27;</span>, dynamodb.Table(<span class="string">&#x27;Movies&#x27;</span>).table_status)</span><br></pre></td></tr></table></figure>
<h3 id="Load-Data"><a href="#Load-Data" class="headerlink" title="Load Data"></a>Load Data</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">dynamodb = boto3.resource(<span class="string">&#x27;dynamodb&#x27;</span>)</span><br><span class="line"></span><br><span class="line">table = dynamodb.Table(<span class="string">&#x27;Movies&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;moviedata.json&quot;</span>) <span class="keyword">as</span> json_file:</span><br><span class="line">    movies = json.load(json_file, parse_float=decimal.Decimal)</span><br><span class="line">    <span class="keyword">for</span> movie <span class="keyword">in</span> movies:</span><br><span class="line">        year = <span class="built_in">int</span>(movie[<span class="string">&#x27;year&#x27;</span>])</span><br><span class="line">        title = movie[<span class="string">&#x27;title&#x27;</span>]</span><br><span class="line">        info = movie[<span class="string">&#x27;info&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Adding movie:&quot;</span>, year, title)</span><br><span class="line"></span><br><span class="line">        table.put_item(</span><br><span class="line">            Item=&#123;</span><br><span class="line">                <span class="string">&#x27;year&#x27;</span>: year,</span><br><span class="line">                <span class="string">&#x27;title&#x27;</span>: title,</span><br><span class="line">                <span class="string">&#x27;info&#x27;</span>: info,</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br></pre></td></tr></table></figure>
<p><code>moviedata.json</code>:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;year&quot;</span><span class="punctuation">:</span> <span class="number">2013</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Rush&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;info&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;directors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;Ron Howard&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;release_date&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2013-09-02T00:00:00Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;rating&quot;</span><span class="punctuation">:</span> <span class="number">8.3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;genres&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;Action&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Biography&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Drama&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Sport&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;image_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://ia.media-imdb.com/images/M/MV5BMTQyMDE0MTY0OV5BMl5BanBnXkFtZTcwMjI2OTI0OQ@@._V1_SX400_.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;plot&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A re-creation of the merciless 1970s rivalry between Formula One rivals James Hunt and Niki Lauda.&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;rank&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;running_time_secs&quot;</span><span class="punctuation">:</span> <span class="number">7380</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;actors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;Daniel Bruhl&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Chris Hemsworth&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Olivia Wilde&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>
<h3 id="Put-Item"><a href="#Put-Item" class="headerlink" title="Put Item"></a>Put Item</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DecimalEncoder</span>(json.JSONEncoder):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;Helper class to convert a DynamoDB item to JSON&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">default</span>(<span class="params">self, o</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(o, decimal.Decimal):</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">abs</span>(o) % <span class="number">1</span> &gt; <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">float</span>(o)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">int</span>(o)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>(DecimalEncoder, <span class="variable language_">self</span>).default(o)</span><br><span class="line"></span><br><span class="line">title = <span class="string">&quot;The Big New Movie&quot;</span></span><br><span class="line">year = <span class="number">2015</span></span><br><span class="line"></span><br><span class="line">response = table.put_item(</span><br><span class="line">    Item=&#123;</span><br><span class="line">        <span class="string">&#x27;year&#x27;</span>: year,</span><br><span class="line">        <span class="string">&#x27;title&#x27;</span>: title,</span><br><span class="line">        <span class="string">&#x27;info&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;plot&#x27;</span>: <span class="string">&quot;Nothing happens at all.&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;rating&#x27;</span>: decimal.Decimal(<span class="number">0</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;PutItem succeeded:&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(json.dumps(response, indent=<span class="number">4</span>, cls=DecimalEncoder))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="Get-Item"><a href="#Get-Item" class="headerlink" title="Get Item"></a>Get Item</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> botocore.exceptions <span class="keyword">import</span> ClientError</span><br><span class="line"></span><br><span class="line">title = <span class="string">&quot;The Big New Movie&quot;</span></span><br><span class="line">year = <span class="number">2015</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    response = table.get_item(</span><br><span class="line">        Key=&#123;</span><br><span class="line">            <span class="string">&#x27;year&#x27;</span>: year,</span><br><span class="line">            <span class="string">&#x27;title&#x27;</span>: title</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line"><span class="keyword">except</span> ClientError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(e.response[<span class="string">&#x27;Error&#x27;</span>][<span class="string">&#x27;Message&#x27;</span>])</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    item = response[<span class="string">&#x27;Item&#x27;</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;GetItem succeeded:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(json.dumps(item, indent=<span class="number">4</span>, cls=DecimalEncoder))</span><br></pre></td></tr></table></figure>
<h3 id="Update-Item"><a href="#Update-Item" class="headerlink" title="Update Item"></a>Update Item</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">title = <span class="string">&quot;The Big New Movie&quot;</span></span><br><span class="line">year = <span class="number">2015</span></span><br><span class="line"></span><br><span class="line">response = table.update_item(</span><br><span class="line">    Key=&#123;</span><br><span class="line">        <span class="string">&#x27;year&#x27;</span>: year,</span><br><span class="line">        <span class="string">&#x27;title&#x27;</span>: title</span><br><span class="line">    &#125;,</span><br><span class="line">    UpdateExpression=<span class="string">&quot;set info.rating = :r, info.plot=:p, info.actors=:a&quot;</span>,</span><br><span class="line">    ExpressionAttributeValues=&#123;</span><br><span class="line">        <span class="string">&#x27;:r&#x27;</span>: decimal.Decimal(<span class="number">5.5</span>),</span><br><span class="line">        <span class="string">&#x27;:p&#x27;</span>: <span class="string">&quot;Everything happens all at once.&quot;</span>,</span><br><span class="line">        <span class="string">&#x27;:a&#x27;</span>: [<span class="string">&quot;Larry&quot;</span>, <span class="string">&quot;Moe&quot;</span>, <span class="string">&quot;Curly&quot;</span>]</span><br><span class="line">    &#125;,</span><br><span class="line">    ReturnValues=<span class="string">&quot;UPDATED_NEW&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;UpdateItem succeeded:&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(json.dumps(response, indent=<span class="number">4</span>, cls=DecimalEncoder))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">title = <span class="string">&quot;The Big New Movie&quot;</span></span><br><span class="line">year = <span class="number">2015</span></span><br><span class="line"></span><br><span class="line">response = table.update_item(</span><br><span class="line">    Key=&#123;</span><br><span class="line">        <span class="string">&#x27;year&#x27;</span>: year,</span><br><span class="line">        <span class="string">&#x27;title&#x27;</span>: title</span><br><span class="line">    &#125;,</span><br><span class="line">    UpdateExpression=<span class="string">&quot;set info.rating = info.rating + :val&quot;</span>,</span><br><span class="line">    ExpressionAttributeValues=&#123;</span><br><span class="line">        <span class="string">&#x27;:val&#x27;</span>: decimal.Decimal(<span class="number">1</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    ReturnValues=<span class="string">&quot;UPDATED_NEW&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;UpdateItem succeeded:&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(json.dumps(response, indent=<span class="number">4</span>, cls=DecimalEncoder))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">title = <span class="string">&quot;The Big New Movie&quot;</span></span><br><span class="line">year = <span class="number">2015</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Conditional update (will fail)</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Attempting conditional update...&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    response = table.update_item(</span><br><span class="line">        Key=&#123;</span><br><span class="line">            <span class="string">&#x27;year&#x27;</span>: year,</span><br><span class="line">            <span class="string">&#x27;title&#x27;</span>: title</span><br><span class="line">        &#125;,</span><br><span class="line">        UpdateExpression=<span class="string">&quot;remove info.actors[0]&quot;</span>,</span><br><span class="line">        ConditionExpression=<span class="string">&quot;size(info.actors) &gt;= :num&quot;</span>,</span><br><span class="line">        ExpressionAttributeValues=&#123;</span><br><span class="line">            <span class="string">&#x27;:num&#x27;</span>: <span class="number">3</span></span><br><span class="line">        &#125;,</span><br><span class="line">        ReturnValues=<span class="string">&quot;UPDATED_NEW&quot;</span></span><br><span class="line">    )</span><br><span class="line"><span class="keyword">except</span> ClientError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="keyword">if</span> e.response[<span class="string">&#x27;Error&#x27;</span>][<span class="string">&#x27;Code&#x27;</span>] == <span class="string">&quot;ConditionalCheckFailedException&quot;</span>:</span><br><span class="line">        <span class="built_in">print</span>(e.response[<span class="string">&#x27;Error&#x27;</span>][<span class="string">&#x27;Message&#x27;</span>])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;UpdateItem succeeded:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(json.dumps(response, indent=<span class="number">4</span>, cls=DecimalEncoder))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="Delete-Item"><a href="#Delete-Item" class="headerlink" title="Delete Item"></a>Delete Item</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">title = <span class="string">&quot;The Big New Movie&quot;</span></span><br><span class="line">year = <span class="number">2015</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Attempting a conditional delete...&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    response = table.delete_item(</span><br><span class="line">        Key=&#123;</span><br><span class="line">            <span class="string">&#x27;year&#x27;</span>: year,</span><br><span class="line">            <span class="string">&#x27;title&#x27;</span>: title</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line"><span class="keyword">except</span> ClientError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="keyword">if</span> e.response[<span class="string">&#x27;Error&#x27;</span>][<span class="string">&#x27;Code&#x27;</span>] == <span class="string">&quot;ConditionalCheckFailedException&quot;</span>:</span><br><span class="line">        <span class="built_in">print</span>(e.response[<span class="string">&#x27;Error&#x27;</span>][<span class="string">&#x27;Message&#x27;</span>])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;DeleteItem succeeded:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(json.dumps(response, indent=<span class="number">4</span>, cls=DecimalEncoder))</span><br></pre></td></tr></table></figure>
<h3 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> boto3.dynamodb.conditions <span class="keyword">import</span> Key</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Movies from 1985&quot;</span>)</span><br><span class="line"></span><br><span class="line">response = table.query(</span><br><span class="line">    KeyConditionExpression=Key(<span class="string">&#x27;year&#x27;</span>).eq(<span class="number">1985</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> response[<span class="string">&#x27;Items&#x27;</span>]:</span><br><span class="line">    <span class="built_in">print</span>(i[<span class="string">&#x27;year&#x27;</span>], <span class="string">&quot;:&quot;</span>, i[<span class="string">&#x27;title&#x27;</span>])</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Movies from 1992 - titles A-L, with genres and lead actor&quot;</span>)</span><br><span class="line"></span><br><span class="line">response = table.query(</span><br><span class="line">    ProjectionExpression=<span class="string">&quot;#yr, title, info.genres, info.actors[0]&quot;</span>,</span><br><span class="line">    <span class="comment"># Expression Attribute Names for Projection Expression only.</span></span><br><span class="line">    ExpressionAttributeNames=&#123;<span class="string">&quot;#yr&quot;</span>: <span class="string">&quot;year&quot;</span>&#125;,</span><br><span class="line">    KeyConditionExpression=Key(<span class="string">&#x27;year&#x27;</span>).eq(</span><br><span class="line">        <span class="number">1992</span>) &amp; Key(<span class="string">&#x27;title&#x27;</span>).between(<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;L&#x27;</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> response[<span class="string">u&#x27;Items&#x27;</span>]:</span><br><span class="line">    <span class="built_in">print</span>(json.dumps(i, cls=DecimalEncoder))</span><br></pre></td></tr></table></figure>
<h3 id="Scan"><a href="#Scan" class="headerlink" title="Scan"></a>Scan</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">fe = Key(<span class="string">&#x27;year&#x27;</span>).between(<span class="number">1950</span>, <span class="number">1959</span>)</span><br><span class="line">pe = <span class="string">&quot;#yr, title, info.rating&quot;</span></span><br><span class="line"><span class="comment"># Expression Attribute Names for Projection Expression only.</span></span><br><span class="line">ean = &#123;<span class="string">&quot;#yr&quot;</span>: <span class="string">&quot;year&quot;</span>, &#125;</span><br><span class="line">esk = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">response = table.scan(</span><br><span class="line">    FilterExpression=fe,</span><br><span class="line">    ProjectionExpression=pe,</span><br><span class="line">    ExpressionAttributeNames=ean</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> response[<span class="string">&#x27;Items&#x27;</span>]:</span><br><span class="line">    <span class="built_in">print</span>(json.dumps(i, cls=DecimalEncoder))</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="string">&#x27;LastEvaluatedKey&#x27;</span> <span class="keyword">in</span> response:</span><br><span class="line">    response = table.scan(</span><br><span class="line">        ProjectionExpression=pe,</span><br><span class="line">        FilterExpression=fe,</span><br><span class="line">        ExpressionAttributeNames=ean,</span><br><span class="line">        ExclusiveStartKey=response[<span class="string">&#x27;LastEvaluatedKey&#x27;</span>]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> response[<span class="string">&#x27;Items&#x27;</span>]:</span><br><span class="line">        <span class="built_in">print</span>(json.dumps(i, cls=DecimalEncoder))</span><br></pre></td></tr></table></figure>
<h3 id="Delete-table"><a href="#Delete-table" class="headerlink" title="Delete table"></a>Delete table</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line">dynamodb = boto3.resource(<span class="string">&#x27;dynamodb&#x27;</span>)</span><br><span class="line"></span><br><span class="line">table = dynamodb.Table(<span class="string">&#x27;Movies&#x27;</span>)</span><br><span class="line"></span><br><span class="line">table.delete()</span><br></pre></td></tr></table></figure>
<h1 id="Boto3-S3"><a href="#Boto3-S3" class="headerlink" title="Boto3 - S3"></a>Boto3 - S3</h1><p>This chapter follows <a target="_blank" rel="noopener" href="https://github.com/linuxacademy/content-lambda-boto3">https://github.com/linuxacademy/content-lambda-boto3</a></p>
<h2 id="Resizing-Images"><a href="#Resizing-Images" class="headerlink" title="Resizing Images"></a>Resizing Images</h2><p><img src="/photos/aws-note/Resizing-Images.png" alt="Resizing-Images"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line">s3 = boto3.client(<span class="string">&#x27;s3&#x27;</span>)</span><br><span class="line">DEST_BUCKET = os.environ[<span class="string">&#x27;DEST_BUCKET&#x27;</span>]</span><br><span class="line">SIZE = <span class="number">128</span>, <span class="number">128</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> record <span class="keyword">in</span> event[<span class="string">&#x27;Records&#x27;</span>]:</span><br><span class="line">        source_bucket = record[<span class="string">&#x27;s3&#x27;</span>][<span class="string">&#x27;bucket&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">        key = record[<span class="string">&#x27;s3&#x27;</span>][<span class="string">&#x27;object&#x27;</span>][<span class="string">&#x27;key&#x27;</span>]</span><br><span class="line">        thumb = <span class="string">&#x27;thumb-&#x27;</span> + key</span><br><span class="line">        <span class="keyword">with</span> tempfile.TemporaryDirectory() <span class="keyword">as</span> tmpdir:</span><br><span class="line">            download_path = os.path.join(tmpdir, key)</span><br><span class="line">            upload_path = os.path.join(tmpdir, thumb)</span><br><span class="line">            s3.download_file(source_bucket, key, download_path)</span><br><span class="line">            generate_thumbnail(download_path, upload_path)</span><br><span class="line">            s3.upload_file(upload_path, DEST_BUCKET, thumb)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Thumbnail image saved at &#123;&#125;/&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(DEST_BUCKET, thumb))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_thumbnail</span>(<span class="params">source_path, dest_path</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Generating thumbnail from:&#x27;</span>, source_path)</span><br><span class="line">    <span class="keyword">with</span> Image.<span class="built_in">open</span>(source_path) <span class="keyword">as</span> image:</span><br><span class="line">        image.thumbnail(SIZE)</span><br><span class="line">        image.save(dest_path)</span><br></pre></td></tr></table></figure>
<p>To get pillow pkg, find it at <a target="_blank" rel="noopener" href="https://pypi.org/project/Pillow/">https://pypi.org/project/Pillow/</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unzip Pillow-5.4.1-cp37-cp37m-manylinux1_x86_64.whl</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -rf Pillow-5.4.1.dist-info</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zip -r9 lambda.zip lambda_function.py PIL</span><br></pre></td></tr></table></figure>
<p>upload the zip file to AWS Lambda.</p>
<h2 id="Importing-CSV-Files-into-DynamoDB"><a href="#Importing-CSV-Files-into-DynamoDB" class="headerlink" title="Importing CSV Files into DynamoDB"></a>Importing CSV Files into DynamoDB</h2><p><img src="/photos/aws-note/Importing-CSV-Files-into-DynamoDB.png" alt="Importing-CSV-Files-into-DynamoDB"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line">dynamodb = boto3.resource(<span class="string">&#x27;dynamodb&#x27;</span>)</span><br><span class="line">table = dynamodb.Table(<span class="string">&#x27;Movies&#x27;</span>)</span><br><span class="line">s3 = boto3.client(<span class="string">&#x27;s3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> record <span class="keyword">in</span> event[<span class="string">&#x27;Records&#x27;</span>]:</span><br><span class="line">        source_bucket = record[<span class="string">&#x27;s3&#x27;</span>][<span class="string">&#x27;bucket&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">        key = record[<span class="string">&#x27;s3&#x27;</span>][<span class="string">&#x27;object&#x27;</span>][<span class="string">&#x27;key&#x27;</span>]</span><br><span class="line">        <span class="keyword">with</span> tempfile.TemporaryDirectory() <span class="keyword">as</span> tmpdir:</span><br><span class="line">            download_path = os.path.join(tmpdir, key)</span><br><span class="line">            s3.download_file(source_bucket, key, download_path)</span><br><span class="line">            items = read_csv(download_path)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">with</span> table.batch_writer() <span class="keyword">as</span> batch:</span><br><span class="line">                <span class="keyword">for</span> item <span class="keyword">in</span> items:</span><br><span class="line">                    batch.put_item(Item=item)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_csv</span>(<span class="params">file</span>):</span><br><span class="line">    items = []</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file) <span class="keyword">as</span> csvfile:</span><br><span class="line">        reader = csv.DictReader(csvfile)</span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> reader:</span><br><span class="line">            data = &#123;&#125;</span><br><span class="line">            data[<span class="string">&#x27;Meta&#x27;</span>] = &#123;&#125;</span><br><span class="line">            data[<span class="string">&#x27;Year&#x27;</span>] = <span class="built_in">int</span>(row[<span class="string">&#x27;Year&#x27;</span>])</span><br><span class="line">            data[<span class="string">&#x27;Title&#x27;</span>] = row[<span class="string">&#x27;Title&#x27;</span>] <span class="keyword">or</span> <span class="literal">None</span></span><br><span class="line">            data[<span class="string">&#x27;Meta&#x27;</span>][<span class="string">&#x27;Length&#x27;</span>] = <span class="built_in">int</span>(row[<span class="string">&#x27;Length&#x27;</span>] <span class="keyword">or</span> <span class="number">0</span>)</span><br><span class="line">            data[<span class="string">&#x27;Meta&#x27;</span>][<span class="string">&#x27;Subject&#x27;</span>] = row[<span class="string">&#x27;Subject&#x27;</span>] <span class="keyword">or</span> <span class="literal">None</span></span><br><span class="line">            data[<span class="string">&#x27;Meta&#x27;</span>][<span class="string">&#x27;Actor&#x27;</span>] = row[<span class="string">&#x27;Actor&#x27;</span>] <span class="keyword">or</span> <span class="literal">None</span></span><br><span class="line">            data[<span class="string">&#x27;Meta&#x27;</span>][<span class="string">&#x27;Actress&#x27;</span>] = row[<span class="string">&#x27;Actress&#x27;</span>] <span class="keyword">or</span> <span class="literal">None</span></span><br><span class="line">            data[<span class="string">&#x27;Meta&#x27;</span>][<span class="string">&#x27;Director&#x27;</span>] = row[<span class="string">&#x27;Director&#x27;</span>] <span class="keyword">or</span> <span class="literal">None</span></span><br><span class="line">            data[<span class="string">&#x27;Meta&#x27;</span>][<span class="string">&#x27;Popularity&#x27;</span>] = row[<span class="string">&#x27;Popularity&#x27;</span>] <span class="keyword">or</span> <span class="literal">None</span></span><br><span class="line">            data[<span class="string">&#x27;Meta&#x27;</span>][<span class="string">&#x27;Awards&#x27;</span>] = row[<span class="string">&#x27;Awards&#x27;</span>] == <span class="string">&#x27;Yes&#x27;</span></span><br><span class="line">            data[<span class="string">&#x27;Meta&#x27;</span>][<span class="string">&#x27;Image&#x27;</span>] = row[<span class="string">&#x27;Image&#x27;</span>] <span class="keyword">or</span> <span class="literal">None</span></span><br><span class="line">            data[<span class="string">&#x27;Meta&#x27;</span>] = &#123;k: v <span class="keyword">for</span> k,</span><br><span class="line">                            v <span class="keyword">in</span> data[<span class="string">&#x27;Meta&#x27;</span>].items() <span class="keyword">if</span> v <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>&#125;</span><br><span class="line">            items.append(data)</span><br><span class="line">    <span class="keyword">return</span> items</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="Transcribing-Audio"><a href="#Transcribing-Audio" class="headerlink" title="Transcribing Audio"></a>Transcribing Audio</h2><p><img src="/photos/aws-note/Transcribing-Audio.png" alt="Transcribing-Audio"></p>
<p>TranscribeAudio:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line">s3 = boto3.client(<span class="string">&#x27;s3&#x27;</span>)</span><br><span class="line">transcribe = boto3.client(<span class="string">&#x27;transcribe&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> record <span class="keyword">in</span> event[<span class="string">&#x27;Records&#x27;</span>]:</span><br><span class="line">        source_bucket = record[<span class="string">&#x27;s3&#x27;</span>][<span class="string">&#x27;bucket&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">        key = record[<span class="string">&#x27;s3&#x27;</span>][<span class="string">&#x27;object&#x27;</span>][<span class="string">&#x27;key&#x27;</span>]</span><br><span class="line">        object_url = <span class="string">&quot;https://s3.amazonaws.com/&#123;0&#125;/&#123;1&#125;&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">            source_bucket, key)</span><br><span class="line">        response = transcribe.start_transcription_job(</span><br><span class="line">            TranscriptionJobName=<span class="string">&#x27;MyTranscriptionJob&#x27;</span>,</span><br><span class="line">            Media=&#123;<span class="string">&#x27;MediaFileUri&#x27;</span>: object_url&#125;,</span><br><span class="line">            MediaFormat=<span class="string">&#x27;mp3&#x27;</span>,</span><br><span class="line">            LanguageCode=<span class="string">&#x27;en-US&#x27;</span></span><br><span class="line">        )</span><br><span class="line">        <span class="built_in">print</span>(response)</span><br></pre></td></tr></table></figure>
<p>ParseTranscription:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BUCKET_NAME = os.environ[<span class="string">&#x27;BUCKET_NAME&#x27;</span>]</span><br><span class="line"></span><br><span class="line">s3 = boto3.resource(<span class="string">&#x27;s3&#x27;</span>)</span><br><span class="line">transcribe = boto3.client(<span class="string">&#x27;transcribe&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line">    job_name = event[<span class="string">&#x27;detail&#x27;</span>][<span class="string">&#x27;TranscriptionJobName&#x27;</span>]</span><br><span class="line">    job = transcribe.get_transcription_job(TranscriptionJobName=job_name)</span><br><span class="line">    uri = job[<span class="string">&#x27;TranscriptionJob&#x27;</span>][<span class="string">&#x27;Transcript&#x27;</span>][<span class="string">&#x27;TranscriptFileUri&#x27;</span>]</span><br><span class="line">    <span class="built_in">print</span>(uri)</span><br><span class="line"></span><br><span class="line">    content = urllib.request.urlopen(uri).read().decode(<span class="string">&#x27;UTF-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(json.dumps(content))</span><br><span class="line"></span><br><span class="line">    data = json.loads(content)</span><br><span class="line"></span><br><span class="line">    text = data[<span class="string">&#x27;results&#x27;</span>][<span class="string">&#x27;transcripts&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;transcript&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="built_in">object</span> = s3.Object(BUCKET_NAME, job_name + <span class="string">&#x27;-asrOutput.txt&#x27;</span>)</span><br><span class="line">    <span class="built_in">object</span>.put(Body=text)</span><br></pre></td></tr></table></figure>
<h2 id="Detecting-Faces-with-Rekognition"><a href="#Detecting-Faces-with-Rekognition" class="headerlink" title="Detecting Faces with Rekognition"></a>Detecting Faces with Rekognition</h2><p><img src="/photos/aws-note/Detecting-Faces-with-Rekognition.png" alt="Detecting-Faces-with-Rekognition"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line">TABLE_NAME = os.environ[<span class="string">&#x27;TABLE_NAME&#x27;</span>]</span><br><span class="line"></span><br><span class="line">dynamodb = boto3.resource(<span class="string">&#x27;dynamodb&#x27;</span>)</span><br><span class="line">table = dynamodb.Table(TABLE_NAME)</span><br><span class="line">s3 = boto3.resource(<span class="string">&#x27;s3&#x27;</span>)</span><br><span class="line">rekognition = boto3.client(<span class="string">&#x27;rekognition&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Get the object from the event</span></span><br><span class="line">    bucket = event[<span class="string">&#x27;Records&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;s3&#x27;</span>][<span class="string">&#x27;bucket&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">    key = event[<span class="string">&#x27;Records&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;s3&#x27;</span>][<span class="string">&#x27;object&#x27;</span>][<span class="string">&#x27;key&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    obj = s3.Object(bucket, key)</span><br><span class="line">    image = obj.get()[<span class="string">&#x27;Body&#x27;</span>].read()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Recognizing celebrities...&#x27;</span>)</span><br><span class="line">    response = rekognition.recognize_celebrities(Image=&#123;<span class="string">&#x27;Bytes&#x27;</span>: image&#125;)</span><br><span class="line"></span><br><span class="line">    names = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> celebrity <span class="keyword">in</span> response[<span class="string">&#x27;CelebrityFaces&#x27;</span>]:</span><br><span class="line">        name = celebrity[<span class="string">&#x27;Name&#x27;</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Name: &#x27;</span> + name)</span><br><span class="line">        names.append(name)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(names)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Saving face data to DynamoDB table:&#x27;</span>, TABLE_NAME)</span><br><span class="line">    response = table.put_item(</span><br><span class="line">        Item=&#123;</span><br><span class="line">            <span class="string">&#x27;key&#x27;</span>: key,</span><br><span class="line">            <span class="string">&#x27;names&#x27;</span>: names,</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">    <span class="built_in">print</span>(response)</span><br></pre></td></tr></table></figure>
<h1 id="Boto3-SQS"><a href="#Boto3-SQS" class="headerlink" title="Boto3 - SQS"></a>Boto3 - SQS</h1><h2 id="Triggering-Lambda-from-SQS"><a href="#Triggering-Lambda-from-SQS" class="headerlink" title="Triggering Lambda from SQS"></a>Triggering Lambda from SQS</h2><p><img src="/photos/aws-note/Triggering-Lambda-from-SQS.png" alt="Triggering-Lambda-from-SQS"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line">QUEUE_NAME = os.environ[<span class="string">&#x27;QUEUE_NAME&#x27;</span>]</span><br><span class="line">MAX_QUEUE_MESSAGES = os.environ[<span class="string">&#x27;MAX_QUEUE_MESSAGES&#x27;</span>]</span><br><span class="line">DYNAMODB_TABLE = os.environ[<span class="string">&#x27;DYNAMODB_TABLE&#x27;</span>]</span><br><span class="line"></span><br><span class="line">sqs = boto3.resource(<span class="string">&#x27;sqs&#x27;</span>)</span><br><span class="line">dynamodb = boto3.resource(<span class="string">&#x27;dynamodb&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Receive messages from SQS queue</span></span><br><span class="line">    queue = sqs.get_queue_by_name(QueueName=QUEUE_NAME)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ApproximateNumberOfMessages:&quot;</span>,</span><br><span class="line">          queue.attributes.get(<span class="string">&#x27;ApproximateNumberOfMessages&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> message <span class="keyword">in</span> queue.receive_messages(</span><br><span class="line">            MaxNumberOfMessages=<span class="built_in">int</span>(MAX_QUEUE_MESSAGES)):</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(message)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Write message to DynamoDB</span></span><br><span class="line">        table = dynamodb.Table(DYNAMODB_TABLE)</span><br><span class="line"></span><br><span class="line">        response = table.put_item(</span><br><span class="line">            Item=&#123;</span><br><span class="line">                <span class="string">&#x27;MessageId&#x27;</span>: message.message_id,</span><br><span class="line">                <span class="string">&#x27;Body&#x27;</span>: message.body,</span><br><span class="line">                <span class="string">&#x27;Timestamp&#x27;</span>: datetime.now().isoformat()</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Wrote message to DynamoDB:&quot;</span>, json.dumps(response))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Delete SQS message</span></span><br><span class="line">        message.delete()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Deleted message:&quot;</span>, message.message_id)</span><br></pre></td></tr></table></figure>
<p>send_message.py:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3.7</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"><span class="keyword">from</span> faker <span class="keyword">import</span> Faker</span><br><span class="line"></span><br><span class="line">parser = argparse.ArgumentParser()</span><br><span class="line">parser.add_argument(<span class="string">&quot;--queue-name&quot;</span>, <span class="string">&quot;-q&quot;</span>, required=<span class="literal">True</span>,</span><br><span class="line">                    <span class="built_in">help</span>=<span class="string">&quot;SQS queue name&quot;</span>)</span><br><span class="line">parser.add_argument(<span class="string">&quot;--interval&quot;</span>, <span class="string">&quot;-i&quot;</span>, required=<span class="literal">True</span>,</span><br><span class="line">                    <span class="built_in">help</span>=<span class="string">&quot;timer interval&quot;</span>, <span class="built_in">type</span>=<span class="built_in">float</span>)</span><br><span class="line">parser.add_argument(<span class="string">&quot;--message&quot;</span>, <span class="string">&quot;-m&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;message to send&quot;</span>)</span><br><span class="line">parser.add_argument(<span class="string">&quot;--log&quot;</span>, <span class="string">&quot;-l&quot;</span>, default=<span class="string">&quot;INFO&quot;</span>,</span><br><span class="line">                    <span class="built_in">help</span>=<span class="string">&quot;logging level&quot;</span>)</span><br><span class="line">args = parser.parse_args()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> args.log:</span><br><span class="line">    logging.basicConfig(</span><br><span class="line">        <span class="built_in">format</span>=<span class="string">&#x27;[%(levelname)s] %(message)s&#x27;</span>, level=args.log)</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    parser.print_help(sys.stderr)</span><br><span class="line"></span><br><span class="line">sqs = boto3.client(<span class="string">&#x27;sqs&#x27;</span>)</span><br><span class="line"></span><br><span class="line">response = sqs.get_queue_url(QueueName=args.queue_name)</span><br><span class="line"></span><br><span class="line">queue_url = response[<span class="string">&#x27;QueueUrl&#x27;</span>]</span><br><span class="line"></span><br><span class="line">logging.info(queue_url)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    message = args.message</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> args.message:</span><br><span class="line">        fake = Faker()</span><br><span class="line">        message = fake.text()</span><br><span class="line"></span><br><span class="line">    logging.info(<span class="string">&#x27;Sending message: &#x27;</span> + message)</span><br><span class="line"></span><br><span class="line">    response = sqs.send_message(</span><br><span class="line">        QueueUrl=queue_url, MessageBody=message)</span><br><span class="line"></span><br><span class="line">    logging.info(<span class="string">&#x27;MessageId: &#x27;</span> + response[<span class="string">&#x27;MessageId&#x27;</span>])</span><br><span class="line">    sleep(args.interval)</span><br></pre></td></tr></table></figure>
<h2 id="Creating-a-Queue-Using-Cross-Account-Permissions"><a href="#Creating-a-Queue-Using-Cross-Account-Permissions" class="headerlink" title="Creating a Queue Using Cross-Account Permissions"></a>Creating a Queue Using Cross-Account Permissions</h2><p><img src="/photos/aws-note/Creating-a-Queue-Using-Cross-Account-Permissions.png" alt="Creating-a-Queue-Using-Cross-Account-Permissions"></p>
<p>SQS does not allow API calls such as CreateQueue using cross-account permissions. A workaround is to create and invoke a Lambda function in another account in order to call that API.</p>
<p>Create AWS CLI Profiles<br>Development account admin:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">aws configure --profile devadmin</span><br><span class="line">Production account admin:</span><br><span class="line"></span><br><span class="line">aws configure --profile prodadmin</span><br></pre></td></tr></table></figure>
<p>Create a Lambda Function in the Production Account<br>Function name: CreateSQSQueue</p>
<p>See lambda_function.py and assign the role lambda_execution_role.json.</p>
<p>Assign Permissions to the Lambda Function<br>Add permissions to the production Lambda function that allow it to be invoked by the development account user:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">aws lambda add-permission \</span><br><span class="line">--function-name CreateSQSQueue \</span><br><span class="line">--statement-id DevAccountAccess \</span><br><span class="line">--action <span class="string">&#x27;lambda:InvokeFunction&#x27;</span> \</span><br><span class="line">--principal <span class="string">&#x27;arn:aws:iam::__DEVELOPMENT_ACCOUNT_NUMBER__:user/devadmin&#x27;</span> \</span><br><span class="line">--region us-east-2 \</span><br><span class="line">--profile prodadmin</span><br></pre></td></tr></table></figure>
<p>To view the policy:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">aws lambda get-policy \</span><br><span class="line">--function-name CreateSQSQueue \</span><br><span class="line">--region us-east-2 \</span><br><span class="line">--profile prodadmin</span><br></pre></td></tr></table></figure>
<p>To remove the policy:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">aws lambda remove-permission \</span><br><span class="line">--function-name CreateSQSQueue \</span><br><span class="line">--statement-id DevAccountAccess \</span><br><span class="line">--region us-east-2 \</span><br><span class="line">--profile prodadmin</span><br></pre></td></tr></table></figure>
<p>Invoke the Production Lambda Function from the Development Account:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">aws lambda invoke \</span><br><span class="line">--function-name <span class="string">&#x27;__LAMBDA_FUNCTION_ARN__&#x27;</span> \</span><br><span class="line">--payload <span class="string">&#x27;&#123;&quot;QueueName&quot;: &quot;MyQueue&quot; &#125;&#x27;</span> \</span><br><span class="line">--invocation-type RequestResponse \</span><br><span class="line">--profile devadmin \</span><br><span class="line">--region us-east-2 \</span><br><span class="line">output.txt</span><br></pre></td></tr></table></figure>
<p>lambda_function.py:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line">sqs = boto3.resource(<span class="string">&#x27;sqs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line"></span><br><span class="line">    queue = sqs.create_queue(QueueName=event[<span class="string">&#x27;QueueName&#x27;</span>])</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Queue URL&#x27;</span>, queue.url)</span><br></pre></td></tr></table></figure>
<p>lambda_execution_role.json:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2012-10-17&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;Statement&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;logs:CreateLogGroup&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;logs:CreateLogStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;logs:PutLogEvents&quot;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:logs:*:*:*&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;sqs:CreateQueue&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h1 id="Boto3-Third-party"><a href="#Boto3-Third-party" class="headerlink" title="Boto3 - Third party"></a>Boto3 - Third party</h1><h2 id="Creating-Slack-Notifications-for-CloudWatch-Alarms"><a href="#Creating-Slack-Notifications-for-CloudWatch-Alarms" class="headerlink" title="Creating Slack Notifications for CloudWatch Alarms"></a>Creating Slack Notifications for CloudWatch Alarms</h2><p><img src="/photos/aws-note/Creating-Slack-Notifications-for-CloudWatch-Alarms.png" alt="Creating-Slack-Notifications-for-CloudWatch-Alarms"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> urllib.error <span class="keyword">import</span> HTTPError, URLError</span><br><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> Request, urlopen</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line">ssm = boto3.client(<span class="string">&#x27;ssm&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line">    <span class="built_in">print</span>(json.dumps(event))</span><br><span class="line"></span><br><span class="line">    message = json.loads(event[<span class="string">&#x27;Records&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;Sns&#x27;</span>][<span class="string">&#x27;Message&#x27;</span>])</span><br><span class="line">    <span class="built_in">print</span>(json.dumps(message))</span><br><span class="line"></span><br><span class="line">    alarm_name = message[<span class="string">&#x27;AlarmName&#x27;</span>]</span><br><span class="line">    new_state = message[<span class="string">&#x27;NewStateValue&#x27;</span>]</span><br><span class="line">    reason = message[<span class="string">&#x27;NewStateReason&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    slack_message = &#123;</span><br><span class="line">        <span class="string">&#x27;text&#x27;</span>: <span class="string">f&#x27;:fire: <span class="subst">&#123;alarm_name&#125;</span> state is now <span class="subst">&#123;new_state&#125;</span>: <span class="subst">&#123;reason&#125;</span>\n&#x27;</span></span><br><span class="line">                <span class="string">f&#x27;```\n<span class="subst">&#123;message&#125;</span>```&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    webhook_url = ssm.get_parameter(</span><br><span class="line">        Name=<span class="string">&#x27;SlackWebHookURL&#x27;</span>, WithDecryption=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    req = Request(webhook_url[<span class="string">&#x27;Parameter&#x27;</span>][<span class="string">&#x27;Value&#x27;</span>],</span><br><span class="line">                  json.dumps(slack_message).encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response = urlopen(req)</span><br><span class="line">        response.read()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Message posted to Slack&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> HTTPError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;Request failed: <span class="subst">&#123;e.code&#125;</span> <span class="subst">&#123;e.reason&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="keyword">except</span> URLError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;Server connection failed: <span class="subst">&#123;e.reason&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="Creating-a-Twitter-App"><a href="#Creating-a-Twitter-App" class="headerlink" title="Creating a Twitter App"></a>Creating a Twitter App</h2><p><img src="/photos/aws-note/Creating-a-Twitter-App.png" alt="Creating-a-Twitter-App"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"><span class="keyword">from</span> botocore.exceptions <span class="keyword">import</span> ClientError</span><br><span class="line"><span class="keyword">import</span> tweepy</span><br><span class="line"></span><br><span class="line">BUCKET_NAME = os.environ[<span class="string">&#x27;BUCKET_NAME&#x27;</span>]</span><br><span class="line">KEY = <span class="string">&#x27;data.txt&#x27;</span></span><br><span class="line"></span><br><span class="line">s3 = boto3.resource(<span class="string">&#x27;s3&#x27;</span>)</span><br><span class="line">ssm = boto3.client(<span class="string">&#x27;ssm&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_parameter</span>(<span class="params">param_name</span>):</span><br><span class="line">    response = ssm.get_parameter(Name=param_name, WithDecryption=<span class="literal">True</span>)</span><br><span class="line">    credentials = response[<span class="string">&#x27;Parameter&#x27;</span>][<span class="string">&#x27;Value&#x27;</span>]</span><br><span class="line">    <span class="keyword">return</span> credentials</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_tweet_text</span>():</span><br><span class="line">    filename = <span class="string">&#x27;/tmp/&#x27;</span> + KEY</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        s3.Bucket(BUCKET_NAME).download_file(KEY, filename)</span><br><span class="line">    <span class="keyword">except</span> ClientError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">if</span> e.response[<span class="string">&#x27;Error&#x27;</span>][<span class="string">&#x27;Code&#x27;</span>] == <span class="string">&quot;404&quot;</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;The object <span class="subst">&#123;KEY&#125;</span> does not exist in bucket <span class="subst">&#123;BUCKET_NAME&#125;</span>.&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename) <span class="keyword">as</span> f:</span><br><span class="line">        lines = f.readlines()</span><br><span class="line">        <span class="keyword">return</span> random.choice(lines)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Get SSM parameters</span></span><br><span class="line">    CONSUMER_KEY = get_parameter(<span class="string">&#x27;/TwitterBot/consumer_key&#x27;</span>)</span><br><span class="line">    CONSUMER_SECRET = get_parameter(<span class="string">&#x27;/TwitterBot/consumer_secret&#x27;</span>)</span><br><span class="line">    ACCESS_TOKEN = get_parameter(<span class="string">&#x27;/TwitterBot/access_token&#x27;</span>)</span><br><span class="line">    ACCESS_TOKEN_SECRET = get_parameter(<span class="string">&#x27;/TwitterBot/access_token_secret&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Authenticate Tweepy</span></span><br><span class="line">    auth = tweepy.OAuthHandler(CONSUMER_KEY, CONSUMER_SECRET)</span><br><span class="line">    auth.set_access_token(ACCESS_TOKEN, ACCESS_TOKEN_SECRET)</span><br><span class="line">    api = tweepy.API(auth)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Send tweet</span></span><br><span class="line">    tweet = get_tweet_text()</span><br><span class="line">    <span class="built_in">print</span>(tweet)</span><br><span class="line">    api.update_status(tweet)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://xyshell.github.io/2020/06/08/aws-note/" data-id="clywj85fy0004t89527993mf1" class="article-share-link">
        Share
      </a>
      
<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/aws/" rel="tag">aws</a></li></ul>

    </footer>

  </div>

  

  

</article>
    
    <article id="post-linux-note" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      
  
  <h2 class="article-title" itemprop="name">
    <a href="/2020/06/08/linux-note/">Linux Note</a>
  </h2>
  
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/06/08/linux-note/" class="article-date">
  <time datetime="2020-06-08T06:26:27.000Z" itemprop="datePublished">2020-06-08</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
        <h1 id="SSH"><a href="#SSH" class="headerlink" title="SSH"></a>SSH</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -i &lt;path-to-pem&gt; admin@&lt;ip/dns&gt;</span><br></pre></td></tr></table></figure>
<p>Local Port Forwarding:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -i &lt;path-to-pem&gt; -l admin &lt;ip/dns&gt; -L 9999:localhost:9999</span><br></pre></td></tr></table></figure></p>
<h1 id="SCP"><a href="#SCP" class="headerlink" title="SCP"></a>SCP</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp -i &lt;path-to-pem&gt; &lt;path-to-source-file&gt; admin@&lt;ip/dns&gt;:/home/admin/&lt;path-to-target-file&gt;</span><br></pre></td></tr></table></figure>
<h1 id="Auto-start-after-reboot"><a href="#Auto-start-after-reboot" class="headerlink" title="Auto-start after reboot"></a>Auto-start after reboot</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl <span class="built_in">enable</span> docker</span><br><span class="line">Synchronizing state of docker.service...</span><br><span class="line">Executing /lib/systemd/systemd-sysv-install <span class="built_in">enable</span> docker</span><br><span class="line">$ systemctl is-enabled docker</span><br><span class="line">enabled</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://xyshell.github.io/2020/06/08/linux-note/" data-id="clywj85g8000qt895a9svgcjj" class="article-share-link">
        Share
      </a>
      
    </footer>

  </div>

  

  

</article>
    
  </article>
  

  
  <nav class="page-nav">
    <a class="extend prev" rel="prev" href="/">Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/">Next</a>
  </nav>
  
</section>
</div>
    <footer class="footer">
  <div class="outer">
    <ul class="list-inline">
      <li>You Xie&#39;s Blog &copy; 2024</li>
      
        <li>
          
            <a href="https://beian.miit.gov.cn/" target="_blank"></a>
            
        </li>
      
      <li>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></li>
      <li>theme  <a target="_blank" rel="noopener" href="https://github.com/zhwangart/hexo-theme-ocean">Ocean</a></li>
    </ul>
    <p><ul class="list-inline">
  
  <li><i class="fe fe-bar-chart tooltip" data-tooltip="PV"></i> <span id="busuanzi_value_site_pv"></span></li>
  
  <li><i class="fe fe-smile-alt tooltip" data-tooltip="UV"></i> <span id="busuanzi_value_site_uv"></span></li>
  
</ul></p>
  </div>
</footer>
  </main>
  <aside class="sidebar">
    <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/hexo.svg" alt="You Xie&#39;s Blog"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">Home</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">Archives</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/gallery">Gallery</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">About</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link nav-item-search" title="Search">
        <i class="fe fe-search"></i>
        Search
      </a>
    </li>
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      <div class="totop" id="totop">
  <i class="fe fe-rocket"></i>
</div>
    </li>
    <li class="nav-item">
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="fe fe-feed"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
  </aside>
  
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/lazyload.min.js"></script>


<script src="/js/busuanzi-2.3.pure.min.js"></script>



<script src="/fancybox/jquery.fancybox.min.js"></script>






<script src="/js/ocean.js"></script>

</body>

</html>