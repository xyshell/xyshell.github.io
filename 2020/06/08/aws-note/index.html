<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"xyshell.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":350,"width_dual_column":240,"display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":3,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="AWS Basics  AWS website infrastructure.aws TCO(total cost of ownership) Calculator Pricing Calculator  Install  AWS CLI and Boto3  Amazon Linux 2 The AWS CLI is already installed on Amazon Linux 2. I">
<meta property="og:type" content="article">
<meta property="og:title" content="AWS Note">
<meta property="og:url" content="https://xyshell.github.io/2020/06/08/aws-note/index.html">
<meta property="og:site_name" content="You Xie&#39;s Blog">
<meta property="og:description" content="AWS Basics  AWS website infrastructure.aws TCO(total cost of ownership) Calculator Pricing Calculator  Install  AWS CLI and Boto3  Amazon Linux 2 The AWS CLI is already installed on Amazon Linux 2. I">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://xyshell.github.io/photos/aws-note/Stopping-EC2-Instances-Nightly.png">
<meta property="og:image" content="https://xyshell.github.io/photos/aws-note/Backing-Up-EC2-Instances.png">
<meta property="og:image" content="https://xyshell.github.io/photos/aws-note/Resizing-Images.png">
<meta property="og:image" content="https://xyshell.github.io/photos/aws-note/Importing-CSV-Files-into-DynamoDB.png">
<meta property="og:image" content="https://xyshell.github.io/photos/aws-note/Transcribing-Audio.png">
<meta property="og:image" content="https://xyshell.github.io/photos/aws-note/Detecting-Faces-with-Rekognition.png">
<meta property="og:image" content="https://xyshell.github.io/photos/aws-note/Triggering-Lambda-from-SQS.png">
<meta property="og:image" content="https://xyshell.github.io/photos/aws-note/Creating-a-Queue-Using-Cross-Account-Permissions.png">
<meta property="og:image" content="https://xyshell.github.io/photos/aws-note/Creating-Slack-Notifications-for-CloudWatch-Alarms.png">
<meta property="og:image" content="https://xyshell.github.io/photos/aws-note/Creating-a-Twitter-App.png">
<meta property="article:published_time" content="2020-06-08T06:30:49.000Z">
<meta property="article:modified_time" content="2023-09-27T05:59:01.863Z">
<meta property="article:author" content="You Xie">
<meta property="article:tag" content="aws">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://xyshell.github.io/photos/aws-note/Stopping-EC2-Instances-Nightly.png">


<link rel="canonical" href="https://xyshell.github.io/2020/06/08/aws-note/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://xyshell.github.io/2020/06/08/aws-note/","path":"2020/06/08/aws-note/","title":"AWS Note"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>AWS Note | You Xie's Blog</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KJL0CGYTBX"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-KJL0CGYTBX","only_pageview":false,"measure_protocol_api_secret":null}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">You Xie's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#aws-basics"><span class="nav-number">1.</span> <span class="nav-text"> AWS Basics</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#aws-website"><span class="nav-number">1.1.</span> <span class="nav-text"> AWS website</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#install"><span class="nav-number">1.2.</span> <span class="nav-text"> Install</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#aws-cli-and-boto3"><span class="nav-number">1.2.1.</span> <span class="nav-text"> AWS CLI and Boto3</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#amazon-linux-2"><span class="nav-number">1.2.1.1.</span> <span class="nav-text"> Amazon Linux 2</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#macos"><span class="nav-number">1.2.1.2.</span> <span class="nav-text"> macOS</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#docker"><span class="nav-number">1.2.2.</span> <span class="nav-text"> Docker</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#configuring-your-aws-environment"><span class="nav-number">1.3.</span> <span class="nav-text"> Configuring your AWS environment</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#test-your-credentials"><span class="nav-number">1.4.</span> <span class="nav-text"> Test Your Credentials</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#aws-cli"><span class="nav-number">2.</span> <span class="nav-text"> AWS CLI</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#s3"><span class="nav-number">2.1.</span> <span class="nav-text"> S3</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dynamodb"><span class="nav-number">2.2.</span> <span class="nav-text"> Dynamodb</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#boto3-ec2"><span class="nav-number">3.</span> <span class="nav-text"> Boto3 - EC2</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#helloworld"><span class="nav-number">3.1.</span> <span class="nav-text"> HelloWorld</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#list-all-s3-bucket-name"><span class="nav-number">3.1.1.</span> <span class="nav-text"> List all S3 bucket name:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#spin-up-an-ec2-instance"><span class="nav-number">3.1.2.</span> <span class="nav-text"> Spin up an ec2 instance</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#stopping-ec2-instances-nightly"><span class="nav-number">3.2.</span> <span class="nav-text"> Stopping EC2 Instances Nightly</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#backing-up-ec2-instances"><span class="nav-number">3.3.</span> <span class="nav-text"> Backing Up EC2 Instances</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#create-backups"><span class="nav-number">3.3.1.</span> <span class="nav-text"> Create-Backups</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#prune-backups"><span class="nav-number">3.3.2.</span> <span class="nav-text"> Prune-Backups</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#removing-unattached-ebs-volumes"><span class="nav-number">3.3.3.</span> <span class="nav-text"> Removing Unattached EBS Volumes</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#deregistering-old-amis"><span class="nav-number">3.3.4.</span> <span class="nav-text"> Deregistering Old AMIs</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#boto3-dynamodb"><span class="nav-number">4.</span> <span class="nav-text"> Boto3 - Dynamodb</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#create-tables"><span class="nav-number">4.0.1.</span> <span class="nav-text"> Create Tables</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#load-data"><span class="nav-number">4.0.2.</span> <span class="nav-text"> Load Data</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#put-item"><span class="nav-number">4.0.3.</span> <span class="nav-text"> Put Item</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#get-item"><span class="nav-number">4.0.4.</span> <span class="nav-text"> Get Item</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#update-item"><span class="nav-number">4.0.5.</span> <span class="nav-text"> Update Item</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#delete-item"><span class="nav-number">4.0.6.</span> <span class="nav-text"> Delete Item</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#query"><span class="nav-number">4.0.7.</span> <span class="nav-text"> Query</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#scan"><span class="nav-number">4.0.8.</span> <span class="nav-text"> Scan</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#delete-table"><span class="nav-number">4.0.9.</span> <span class="nav-text"> Delete table</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#boto3-s3"><span class="nav-number">5.</span> <span class="nav-text"> Boto3 - S3</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#resizing-images"><span class="nav-number">5.1.</span> <span class="nav-text"> Resizing Images</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#importing-csv-files-into-dynamodb"><span class="nav-number">5.2.</span> <span class="nav-text"> Importing CSV Files into DynamoDB</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#transcribing-audio"><span class="nav-number">5.3.</span> <span class="nav-text"> Transcribing Audio</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#detecting-faces-with-rekognition"><span class="nav-number">5.4.</span> <span class="nav-text"> Detecting Faces with Rekognition</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#boto3-sqs"><span class="nav-number">6.</span> <span class="nav-text"> Boto3 - SQS</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#triggering-lambda-from-sqs"><span class="nav-number">6.1.</span> <span class="nav-text"> Triggering Lambda from SQS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#creating-a-queue-using-cross-account-permissions"><span class="nav-number">6.2.</span> <span class="nav-text"> Creating a Queue Using Cross-Account Permissions</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#boto3-third-party"><span class="nav-number">7.</span> <span class="nav-text"> Boto3 - Third party</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#creating-slack-notifications-for-cloudwatch-alarms"><span class="nav-number">7.1.</span> <span class="nav-text"> Creating Slack Notifications for CloudWatch Alarms</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#creating-a-twitter-app"><span class="nav-number">7.2.</span> <span class="nav-text"> Creating a Twitter App</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="You Xie"
      src="https://avatars.githubusercontent.com/u/38464985?v=4">
  <p class="site-author-name" itemprop="name">You Xie</p>
  <div class="site-description" itemprop="description">Never too old to learn!</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">21</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/xyshell" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xyshell" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:xyshell0@gmail.com" title="E-Mail → mailto:xyshell0@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://xyshell.github.io/2020/06/08/aws-note/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/38464985?v=4">
      <meta itemprop="name" content="You Xie">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="You Xie's Blog">
      <meta itemprop="description" content="Never too old to learn!">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="AWS Note | You Xie's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          AWS Note
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-06-08 01:30:49" itemprop="dateCreated datePublished" datetime="2020-06-08T01:30:49-05:00">2020-06-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-09-27 00:59:01" itemprop="dateModified" datetime="2023-09-27T00:59:01-05:00">2023-09-27</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="aws-basics"><a class="markdownIt-Anchor" href="#aws-basics"></a> AWS Basics</h1>
<h2 id="aws-website"><a class="markdownIt-Anchor" href="#aws-website"></a> AWS website</h2>
<p><a target="_blank" rel="noopener" href="https://infrastructure.aws/">infrastructure.aws</a></p>
<p><a target="_blank" rel="noopener" href="http://awstcocalculator.com/">TCO(total cost of ownership) Calculator</a></p>
<p><a target="_blank" rel="noopener" href="https://calculator.aws/#/">Pricing Calculator</a></p>
<h2 id="install"><a class="markdownIt-Anchor" href="#install"></a> Install</h2>
<h3 id="aws-cli-and-boto3"><a class="markdownIt-Anchor" href="#aws-cli-and-boto3"></a> AWS CLI and Boto3</h3>
<h4 id="amazon-linux-2"><a class="markdownIt-Anchor" href="#amazon-linux-2"></a> Amazon Linux 2</h4>
<p>The AWS CLI is already installed on Amazon Linux 2.</p>
<p>Install Python 3:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> yum install -y python3-pip python3 python3-setuptools</span><br></pre></td></tr></table></figure>
<p>Install Boto3:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install boto3 --user</span><br></pre></td></tr></table></figure>
<h4 id="macos"><a class="markdownIt-Anchor" href="#macos"></a> macOS</h4>
<p>Install Python3 using Homebrew:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ruby -e <span class="string">&quot;<span class="subst">$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)</span>&quot;</span></span><br></pre></td></tr></table></figure>
<p>Install Python 3:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install python</span><br></pre></td></tr></table></figure>
<p>Insert the Homebrew Python directory at the top of your PATH environment variable:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=<span class="string">&quot;/usr/local/opt/python/libexec/bin:<span class="variable">$PATH</span>&quot;</span></span><br></pre></td></tr></table></figure>
<p>Verify you are using Python 3:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python --version</span><br></pre></td></tr></table></figure>
<p>Install the AWS CLI and Boto3:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install awscli boto3 --upgrade --user</span><br></pre></td></tr></table></figure>
<h3 id="docker"><a class="markdownIt-Anchor" href="#docker"></a> Docker</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> amazon-linux-extras install docker</span><br></pre></td></tr></table></figure>
<h2 id="configuring-your-aws-environment"><a class="markdownIt-Anchor" href="#configuring-your-aws-environment"></a> Configuring your AWS environment</h2>
<p>Obtain your AWS access key and secret access key from the AWS Management Console. Run the following command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws configure</span><br></pre></td></tr></table></figure>
<p>This sets up a text file that the AWS CLI and Boto3 libraries look at by default for your credentials: <code>~/.aws/credentials</code>.</p>
<p>The file should look like this:</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[default]</span><br><span class="line">aws_access_key_id = AKIAIOSFODNN7EXAMPLE</span><br><span class="line">aws_secret_access_key = wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY</span><br></pre></td></tr></table></figure>
<h2 id="test-your-credentials"><a class="markdownIt-Anchor" href="#test-your-credentials"></a> Test Your Credentials</h2>
<p>AWS CLI<br />
Run the following command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws sts get-caller-identity</span><br></pre></td></tr></table></figure>
<p>The output should look like this:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;UserId&quot;</span>: <span class="string">&quot;AIDAJKLMNOPQRSTUVWXYZ&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Account&quot;</span>: <span class="string">&quot;123456789012&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Arn&quot;</span>: <span class="string">&quot;arn:aws:iam::123456789012:userdevuser&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="aws-cli"><a class="markdownIt-Anchor" href="#aws-cli"></a> AWS CLI</h1>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aws configure</span><br><span class="line">aws sts get-caller-identity</span><br></pre></td></tr></table></figure>
<h2 id="s3"><a class="markdownIt-Anchor" href="#s3"></a> S3</h2>
<p>Upload folder to s3:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws s3 <span class="built_in">cp</span> &lt;path-to-source-folder&gt; s3://&lt;path-to-target-folder&gt; --recursive --exclude <span class="string">&quot;.DS_Store&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="dynamodb"><a class="markdownIt-Anchor" href="#dynamodb"></a> Dynamodb</h2>
<p>create table:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">aws dynamodb create-table \</span><br><span class="line">    --table-name Music \</span><br><span class="line">    --key-schema AttributeName=Artist,KeyType=HASH \</span><br><span class="line">                 AttributeName=SongTitle,KeyType=RANGE \</span><br><span class="line">    --attribute-definitions \</span><br><span class="line">        AttributeName=Artist,AttributeType=S \</span><br><span class="line">        AttributeName=SongTitle,AttributeType=S \</span><br><span class="line">    --provisioned-throughput \</span><br><span class="line">        ReadCapacityUnits=5,WriteCapacityUnits=5</span><br></pre></td></tr></table></figure>
<p>describe table:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws dynamodb describe-table --table-name Music</span><br></pre></td></tr></table></figure>
<p>put item:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">aws dynamodb put-item \</span><br><span class="line">    --table-name Music \</span><br><span class="line">    --item <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">        &quot;Artist&quot;: &#123;&quot;S&quot;: &quot;Dream Theater&quot;&#125;,</span></span><br><span class="line"><span class="string">        &quot;AlbumTitle&quot;: &#123;&quot;S&quot;: &quot;Images and Words&quot;&#125;,</span></span><br><span class="line"><span class="string">        &quot;SongTitle&quot;: &#123;&quot;S&quot;: &quot;Under a Glass Moon&quot;&#125; &#125;&#x27;</span></span><br></pre></td></tr></table></figure>
<p>scan table:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws dynamodb scan --table-name Music</span><br></pre></td></tr></table></figure>
<h1 id="boto3-ec2"><a class="markdownIt-Anchor" href="#boto3-ec2"></a> Boto3 - EC2</h1>
<p>This section follows <a target="_blank" rel="noopener" href="https://github.com/linuxacademy/content-dynamodb-deepdive">https://github.com/linuxacademy/content-dynamodb-deepdive</a></p>
<h2 id="helloworld"><a class="markdownIt-Anchor" href="#helloworld"></a> HelloWorld</h2>
<h3 id="list-all-s3-bucket-name"><a class="markdownIt-Anchor" href="#list-all-s3-bucket-name"></a> List all S3 bucket name:</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line">s3 = boto3.resource(<span class="string">&#x27;s3&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> bucket <span class="keyword">in</span> s3.buckets.<span class="built_in">all</span>():</span><br><span class="line">    <span class="built_in">print</span>(bucket.name)</span><br></pre></td></tr></table></figure>
<h3 id="spin-up-an-ec2-instance"><a class="markdownIt-Anchor" href="#spin-up-an-ec2-instance"></a> Spin up an ec2 instance</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line">ec2 = boto3.client(<span class="string">&#x27;ec2&#x27;</span>)</span><br><span class="line">response = ec2.run_instances(</span><br><span class="line">    ImageId=<span class="string">&#x27;ami-0947d2ba12ee1ff75&#x27;</span>, <span class="comment"># Amazon Linux 2 AMI (HVM), SSD Volume Type</span></span><br><span class="line">    InstanceType=<span class="string">&#x27;t2.micro&#x27;</span>,</span><br><span class="line">    KeyName=<span class="string">&#x27;xyshell&#x27;</span>,</span><br><span class="line">    MinCount=<span class="number">1</span>,</span><br><span class="line">    MaxCount=<span class="number">1</span>,</span><br><span class="line">    SubnetId=<span class="string">&#x27;subnet-05b78e3323bcabddc&#x27;</span></span><br><span class="line">)</span><br><span class="line"><span class="built_in">print</span>(response[<span class="string">&#x27;Instances&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;InstanceId&#x27;</span>])</span><br></pre></td></tr></table></figure>
<h2 id="stopping-ec2-instances-nightly"><a class="markdownIt-Anchor" href="#stopping-ec2-instances-nightly"></a> Stopping EC2 Instances Nightly</h2>
<p><img src="/photos/aws-note/Stopping-EC2-Instances-Nightly.png" alt="Stopping-EC2-Instances-Nightly.png" /></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># lambda_function.py</span></span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line">    ec2_client = boto3.client(<span class="string">&#x27;ec2&#x27;</span>)</span><br><span class="line">    <span class="comment"># get list of regions</span></span><br><span class="line">    regions = [region[<span class="string">&#x27;RegionName&#x27;</span>] <span class="keyword">for</span> region <span class="keyword">in</span> ec2_client.describe_regions()[<span class="string">&#x27;Regions&#x27;</span>]]</span><br><span class="line">    <span class="comment"># iterate over each region</span></span><br><span class="line">    <span class="keyword">for</span> region <span class="keyword">in</span> regions:</span><br><span class="line">        ec2 = boto3.resource(<span class="string">&#x27;ec2&#x27;</span>, region_name=region)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Region:&#x27;</span>, region)</span><br><span class="line">        <span class="comment"># get only running instances</span></span><br><span class="line">        instances = ec2.instances.<span class="built_in">filter</span>(</span><br><span class="line">            Filters=[</span><br><span class="line">                &#123;<span class="string">&#x27;Name&#x27;</span>: <span class="string">&#x27;instance-state-name&#x27;</span>,</span><br><span class="line">                 <span class="string">&#x27;Values&#x27;</span>: [<span class="string">&#x27;running&#x27;</span>]&#125;</span><br><span class="line">            ]</span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># stop instances</span></span><br><span class="line">        <span class="keyword">for</span> instance <span class="keyword">in</span> instances:</span><br><span class="line">            instance.stop()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;stopped instance:&#x27;</span>, instance.<span class="built_in">id</span>)</span><br></pre></td></tr></table></figure>
<h2 id="backing-up-ec2-instances"><a class="markdownIt-Anchor" href="#backing-up-ec2-instances"></a> Backing Up EC2 Instances</h2>
<p><img src="/photos/aws-note/Backing-Up-EC2-Instances.png" alt="Backing-Up-EC2-Instances" /></p>
<h3 id="create-backups"><a class="markdownIt-Anchor" href="#create-backups"></a> Create-Backups</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line"></span><br><span class="line">    ec2_client = boto3.client(<span class="string">&#x27;ec2&#x27;</span>)</span><br><span class="line">    regions = [region[<span class="string">&#x27;RegionName&#x27;</span>]</span><br><span class="line">               <span class="keyword">for</span> region <span class="keyword">in</span> ec2_client.describe_regions()[<span class="string">&#x27;Regions&#x27;</span>]]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> region <span class="keyword">in</span> regions:</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Instances in EC2 Region &#123;0&#125;:&#x27;</span>.<span class="built_in">format</span>(region))</span><br><span class="line">        ec2 = boto3.resource(<span class="string">&#x27;ec2&#x27;</span>, region_name=region)</span><br><span class="line"></span><br><span class="line">        instances = ec2.instances.<span class="built_in">filter</span>(</span><br><span class="line">            Filters=[</span><br><span class="line">                &#123;<span class="string">&#x27;Name&#x27;</span>: <span class="string">&#x27;tag:backup&#x27;</span>, <span class="string">&#x27;Values&#x27;</span>: [<span class="string">&#x27;true&#x27;</span>]&#125;</span><br><span class="line">            ]</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ISO 8601 timestamp, i.e. 2019-01-31T14:01:58</span></span><br><span class="line">        timestamp = datetime.utcnow().replace(microsecond=<span class="number">0</span>).isoformat()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> instances.<span class="built_in">all</span>():</span><br><span class="line">            <span class="keyword">for</span> v <span class="keyword">in</span> i.volumes.<span class="built_in">all</span>():</span><br><span class="line"></span><br><span class="line">                desc = <span class="string">&#x27;Backup of &#123;0&#125;, volume &#123;1&#125;, created &#123;2&#125;&#x27;</span>.<span class="built_in">format</span>(</span><br><span class="line">                    i.<span class="built_in">id</span>, v.<span class="built_in">id</span>, timestamp)</span><br><span class="line">                <span class="built_in">print</span>(desc)</span><br><span class="line"></span><br><span class="line">                snapshot = v.create_snapshot(Description=desc)</span><br><span class="line"></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Created snapshot:&quot;</span>, snapshot.<span class="built_in">id</span>)</span><br></pre></td></tr></table></figure>
<h3 id="prune-backups"><a class="markdownIt-Anchor" href="#prune-backups"></a> Prune-Backups</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line"></span><br><span class="line">    account_id = boto3.client(<span class="string">&#x27;sts&#x27;</span>).get_caller_identity().get(<span class="string">&#x27;Account&#x27;</span>)</span><br><span class="line">    ec2 = boto3.client(<span class="string">&#x27;ec2&#x27;</span>)</span><br><span class="line">    regions = [region[<span class="string">&#x27;RegionName&#x27;</span>]</span><br><span class="line">               <span class="keyword">for</span> region <span class="keyword">in</span> ec2.describe_regions()[<span class="string">&#x27;Regions&#x27;</span>]]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> region <span class="keyword">in</span> regions:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Region:&quot;</span>, region)</span><br><span class="line">        ec2 = boto3.client(<span class="string">&#x27;ec2&#x27;</span>, region_name=region)</span><br><span class="line">        response = ec2.describe_snapshots(OwnerIds=[account_id])</span><br><span class="line">        snapshots = response[<span class="string">&quot;Snapshots&quot;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Sort snapshots by date ascending</span></span><br><span class="line">        snapshots.sort(key=<span class="keyword">lambda</span> x: x[<span class="string">&quot;StartTime&quot;</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Remove snapshots we want to keep (i.e. 3 most recent)</span></span><br><span class="line">        snapshots = snapshots[:-<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> snapshot <span class="keyword">in</span> snapshots:</span><br><span class="line">            <span class="built_in">id</span> = snapshot[<span class="string">&#x27;SnapshotId&#x27;</span>]</span><br><span class="line">            <span class="keyword">try</span>: <span class="comment"># EBS might be using this snapshot</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Deleting snapshot:&quot;</span>, <span class="built_in">id</span>)</span><br><span class="line">                ec2.delete_snapshot(SnapshotId=<span class="built_in">id</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Snapshot &#123;&#125; in use, skipping.&quot;</span>.<span class="built_in">format</span>(<span class="built_in">id</span>))</span><br><span class="line">                <span class="keyword">continue</span></span><br></pre></td></tr></table></figure>
<h3 id="removing-unattached-ebs-volumes"><a class="markdownIt-Anchor" href="#removing-unattached-ebs-volumes"></a> Removing Unattached EBS Volumes</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params"><span class="built_in">object</span>, context</span>):</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Get list of regions</span></span><br><span class="line">    ec2_client = boto3.client(<span class="string">&#x27;ec2&#x27;</span>)</span><br><span class="line">    regions = [region[<span class="string">&#x27;RegionName&#x27;</span>]</span><br><span class="line">               <span class="keyword">for</span> region <span class="keyword">in</span> ec2_client.describe_regions()[<span class="string">&#x27;Regions&#x27;</span>]]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> region <span class="keyword">in</span> regions:</span><br><span class="line">        ec2 = boto3.resource(<span class="string">&#x27;ec2&#x27;</span>, region_name=region)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Region:&quot;</span>, region)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># List only unattached volumes (&#x27;available&#x27; vs. &#x27;in-use&#x27;)</span></span><br><span class="line">        volumes = ec2.volumes.<span class="built_in">filter</span>(</span><br><span class="line">            Filters=[&#123;<span class="string">&#x27;Name&#x27;</span>: <span class="string">&#x27;status&#x27;</span>, <span class="string">&#x27;Values&#x27;</span>: [<span class="string">&#x27;available&#x27;</span>]&#125;])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> volume <span class="keyword">in</span> volumes:</span><br><span class="line">            v = ec2.Volume(volume.<span class="built_in">id</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Deleting EBS volume: &#123;&#125;, Size: &#123;&#125; GiB&quot;</span>.<span class="built_in">format</span>(v.<span class="built_in">id</span>, v.size))</span><br><span class="line">            v.delete()</span><br></pre></td></tr></table></figure>
<h3 id="deregistering-old-amis"><a class="markdownIt-Anchor" href="#deregistering-old-amis"></a> Deregistering Old AMIs</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> dateutil.parser <span class="keyword">import</span> parse</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">days_old</span>(<span class="params">date</span>):</span><br><span class="line">    parsed = parse(date).replace(tzinfo=<span class="literal">None</span>)</span><br><span class="line">    diff = datetime.datetime.now() - parsed</span><br><span class="line">    <span class="keyword">return</span> diff.days</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Get list of regions</span></span><br><span class="line">    ec2_client = boto3.client(<span class="string">&#x27;ec2&#x27;</span>)</span><br><span class="line">    regions = [region[<span class="string">&#x27;RegionName&#x27;</span>]</span><br><span class="line">               <span class="keyword">for</span> region <span class="keyword">in</span> ec2_client.describe_regions()[<span class="string">&#x27;Regions&#x27;</span>]]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> region <span class="keyword">in</span> regions:</span><br><span class="line">        ec2 = boto3.client(<span class="string">&#x27;ec2&#x27;</span>, region_name=region)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Region:&quot;</span>, region)</span><br><span class="line"></span><br><span class="line">        amis = ec2.describe_images(Owners=[<span class="string">&#x27;self&#x27;</span>])[<span class="string">&#x27;Images&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> ami <span class="keyword">in</span> amis:</span><br><span class="line">            creation_date = ami[<span class="string">&#x27;CreationDate&#x27;</span>]</span><br><span class="line">            age_days = days_old(creation_date)</span><br><span class="line">            image_id = ami[<span class="string">&#x27;ImageId&#x27;</span>]</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;ImageId: &#123;&#125;, CreationDate: &#123;&#125; (&#123;&#125; days old)&#x27;</span>.<span class="built_in">format</span>(</span><br><span class="line">                image_id, creation_date, age_days))</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> age_days &gt;= <span class="number">2</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;Deleting ImageId:&#x27;</span>, image_id)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># Deregister the AMI</span></span><br><span class="line">                ec2.deregister_image(ImageId=image_id)</span><br></pre></td></tr></table></figure>
<h1 id="boto3-dynamodb"><a class="markdownIt-Anchor" href="#boto3-dynamodb"></a> Boto3 - Dynamodb</h1>
<p>This chapter follows <a target="_blank" rel="noopener" href="https://github.com/linuxacademy/content-lambda-boto3">https://github.com/linuxacademy/content-lambda-boto3</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line">client = boto3.client(<span class="string">&#x27;dynamodb&#x27;</span>, endpoint_url=<span class="string">&#x27;http://localhost:8000&#x27;</span>) <span class="comment"># dynamodb-local</span></span><br><span class="line">client.list_tables()</span><br></pre></td></tr></table></figure>
<h3 id="create-tables"><a class="markdownIt-Anchor" href="#create-tables"></a> Create Tables</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">dynamodb = boto3.resource(<span class="string">&#x27;dynamodb&#x27;</span>)</span><br><span class="line"></span><br><span class="line">table = dynamodb.create_table(</span><br><span class="line">    TableName=<span class="string">&#x27;Movies&#x27;</span>,</span><br><span class="line">    KeySchema=[</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&#x27;AttributeName&#x27;</span>: <span class="string">&#x27;year&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;KeyType&#x27;</span>: <span class="string">&#x27;HASH&#x27;</span>  <span class="comment"># Partition key</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&#x27;AttributeName&#x27;</span>: <span class="string">&#x27;title&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;KeyType&#x27;</span>: <span class="string">&#x27;RANGE&#x27;</span>  <span class="comment"># Sort key</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    AttributeDefinitions=[</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&#x27;AttributeName&#x27;</span>: <span class="string">&#x27;year&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;AttributeType&#x27;</span>: <span class="string">&#x27;N&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&#x27;AttributeName&#x27;</span>: <span class="string">&#x27;title&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;AttributeType&#x27;</span>: <span class="string">&#x27;S&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">    ],</span><br><span class="line">    ProvisionedThroughput=&#123;</span><br><span class="line">        <span class="string">&#x27;ReadCapacityUnits&#x27;</span>: <span class="number">5</span>,</span><br><span class="line">        <span class="string">&#x27;WriteCapacityUnits&#x27;</span>: <span class="number">5</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Table status:&#x27;</span>, table.table_status)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Waiting for&#x27;</span>, table.name, <span class="string">&#x27;to complete creating...&#x27;</span>)</span><br><span class="line">table.meta.client.get_waiter(<span class="string">&#x27;table_exists&#x27;</span>).wait(TableName=<span class="string">&#x27;Movies&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Table status:&#x27;</span>, dynamodb.Table(<span class="string">&#x27;Movies&#x27;</span>).table_status)</span><br></pre></td></tr></table></figure>
<h3 id="load-data"><a class="markdownIt-Anchor" href="#load-data"></a> Load Data</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">dynamodb = boto3.resource(<span class="string">&#x27;dynamodb&#x27;</span>)</span><br><span class="line"></span><br><span class="line">table = dynamodb.Table(<span class="string">&#x27;Movies&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;moviedata.json&quot;</span>) <span class="keyword">as</span> json_file:</span><br><span class="line">    movies = json.load(json_file, parse_float=decimal.Decimal)</span><br><span class="line">    <span class="keyword">for</span> movie <span class="keyword">in</span> movies:</span><br><span class="line">        year = <span class="built_in">int</span>(movie[<span class="string">&#x27;year&#x27;</span>])</span><br><span class="line">        title = movie[<span class="string">&#x27;title&#x27;</span>]</span><br><span class="line">        info = movie[<span class="string">&#x27;info&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Adding movie:&quot;</span>, year, title)</span><br><span class="line"></span><br><span class="line">        table.put_item(</span><br><span class="line">            Item=&#123;</span><br><span class="line">                <span class="string">&#x27;year&#x27;</span>: year,</span><br><span class="line">                <span class="string">&#x27;title&#x27;</span>: title,</span><br><span class="line">                <span class="string">&#x27;info&#x27;</span>: info,</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br></pre></td></tr></table></figure>
<p><code>moviedata.json</code>:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;year&quot;</span><span class="punctuation">:</span> <span class="number">2013</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Rush&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;info&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;directors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;Ron Howard&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;release_date&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2013-09-02T00:00:00Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;rating&quot;</span><span class="punctuation">:</span> <span class="number">8.3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;genres&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;Action&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Biography&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Drama&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Sport&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;image_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://ia.media-imdb.com/images/M/MV5BMTQyMDE0MTY0OV5BMl5BanBnXkFtZTcwMjI2OTI0OQ@@._V1_SX400_.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;plot&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A re-creation of the merciless 1970s rivalry between Formula One rivals James Hunt and Niki Lauda.&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;rank&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;running_time_secs&quot;</span><span class="punctuation">:</span> <span class="number">7380</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;actors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;Daniel Bruhl&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Chris Hemsworth&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Olivia Wilde&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>
<h3 id="put-item"><a class="markdownIt-Anchor" href="#put-item"></a> Put Item</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DecimalEncoder</span>(json.JSONEncoder):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;Helper class to convert a DynamoDB item to JSON&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">default</span>(<span class="params">self, o</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(o, decimal.Decimal):</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">abs</span>(o) % <span class="number">1</span> &gt; <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">float</span>(o)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">int</span>(o)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>(DecimalEncoder, <span class="variable language_">self</span>).default(o)</span><br><span class="line"></span><br><span class="line">title = <span class="string">&quot;The Big New Movie&quot;</span></span><br><span class="line">year = <span class="number">2015</span></span><br><span class="line"></span><br><span class="line">response = table.put_item(</span><br><span class="line">    Item=&#123;</span><br><span class="line">        <span class="string">&#x27;year&#x27;</span>: year,</span><br><span class="line">        <span class="string">&#x27;title&#x27;</span>: title,</span><br><span class="line">        <span class="string">&#x27;info&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;plot&#x27;</span>: <span class="string">&quot;Nothing happens at all.&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;rating&#x27;</span>: decimal.Decimal(<span class="number">0</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;PutItem succeeded:&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(json.dumps(response, indent=<span class="number">4</span>, cls=DecimalEncoder))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="get-item"><a class="markdownIt-Anchor" href="#get-item"></a> Get Item</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> botocore.exceptions <span class="keyword">import</span> ClientError</span><br><span class="line"></span><br><span class="line">title = <span class="string">&quot;The Big New Movie&quot;</span></span><br><span class="line">year = <span class="number">2015</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    response = table.get_item(</span><br><span class="line">        Key=&#123;</span><br><span class="line">            <span class="string">&#x27;year&#x27;</span>: year,</span><br><span class="line">            <span class="string">&#x27;title&#x27;</span>: title</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line"><span class="keyword">except</span> ClientError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(e.response[<span class="string">&#x27;Error&#x27;</span>][<span class="string">&#x27;Message&#x27;</span>])</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    item = response[<span class="string">&#x27;Item&#x27;</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;GetItem succeeded:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(json.dumps(item, indent=<span class="number">4</span>, cls=DecimalEncoder))</span><br></pre></td></tr></table></figure>
<h3 id="update-item"><a class="markdownIt-Anchor" href="#update-item"></a> Update Item</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">title = <span class="string">&quot;The Big New Movie&quot;</span></span><br><span class="line">year = <span class="number">2015</span></span><br><span class="line"></span><br><span class="line">response = table.update_item(</span><br><span class="line">    Key=&#123;</span><br><span class="line">        <span class="string">&#x27;year&#x27;</span>: year,</span><br><span class="line">        <span class="string">&#x27;title&#x27;</span>: title</span><br><span class="line">    &#125;,</span><br><span class="line">    UpdateExpression=<span class="string">&quot;set info.rating = :r, info.plot=:p, info.actors=:a&quot;</span>,</span><br><span class="line">    ExpressionAttributeValues=&#123;</span><br><span class="line">        <span class="string">&#x27;:r&#x27;</span>: decimal.Decimal(<span class="number">5.5</span>),</span><br><span class="line">        <span class="string">&#x27;:p&#x27;</span>: <span class="string">&quot;Everything happens all at once.&quot;</span>,</span><br><span class="line">        <span class="string">&#x27;:a&#x27;</span>: [<span class="string">&quot;Larry&quot;</span>, <span class="string">&quot;Moe&quot;</span>, <span class="string">&quot;Curly&quot;</span>]</span><br><span class="line">    &#125;,</span><br><span class="line">    ReturnValues=<span class="string">&quot;UPDATED_NEW&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;UpdateItem succeeded:&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(json.dumps(response, indent=<span class="number">4</span>, cls=DecimalEncoder))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">title = <span class="string">&quot;The Big New Movie&quot;</span></span><br><span class="line">year = <span class="number">2015</span></span><br><span class="line"></span><br><span class="line">response = table.update_item(</span><br><span class="line">    Key=&#123;</span><br><span class="line">        <span class="string">&#x27;year&#x27;</span>: year,</span><br><span class="line">        <span class="string">&#x27;title&#x27;</span>: title</span><br><span class="line">    &#125;,</span><br><span class="line">    UpdateExpression=<span class="string">&quot;set info.rating = info.rating + :val&quot;</span>,</span><br><span class="line">    ExpressionAttributeValues=&#123;</span><br><span class="line">        <span class="string">&#x27;:val&#x27;</span>: decimal.Decimal(<span class="number">1</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    ReturnValues=<span class="string">&quot;UPDATED_NEW&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;UpdateItem succeeded:&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(json.dumps(response, indent=<span class="number">4</span>, cls=DecimalEncoder))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">title = <span class="string">&quot;The Big New Movie&quot;</span></span><br><span class="line">year = <span class="number">2015</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Conditional update (will fail)</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Attempting conditional update...&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    response = table.update_item(</span><br><span class="line">        Key=&#123;</span><br><span class="line">            <span class="string">&#x27;year&#x27;</span>: year,</span><br><span class="line">            <span class="string">&#x27;title&#x27;</span>: title</span><br><span class="line">        &#125;,</span><br><span class="line">        UpdateExpression=<span class="string">&quot;remove info.actors[0]&quot;</span>,</span><br><span class="line">        ConditionExpression=<span class="string">&quot;size(info.actors) &gt;= :num&quot;</span>,</span><br><span class="line">        ExpressionAttributeValues=&#123;</span><br><span class="line">            <span class="string">&#x27;:num&#x27;</span>: <span class="number">3</span></span><br><span class="line">        &#125;,</span><br><span class="line">        ReturnValues=<span class="string">&quot;UPDATED_NEW&quot;</span></span><br><span class="line">    )</span><br><span class="line"><span class="keyword">except</span> ClientError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="keyword">if</span> e.response[<span class="string">&#x27;Error&#x27;</span>][<span class="string">&#x27;Code&#x27;</span>] == <span class="string">&quot;ConditionalCheckFailedException&quot;</span>:</span><br><span class="line">        <span class="built_in">print</span>(e.response[<span class="string">&#x27;Error&#x27;</span>][<span class="string">&#x27;Message&#x27;</span>])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;UpdateItem succeeded:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(json.dumps(response, indent=<span class="number">4</span>, cls=DecimalEncoder))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="delete-item"><a class="markdownIt-Anchor" href="#delete-item"></a> Delete Item</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">title = <span class="string">&quot;The Big New Movie&quot;</span></span><br><span class="line">year = <span class="number">2015</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Attempting a conditional delete...&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    response = table.delete_item(</span><br><span class="line">        Key=&#123;</span><br><span class="line">            <span class="string">&#x27;year&#x27;</span>: year,</span><br><span class="line">            <span class="string">&#x27;title&#x27;</span>: title</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line"><span class="keyword">except</span> ClientError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="keyword">if</span> e.response[<span class="string">&#x27;Error&#x27;</span>][<span class="string">&#x27;Code&#x27;</span>] == <span class="string">&quot;ConditionalCheckFailedException&quot;</span>:</span><br><span class="line">        <span class="built_in">print</span>(e.response[<span class="string">&#x27;Error&#x27;</span>][<span class="string">&#x27;Message&#x27;</span>])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;DeleteItem succeeded:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(json.dumps(response, indent=<span class="number">4</span>, cls=DecimalEncoder))</span><br></pre></td></tr></table></figure>
<h3 id="query"><a class="markdownIt-Anchor" href="#query"></a> Query</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> boto3.dynamodb.conditions <span class="keyword">import</span> Key</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Movies from 1985&quot;</span>)</span><br><span class="line"></span><br><span class="line">response = table.query(</span><br><span class="line">    KeyConditionExpression=Key(<span class="string">&#x27;year&#x27;</span>).eq(<span class="number">1985</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> response[<span class="string">&#x27;Items&#x27;</span>]:</span><br><span class="line">    <span class="built_in">print</span>(i[<span class="string">&#x27;year&#x27;</span>], <span class="string">&quot;:&quot;</span>, i[<span class="string">&#x27;title&#x27;</span>])</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Movies from 1992 - titles A-L, with genres and lead actor&quot;</span>)</span><br><span class="line"></span><br><span class="line">response = table.query(</span><br><span class="line">    ProjectionExpression=<span class="string">&quot;#yr, title, info.genres, info.actors[0]&quot;</span>,</span><br><span class="line">    <span class="comment"># Expression Attribute Names for Projection Expression only.</span></span><br><span class="line">    ExpressionAttributeNames=&#123;<span class="string">&quot;#yr&quot;</span>: <span class="string">&quot;year&quot;</span>&#125;,</span><br><span class="line">    KeyConditionExpression=Key(<span class="string">&#x27;year&#x27;</span>).eq(</span><br><span class="line">        <span class="number">1992</span>) &amp; Key(<span class="string">&#x27;title&#x27;</span>).between(<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;L&#x27;</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> response[<span class="string">u&#x27;Items&#x27;</span>]:</span><br><span class="line">    <span class="built_in">print</span>(json.dumps(i, cls=DecimalEncoder))</span><br></pre></td></tr></table></figure>
<h3 id="scan"><a class="markdownIt-Anchor" href="#scan"></a> Scan</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">fe = Key(<span class="string">&#x27;year&#x27;</span>).between(<span class="number">1950</span>, <span class="number">1959</span>)</span><br><span class="line">pe = <span class="string">&quot;#yr, title, info.rating&quot;</span></span><br><span class="line"><span class="comment"># Expression Attribute Names for Projection Expression only.</span></span><br><span class="line">ean = &#123;<span class="string">&quot;#yr&quot;</span>: <span class="string">&quot;year&quot;</span>, &#125;</span><br><span class="line">esk = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">response = table.scan(</span><br><span class="line">    FilterExpression=fe,</span><br><span class="line">    ProjectionExpression=pe,</span><br><span class="line">    ExpressionAttributeNames=ean</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> response[<span class="string">&#x27;Items&#x27;</span>]:</span><br><span class="line">    <span class="built_in">print</span>(json.dumps(i, cls=DecimalEncoder))</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="string">&#x27;LastEvaluatedKey&#x27;</span> <span class="keyword">in</span> response:</span><br><span class="line">    response = table.scan(</span><br><span class="line">        ProjectionExpression=pe,</span><br><span class="line">        FilterExpression=fe,</span><br><span class="line">        ExpressionAttributeNames=ean,</span><br><span class="line">        ExclusiveStartKey=response[<span class="string">&#x27;LastEvaluatedKey&#x27;</span>]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> response[<span class="string">&#x27;Items&#x27;</span>]:</span><br><span class="line">        <span class="built_in">print</span>(json.dumps(i, cls=DecimalEncoder))</span><br></pre></td></tr></table></figure>
<h3 id="delete-table"><a class="markdownIt-Anchor" href="#delete-table"></a> Delete table</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line">dynamodb = boto3.resource(<span class="string">&#x27;dynamodb&#x27;</span>)</span><br><span class="line"></span><br><span class="line">table = dynamodb.Table(<span class="string">&#x27;Movies&#x27;</span>)</span><br><span class="line"></span><br><span class="line">table.delete()</span><br></pre></td></tr></table></figure>
<h1 id="boto3-s3"><a class="markdownIt-Anchor" href="#boto3-s3"></a> Boto3 - S3</h1>
<p>This chapter follows <a target="_blank" rel="noopener" href="https://github.com/linuxacademy/content-lambda-boto3">https://github.com/linuxacademy/content-lambda-boto3</a></p>
<h2 id="resizing-images"><a class="markdownIt-Anchor" href="#resizing-images"></a> Resizing Images</h2>
<p><img src="/photos/aws-note/Resizing-Images.png" alt="Resizing-Images" /></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line">s3 = boto3.client(<span class="string">&#x27;s3&#x27;</span>)</span><br><span class="line">DEST_BUCKET = os.environ[<span class="string">&#x27;DEST_BUCKET&#x27;</span>]</span><br><span class="line">SIZE = <span class="number">128</span>, <span class="number">128</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> record <span class="keyword">in</span> event[<span class="string">&#x27;Records&#x27;</span>]:</span><br><span class="line">        source_bucket = record[<span class="string">&#x27;s3&#x27;</span>][<span class="string">&#x27;bucket&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">        key = record[<span class="string">&#x27;s3&#x27;</span>][<span class="string">&#x27;object&#x27;</span>][<span class="string">&#x27;key&#x27;</span>]</span><br><span class="line">        thumb = <span class="string">&#x27;thumb-&#x27;</span> + key</span><br><span class="line">        <span class="keyword">with</span> tempfile.TemporaryDirectory() <span class="keyword">as</span> tmpdir:</span><br><span class="line">            download_path = os.path.join(tmpdir, key)</span><br><span class="line">            upload_path = os.path.join(tmpdir, thumb)</span><br><span class="line">            s3.download_file(source_bucket, key, download_path)</span><br><span class="line">            generate_thumbnail(download_path, upload_path)</span><br><span class="line">            s3.upload_file(upload_path, DEST_BUCKET, thumb)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Thumbnail image saved at &#123;&#125;/&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(DEST_BUCKET, thumb))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_thumbnail</span>(<span class="params">source_path, dest_path</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Generating thumbnail from:&#x27;</span>, source_path)</span><br><span class="line">    <span class="keyword">with</span> Image.<span class="built_in">open</span>(source_path) <span class="keyword">as</span> image:</span><br><span class="line">        image.thumbnail(SIZE)</span><br><span class="line">        image.save(dest_path)</span><br></pre></td></tr></table></figure>
<p>To get pillow pkg, find it at <a target="_blank" rel="noopener" href="https://pypi.org/project/Pillow/">https://pypi.org/project/Pillow/</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unzip Pillow-5.4.1-cp37-cp37m-manylinux1_x86_64.whl</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -rf Pillow-5.4.1.dist-info</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zip -r9 lambda.zip lambda_function.py PIL</span><br></pre></td></tr></table></figure>
<p>upload the zip file to AWS Lambda.</p>
<h2 id="importing-csv-files-into-dynamodb"><a class="markdownIt-Anchor" href="#importing-csv-files-into-dynamodb"></a> Importing CSV Files into DynamoDB</h2>
<p><img src="/photos/aws-note/Importing-CSV-Files-into-DynamoDB.png" alt="Importing-CSV-Files-into-DynamoDB" /></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line">dynamodb = boto3.resource(<span class="string">&#x27;dynamodb&#x27;</span>)</span><br><span class="line">table = dynamodb.Table(<span class="string">&#x27;Movies&#x27;</span>)</span><br><span class="line">s3 = boto3.client(<span class="string">&#x27;s3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> record <span class="keyword">in</span> event[<span class="string">&#x27;Records&#x27;</span>]:</span><br><span class="line">        source_bucket = record[<span class="string">&#x27;s3&#x27;</span>][<span class="string">&#x27;bucket&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">        key = record[<span class="string">&#x27;s3&#x27;</span>][<span class="string">&#x27;object&#x27;</span>][<span class="string">&#x27;key&#x27;</span>]</span><br><span class="line">        <span class="keyword">with</span> tempfile.TemporaryDirectory() <span class="keyword">as</span> tmpdir:</span><br><span class="line">            download_path = os.path.join(tmpdir, key)</span><br><span class="line">            s3.download_file(source_bucket, key, download_path)</span><br><span class="line">            items = read_csv(download_path)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">with</span> table.batch_writer() <span class="keyword">as</span> batch:</span><br><span class="line">                <span class="keyword">for</span> item <span class="keyword">in</span> items:</span><br><span class="line">                    batch.put_item(Item=item)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_csv</span>(<span class="params">file</span>):</span><br><span class="line">    items = []</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file) <span class="keyword">as</span> csvfile:</span><br><span class="line">        reader = csv.DictReader(csvfile)</span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> reader:</span><br><span class="line">            data = &#123;&#125;</span><br><span class="line">            data[<span class="string">&#x27;Meta&#x27;</span>] = &#123;&#125;</span><br><span class="line">            data[<span class="string">&#x27;Year&#x27;</span>] = <span class="built_in">int</span>(row[<span class="string">&#x27;Year&#x27;</span>])</span><br><span class="line">            data[<span class="string">&#x27;Title&#x27;</span>] = row[<span class="string">&#x27;Title&#x27;</span>] <span class="keyword">or</span> <span class="literal">None</span></span><br><span class="line">            data[<span class="string">&#x27;Meta&#x27;</span>][<span class="string">&#x27;Length&#x27;</span>] = <span class="built_in">int</span>(row[<span class="string">&#x27;Length&#x27;</span>] <span class="keyword">or</span> <span class="number">0</span>)</span><br><span class="line">            data[<span class="string">&#x27;Meta&#x27;</span>][<span class="string">&#x27;Subject&#x27;</span>] = row[<span class="string">&#x27;Subject&#x27;</span>] <span class="keyword">or</span> <span class="literal">None</span></span><br><span class="line">            data[<span class="string">&#x27;Meta&#x27;</span>][<span class="string">&#x27;Actor&#x27;</span>] = row[<span class="string">&#x27;Actor&#x27;</span>] <span class="keyword">or</span> <span class="literal">None</span></span><br><span class="line">            data[<span class="string">&#x27;Meta&#x27;</span>][<span class="string">&#x27;Actress&#x27;</span>] = row[<span class="string">&#x27;Actress&#x27;</span>] <span class="keyword">or</span> <span class="literal">None</span></span><br><span class="line">            data[<span class="string">&#x27;Meta&#x27;</span>][<span class="string">&#x27;Director&#x27;</span>] = row[<span class="string">&#x27;Director&#x27;</span>] <span class="keyword">or</span> <span class="literal">None</span></span><br><span class="line">            data[<span class="string">&#x27;Meta&#x27;</span>][<span class="string">&#x27;Popularity&#x27;</span>] = row[<span class="string">&#x27;Popularity&#x27;</span>] <span class="keyword">or</span> <span class="literal">None</span></span><br><span class="line">            data[<span class="string">&#x27;Meta&#x27;</span>][<span class="string">&#x27;Awards&#x27;</span>] = row[<span class="string">&#x27;Awards&#x27;</span>] == <span class="string">&#x27;Yes&#x27;</span></span><br><span class="line">            data[<span class="string">&#x27;Meta&#x27;</span>][<span class="string">&#x27;Image&#x27;</span>] = row[<span class="string">&#x27;Image&#x27;</span>] <span class="keyword">or</span> <span class="literal">None</span></span><br><span class="line">            data[<span class="string">&#x27;Meta&#x27;</span>] = &#123;k: v <span class="keyword">for</span> k,</span><br><span class="line">                            v <span class="keyword">in</span> data[<span class="string">&#x27;Meta&#x27;</span>].items() <span class="keyword">if</span> v <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>&#125;</span><br><span class="line">            items.append(data)</span><br><span class="line">    <span class="keyword">return</span> items</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="transcribing-audio"><a class="markdownIt-Anchor" href="#transcribing-audio"></a> Transcribing Audio</h2>
<p><img src="/photos/aws-note/Transcribing-Audio.png" alt="Transcribing-Audio" /></p>
<p>TranscribeAudio:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line">s3 = boto3.client(<span class="string">&#x27;s3&#x27;</span>)</span><br><span class="line">transcribe = boto3.client(<span class="string">&#x27;transcribe&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> record <span class="keyword">in</span> event[<span class="string">&#x27;Records&#x27;</span>]:</span><br><span class="line">        source_bucket = record[<span class="string">&#x27;s3&#x27;</span>][<span class="string">&#x27;bucket&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">        key = record[<span class="string">&#x27;s3&#x27;</span>][<span class="string">&#x27;object&#x27;</span>][<span class="string">&#x27;key&#x27;</span>]</span><br><span class="line">        object_url = <span class="string">&quot;https://s3.amazonaws.com/&#123;0&#125;/&#123;1&#125;&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">            source_bucket, key)</span><br><span class="line">        response = transcribe.start_transcription_job(</span><br><span class="line">            TranscriptionJobName=<span class="string">&#x27;MyTranscriptionJob&#x27;</span>,</span><br><span class="line">            Media=&#123;<span class="string">&#x27;MediaFileUri&#x27;</span>: object_url&#125;,</span><br><span class="line">            MediaFormat=<span class="string">&#x27;mp3&#x27;</span>,</span><br><span class="line">            LanguageCode=<span class="string">&#x27;en-US&#x27;</span></span><br><span class="line">        )</span><br><span class="line">        <span class="built_in">print</span>(response)</span><br></pre></td></tr></table></figure>
<p>ParseTranscription:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BUCKET_NAME = os.environ[<span class="string">&#x27;BUCKET_NAME&#x27;</span>]</span><br><span class="line"></span><br><span class="line">s3 = boto3.resource(<span class="string">&#x27;s3&#x27;</span>)</span><br><span class="line">transcribe = boto3.client(<span class="string">&#x27;transcribe&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line">    job_name = event[<span class="string">&#x27;detail&#x27;</span>][<span class="string">&#x27;TranscriptionJobName&#x27;</span>]</span><br><span class="line">    job = transcribe.get_transcription_job(TranscriptionJobName=job_name)</span><br><span class="line">    uri = job[<span class="string">&#x27;TranscriptionJob&#x27;</span>][<span class="string">&#x27;Transcript&#x27;</span>][<span class="string">&#x27;TranscriptFileUri&#x27;</span>]</span><br><span class="line">    <span class="built_in">print</span>(uri)</span><br><span class="line"></span><br><span class="line">    content = urllib.request.urlopen(uri).read().decode(<span class="string">&#x27;UTF-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(json.dumps(content))</span><br><span class="line"></span><br><span class="line">    data = json.loads(content)</span><br><span class="line"></span><br><span class="line">    text = data[<span class="string">&#x27;results&#x27;</span>][<span class="string">&#x27;transcripts&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;transcript&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="built_in">object</span> = s3.Object(BUCKET_NAME, job_name + <span class="string">&#x27;-asrOutput.txt&#x27;</span>)</span><br><span class="line">    <span class="built_in">object</span>.put(Body=text)</span><br></pre></td></tr></table></figure>
<h2 id="detecting-faces-with-rekognition"><a class="markdownIt-Anchor" href="#detecting-faces-with-rekognition"></a> Detecting Faces with Rekognition</h2>
<p><img src="/photos/aws-note/Detecting-Faces-with-Rekognition.png" alt="Detecting-Faces-with-Rekognition" /></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line">TABLE_NAME = os.environ[<span class="string">&#x27;TABLE_NAME&#x27;</span>]</span><br><span class="line"></span><br><span class="line">dynamodb = boto3.resource(<span class="string">&#x27;dynamodb&#x27;</span>)</span><br><span class="line">table = dynamodb.Table(TABLE_NAME)</span><br><span class="line">s3 = boto3.resource(<span class="string">&#x27;s3&#x27;</span>)</span><br><span class="line">rekognition = boto3.client(<span class="string">&#x27;rekognition&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Get the object from the event</span></span><br><span class="line">    bucket = event[<span class="string">&#x27;Records&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;s3&#x27;</span>][<span class="string">&#x27;bucket&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">    key = event[<span class="string">&#x27;Records&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;s3&#x27;</span>][<span class="string">&#x27;object&#x27;</span>][<span class="string">&#x27;key&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    obj = s3.Object(bucket, key)</span><br><span class="line">    image = obj.get()[<span class="string">&#x27;Body&#x27;</span>].read()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Recognizing celebrities...&#x27;</span>)</span><br><span class="line">    response = rekognition.recognize_celebrities(Image=&#123;<span class="string">&#x27;Bytes&#x27;</span>: image&#125;)</span><br><span class="line"></span><br><span class="line">    names = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> celebrity <span class="keyword">in</span> response[<span class="string">&#x27;CelebrityFaces&#x27;</span>]:</span><br><span class="line">        name = celebrity[<span class="string">&#x27;Name&#x27;</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Name: &#x27;</span> + name)</span><br><span class="line">        names.append(name)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(names)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Saving face data to DynamoDB table:&#x27;</span>, TABLE_NAME)</span><br><span class="line">    response = table.put_item(</span><br><span class="line">        Item=&#123;</span><br><span class="line">            <span class="string">&#x27;key&#x27;</span>: key,</span><br><span class="line">            <span class="string">&#x27;names&#x27;</span>: names,</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">    <span class="built_in">print</span>(response)</span><br></pre></td></tr></table></figure>
<h1 id="boto3-sqs"><a class="markdownIt-Anchor" href="#boto3-sqs"></a> Boto3 - SQS</h1>
<h2 id="triggering-lambda-from-sqs"><a class="markdownIt-Anchor" href="#triggering-lambda-from-sqs"></a> Triggering Lambda from SQS</h2>
<p><img src="/photos/aws-note/Triggering-Lambda-from-SQS.png" alt="Triggering-Lambda-from-SQS" /></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line">QUEUE_NAME = os.environ[<span class="string">&#x27;QUEUE_NAME&#x27;</span>]</span><br><span class="line">MAX_QUEUE_MESSAGES = os.environ[<span class="string">&#x27;MAX_QUEUE_MESSAGES&#x27;</span>]</span><br><span class="line">DYNAMODB_TABLE = os.environ[<span class="string">&#x27;DYNAMODB_TABLE&#x27;</span>]</span><br><span class="line"></span><br><span class="line">sqs = boto3.resource(<span class="string">&#x27;sqs&#x27;</span>)</span><br><span class="line">dynamodb = boto3.resource(<span class="string">&#x27;dynamodb&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Receive messages from SQS queue</span></span><br><span class="line">    queue = sqs.get_queue_by_name(QueueName=QUEUE_NAME)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ApproximateNumberOfMessages:&quot;</span>,</span><br><span class="line">          queue.attributes.get(<span class="string">&#x27;ApproximateNumberOfMessages&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> message <span class="keyword">in</span> queue.receive_messages(</span><br><span class="line">            MaxNumberOfMessages=<span class="built_in">int</span>(MAX_QUEUE_MESSAGES)):</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(message)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Write message to DynamoDB</span></span><br><span class="line">        table = dynamodb.Table(DYNAMODB_TABLE)</span><br><span class="line"></span><br><span class="line">        response = table.put_item(</span><br><span class="line">            Item=&#123;</span><br><span class="line">                <span class="string">&#x27;MessageId&#x27;</span>: message.message_id,</span><br><span class="line">                <span class="string">&#x27;Body&#x27;</span>: message.body,</span><br><span class="line">                <span class="string">&#x27;Timestamp&#x27;</span>: datetime.now().isoformat()</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Wrote message to DynamoDB:&quot;</span>, json.dumps(response))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Delete SQS message</span></span><br><span class="line">        message.delete()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Deleted message:&quot;</span>, message.message_id)</span><br></pre></td></tr></table></figure>
<p>send_message.py:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3.7</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"><span class="keyword">from</span> faker <span class="keyword">import</span> Faker</span><br><span class="line"></span><br><span class="line">parser = argparse.ArgumentParser()</span><br><span class="line">parser.add_argument(<span class="string">&quot;--queue-name&quot;</span>, <span class="string">&quot;-q&quot;</span>, required=<span class="literal">True</span>,</span><br><span class="line">                    <span class="built_in">help</span>=<span class="string">&quot;SQS queue name&quot;</span>)</span><br><span class="line">parser.add_argument(<span class="string">&quot;--interval&quot;</span>, <span class="string">&quot;-i&quot;</span>, required=<span class="literal">True</span>,</span><br><span class="line">                    <span class="built_in">help</span>=<span class="string">&quot;timer interval&quot;</span>, <span class="built_in">type</span>=<span class="built_in">float</span>)</span><br><span class="line">parser.add_argument(<span class="string">&quot;--message&quot;</span>, <span class="string">&quot;-m&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;message to send&quot;</span>)</span><br><span class="line">parser.add_argument(<span class="string">&quot;--log&quot;</span>, <span class="string">&quot;-l&quot;</span>, default=<span class="string">&quot;INFO&quot;</span>,</span><br><span class="line">                    <span class="built_in">help</span>=<span class="string">&quot;logging level&quot;</span>)</span><br><span class="line">args = parser.parse_args()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> args.log:</span><br><span class="line">    logging.basicConfig(</span><br><span class="line">        <span class="built_in">format</span>=<span class="string">&#x27;[%(levelname)s] %(message)s&#x27;</span>, level=args.log)</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    parser.print_help(sys.stderr)</span><br><span class="line"></span><br><span class="line">sqs = boto3.client(<span class="string">&#x27;sqs&#x27;</span>)</span><br><span class="line"></span><br><span class="line">response = sqs.get_queue_url(QueueName=args.queue_name)</span><br><span class="line"></span><br><span class="line">queue_url = response[<span class="string">&#x27;QueueUrl&#x27;</span>]</span><br><span class="line"></span><br><span class="line">logging.info(queue_url)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    message = args.message</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> args.message:</span><br><span class="line">        fake = Faker()</span><br><span class="line">        message = fake.text()</span><br><span class="line"></span><br><span class="line">    logging.info(<span class="string">&#x27;Sending message: &#x27;</span> + message)</span><br><span class="line"></span><br><span class="line">    response = sqs.send_message(</span><br><span class="line">        QueueUrl=queue_url, MessageBody=message)</span><br><span class="line"></span><br><span class="line">    logging.info(<span class="string">&#x27;MessageId: &#x27;</span> + response[<span class="string">&#x27;MessageId&#x27;</span>])</span><br><span class="line">    sleep(args.interval)</span><br></pre></td></tr></table></figure>
<h2 id="creating-a-queue-using-cross-account-permissions"><a class="markdownIt-Anchor" href="#creating-a-queue-using-cross-account-permissions"></a> Creating a Queue Using Cross-Account Permissions</h2>
<p><img src="/photos/aws-note/Creating-a-Queue-Using-Cross-Account-Permissions.png" alt="Creating-a-Queue-Using-Cross-Account-Permissions" /></p>
<p>SQS does not allow API calls such as CreateQueue using cross-account permissions. A workaround is to create and invoke a Lambda function in another account in order to call that API.</p>
<p>Create AWS CLI Profiles<br />
Development account admin:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">aws configure --profile devadmin</span><br><span class="line">Production account admin:</span><br><span class="line"></span><br><span class="line">aws configure --profile prodadmin</span><br></pre></td></tr></table></figure>
<p>Create a Lambda Function in the Production Account<br />
Function name: CreateSQSQueue</p>
<p>See lambda_function.py and assign the role lambda_execution_role.json.</p>
<p>Assign Permissions to the Lambda Function<br />
Add permissions to the production Lambda function that allow it to be invoked by the development account user:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">aws lambda add-permission \</span><br><span class="line">--function-name CreateSQSQueue \</span><br><span class="line">--statement-id DevAccountAccess \</span><br><span class="line">--action <span class="string">&#x27;lambda:InvokeFunction&#x27;</span> \</span><br><span class="line">--principal <span class="string">&#x27;arn:aws:iam::__DEVELOPMENT_ACCOUNT_NUMBER__:user/devadmin&#x27;</span> \</span><br><span class="line">--region us-east-2 \</span><br><span class="line">--profile prodadmin</span><br></pre></td></tr></table></figure>
<p>To view the policy:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">aws lambda get-policy \</span><br><span class="line">--function-name CreateSQSQueue \</span><br><span class="line">--region us-east-2 \</span><br><span class="line">--profile prodadmin</span><br></pre></td></tr></table></figure>
<p>To remove the policy:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">aws lambda remove-permission \</span><br><span class="line">--function-name CreateSQSQueue \</span><br><span class="line">--statement-id DevAccountAccess \</span><br><span class="line">--region us-east-2 \</span><br><span class="line">--profile prodadmin</span><br></pre></td></tr></table></figure>
<p>Invoke the Production Lambda Function from the Development Account:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">aws lambda invoke \</span><br><span class="line">--function-name <span class="string">&#x27;__LAMBDA_FUNCTION_ARN__&#x27;</span> \</span><br><span class="line">--payload <span class="string">&#x27;&#123;&quot;QueueName&quot;: &quot;MyQueue&quot; &#125;&#x27;</span> \</span><br><span class="line">--invocation-type RequestResponse \</span><br><span class="line">--profile devadmin \</span><br><span class="line">--region us-east-2 \</span><br><span class="line">output.txt</span><br></pre></td></tr></table></figure>
<p>lambda_function.py:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line">sqs = boto3.resource(<span class="string">&#x27;sqs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line"></span><br><span class="line">    queue = sqs.create_queue(QueueName=event[<span class="string">&#x27;QueueName&#x27;</span>])</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Queue URL&#x27;</span>, queue.url)</span><br></pre></td></tr></table></figure>
<p>lambda_execution_role.json:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2012-10-17&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;Statement&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;logs:CreateLogGroup&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;logs:CreateLogStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;logs:PutLogEvents&quot;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:logs:*:*:*&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;sqs:CreateQueue&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h1 id="boto3-third-party"><a class="markdownIt-Anchor" href="#boto3-third-party"></a> Boto3 - Third party</h1>
<h2 id="creating-slack-notifications-for-cloudwatch-alarms"><a class="markdownIt-Anchor" href="#creating-slack-notifications-for-cloudwatch-alarms"></a> Creating Slack Notifications for CloudWatch Alarms</h2>
<p><img src="/photos/aws-note/Creating-Slack-Notifications-for-CloudWatch-Alarms.png" alt="Creating-Slack-Notifications-for-CloudWatch-Alarms" /></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> urllib.error <span class="keyword">import</span> HTTPError, URLError</span><br><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> Request, urlopen</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line">ssm = boto3.client(<span class="string">&#x27;ssm&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line">    <span class="built_in">print</span>(json.dumps(event))</span><br><span class="line"></span><br><span class="line">    message = json.loads(event[<span class="string">&#x27;Records&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;Sns&#x27;</span>][<span class="string">&#x27;Message&#x27;</span>])</span><br><span class="line">    <span class="built_in">print</span>(json.dumps(message))</span><br><span class="line"></span><br><span class="line">    alarm_name = message[<span class="string">&#x27;AlarmName&#x27;</span>]</span><br><span class="line">    new_state = message[<span class="string">&#x27;NewStateValue&#x27;</span>]</span><br><span class="line">    reason = message[<span class="string">&#x27;NewStateReason&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    slack_message = &#123;</span><br><span class="line">        <span class="string">&#x27;text&#x27;</span>: <span class="string">f&#x27;:fire: <span class="subst">&#123;alarm_name&#125;</span> state is now <span class="subst">&#123;new_state&#125;</span>: <span class="subst">&#123;reason&#125;</span>\n&#x27;</span></span><br><span class="line">                <span class="string">f&#x27;```\n<span class="subst">&#123;message&#125;</span>```&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    webhook_url = ssm.get_parameter(</span><br><span class="line">        Name=<span class="string">&#x27;SlackWebHookURL&#x27;</span>, WithDecryption=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    req = Request(webhook_url[<span class="string">&#x27;Parameter&#x27;</span>][<span class="string">&#x27;Value&#x27;</span>],</span><br><span class="line">                  json.dumps(slack_message).encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response = urlopen(req)</span><br><span class="line">        response.read()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Message posted to Slack&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> HTTPError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;Request failed: <span class="subst">&#123;e.code&#125;</span> <span class="subst">&#123;e.reason&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="keyword">except</span> URLError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;Server connection failed: <span class="subst">&#123;e.reason&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="creating-a-twitter-app"><a class="markdownIt-Anchor" href="#creating-a-twitter-app"></a> Creating a Twitter App</h2>
<p><img src="/photos/aws-note/Creating-a-Twitter-App.png" alt="Creating-a-Twitter-App" /></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"><span class="keyword">from</span> botocore.exceptions <span class="keyword">import</span> ClientError</span><br><span class="line"><span class="keyword">import</span> tweepy</span><br><span class="line"></span><br><span class="line">BUCKET_NAME = os.environ[<span class="string">&#x27;BUCKET_NAME&#x27;</span>]</span><br><span class="line">KEY = <span class="string">&#x27;data.txt&#x27;</span></span><br><span class="line"></span><br><span class="line">s3 = boto3.resource(<span class="string">&#x27;s3&#x27;</span>)</span><br><span class="line">ssm = boto3.client(<span class="string">&#x27;ssm&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_parameter</span>(<span class="params">param_name</span>):</span><br><span class="line">    response = ssm.get_parameter(Name=param_name, WithDecryption=<span class="literal">True</span>)</span><br><span class="line">    credentials = response[<span class="string">&#x27;Parameter&#x27;</span>][<span class="string">&#x27;Value&#x27;</span>]</span><br><span class="line">    <span class="keyword">return</span> credentials</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_tweet_text</span>():</span><br><span class="line">    filename = <span class="string">&#x27;/tmp/&#x27;</span> + KEY</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        s3.Bucket(BUCKET_NAME).download_file(KEY, filename)</span><br><span class="line">    <span class="keyword">except</span> ClientError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">if</span> e.response[<span class="string">&#x27;Error&#x27;</span>][<span class="string">&#x27;Code&#x27;</span>] == <span class="string">&quot;404&quot;</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;The object <span class="subst">&#123;KEY&#125;</span> does not exist in bucket <span class="subst">&#123;BUCKET_NAME&#125;</span>.&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename) <span class="keyword">as</span> f:</span><br><span class="line">        lines = f.readlines()</span><br><span class="line">        <span class="keyword">return</span> random.choice(lines)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Get SSM parameters</span></span><br><span class="line">    CONSUMER_KEY = get_parameter(<span class="string">&#x27;/TwitterBot/consumer_key&#x27;</span>)</span><br><span class="line">    CONSUMER_SECRET = get_parameter(<span class="string">&#x27;/TwitterBot/consumer_secret&#x27;</span>)</span><br><span class="line">    ACCESS_TOKEN = get_parameter(<span class="string">&#x27;/TwitterBot/access_token&#x27;</span>)</span><br><span class="line">    ACCESS_TOKEN_SECRET = get_parameter(<span class="string">&#x27;/TwitterBot/access_token_secret&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Authenticate Tweepy</span></span><br><span class="line">    auth = tweepy.OAuthHandler(CONSUMER_KEY, CONSUMER_SECRET)</span><br><span class="line">    auth.set_access_token(ACCESS_TOKEN, ACCESS_TOKEN_SECRET)</span><br><span class="line">    api = tweepy.API(auth)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Send tweet</span></span><br><span class="line">    tweet = get_tweet_text()</span><br><span class="line">    <span class="built_in">print</span>(tweet)</span><br><span class="line">    api.update_status(tweet)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/aws/" rel="tag"># aws</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2020/06/08/linux-note/" rel="prev" title="Linux Note">
                  <i class="fa fa-angle-left"></i> Linux Note
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2020/06/08/docker-note/" rel="next" title="Docker Note">
                  Docker Note <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2020 – 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class=""></i>
    </span>
    <span class="author" itemprop="copyrightHolder">You Xie</span>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css" integrity="sha256-UF1fgpAiu3tPJN/uCqEUHNe7pnr+QR0SQDNfgglgtcM=" crossorigin="anonymous">
  <script class="next-config" data-name="katex" type="application/json">{"copy_tex_js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/copy-tex.min.js","integrity":"sha256-Us54+rSGDSTvIhKKUs4kygE2ipA0RXpWWh0/zLqw3bs="}}</script>
  <script src="/js/third-party/math/katex.js"></script>



</body>
</html>
