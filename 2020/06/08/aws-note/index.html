<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
  <title>
    AWS Note |
    
    You Xie&#39;s Blog
  </title>
  <!-- Icon -->
  
    <link rel="shortcut icon" href="/favicon.ico">
    
  
<link rel="stylesheet" href="/css/style.css">

  
  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<script src="/js/pace.min.js"></script>

<meta name="generator" content="Hexo 5.4.2"></head>

<body>
  <main class="content">
    <section class="outer">
  <article id="post-aws-note" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      
  
  <h1 class="article-title" itemprop="name">
    AWS Note
  </h1>
  
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/06/08/aws-note/" class="article-date">
  <time datetime="2020-06-08T06:30:49.000Z" itemprop="datePublished">2020-06-08</time>
</a>
      
    </div>
    

    
    
<div class="tocbot"></div>

    

    <div class="article-entry" itemprop="articleBody">
      
      
      
        <h1 id="AWS-Basics"><a href="#AWS-Basics" class="headerlink" title="AWS Basics"></a>AWS Basics</h1><h2 id="AWS-website"><a href="#AWS-website" class="headerlink" title="AWS website"></a>AWS website</h2><p><a target="_blank" rel="noopener" href="https://infrastructure.aws/">infrastructure.aws</a></p>
<p><a target="_blank" rel="noopener" href="http://awstcocalculator.com/">TCO(total cost of ownership) Calculator</a></p>
<p><a target="_blank" rel="noopener" href="https://calculator.aws/#/">Pricing Calculator</a></p>
<h2 id="Install"><a href="#Install" class="headerlink" title="Install"></a>Install</h2><h3 id="AWS-CLI-and-Boto3"><a href="#AWS-CLI-and-Boto3" class="headerlink" title="AWS CLI and Boto3"></a>AWS CLI and Boto3</h3><h4 id="Amazon-Linux-2"><a href="#Amazon-Linux-2" class="headerlink" title="Amazon Linux 2"></a>Amazon Linux 2</h4><p>The AWS CLI is already installed on Amazon Linux 2.</p>
<p>Install Python 3:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y python3-pip python3 python3-setuptools</span><br></pre></td></tr></table></figure>

<p>Install Boto3:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install boto3 --user</span><br></pre></td></tr></table></figure>

<h4 id="macOS"><a href="#macOS" class="headerlink" title="macOS"></a>macOS</h4><p>Install Python3 using Homebrew:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ruby -e <span class="string">&quot;<span class="subst">$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)</span>&quot;</span></span><br></pre></td></tr></table></figure>

<p>Install Python 3:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install python</span><br></pre></td></tr></table></figure>

<p>Insert the Homebrew Python directory at the top of your PATH environment variable:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=<span class="string">&quot;/usr/local/opt/python/libexec/bin:<span class="variable">$PATH</span>&quot;</span></span><br></pre></td></tr></table></figure>

<p>Verify you are using Python 3:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python --version</span><br></pre></td></tr></table></figure>

<p>Install the AWS CLI and Boto3:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install awscli boto3 --upgrade --user</span><br></pre></td></tr></table></figure>

<h3 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo amazon-linux-extras install docker</span><br></pre></td></tr></table></figure>

<h2 id="Configuring-your-AWS-environment"><a href="#Configuring-your-AWS-environment" class="headerlink" title="Configuring your AWS environment"></a>Configuring your AWS environment</h2><p>Obtain your AWS access key and secret access key from the AWS Management Console. Run the following command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws configure</span><br></pre></td></tr></table></figure>

<p>This sets up a text file that the AWS CLI and Boto3 libraries look at by default for your credentials: <code>~/.aws/credentials</code>.</p>
<p>The file should look like this:</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[default]</span><br><span class="line">aws_access_key_id = AKIAIOSFODNN7EXAMPLE</span><br><span class="line">aws_secret_access_key = wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY</span><br></pre></td></tr></table></figure>

<h2 id="Test-Your-Credentials"><a href="#Test-Your-Credentials" class="headerlink" title="Test Your Credentials"></a>Test Your Credentials</h2><p>AWS CLI<br>Run the following command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws sts get-caller-identity</span><br></pre></td></tr></table></figure>

<p>The output should look like this:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;UserId&quot;</span>: <span class="string">&quot;AIDAJKLMNOPQRSTUVWXYZ&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Account&quot;</span>: <span class="string">&quot;123456789012&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Arn&quot;</span>: <span class="string">&quot;arn:aws:iam::123456789012:userdevuser&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="AWS-CLI"><a href="#AWS-CLI" class="headerlink" title="AWS CLI"></a>AWS CLI</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aws configure</span><br><span class="line">aws sts get-caller-identity</span><br></pre></td></tr></table></figure>

<h2 id="S3"><a href="#S3" class="headerlink" title="S3"></a>S3</h2><p>Upload folder to s3:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws s3 <span class="built_in">cp</span> &lt;path-to-source-folder&gt; s3://&lt;path-to-target-folder&gt; --recursive --exclude <span class="string">&quot;.DS_Store&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="Dynamodb"><a href="#Dynamodb" class="headerlink" title="Dynamodb"></a>Dynamodb</h2><p>create table:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">aws dynamodb create-table \</span><br><span class="line">    --table-name Music \</span><br><span class="line">    --key-schema AttributeName=Artist,KeyType=HASH \</span><br><span class="line">                 AttributeName=SongTitle,KeyType=RANGE \</span><br><span class="line">    --attribute-definitions \</span><br><span class="line">        AttributeName=Artist,AttributeType=S \</span><br><span class="line">        AttributeName=SongTitle,AttributeType=S \</span><br><span class="line">    --provisioned-throughput \</span><br><span class="line">        ReadCapacityUnits=5,WriteCapacityUnits=5</span><br></pre></td></tr></table></figure>

<p>describe table:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws dynamodb describe-table --table-name Music</span><br></pre></td></tr></table></figure>

<p>put item:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">aws dynamodb put-item \</span><br><span class="line">    --table-name Music \</span><br><span class="line">    --item <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">        &quot;Artist&quot;: &#123;&quot;S&quot;: &quot;Dream Theater&quot;&#125;,</span></span><br><span class="line"><span class="string">        &quot;AlbumTitle&quot;: &#123;&quot;S&quot;: &quot;Images and Words&quot;&#125;,</span></span><br><span class="line"><span class="string">        &quot;SongTitle&quot;: &#123;&quot;S&quot;: &quot;Under a Glass Moon&quot;&#125; &#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>scan table:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws dynamodb scan --table-name Music</span><br></pre></td></tr></table></figure>

<h1 id="Boto3-EC2"><a href="#Boto3-EC2" class="headerlink" title="Boto3 - EC2"></a>Boto3 - EC2</h1><p>This section follows <a target="_blank" rel="noopener" href="https://github.com/linuxacademy/content-dynamodb-deepdive">https://github.com/linuxacademy/content-dynamodb-deepdive</a></p>
<h2 id="HelloWorld"><a href="#HelloWorld" class="headerlink" title="HelloWorld"></a>HelloWorld</h2><h3 id="List-all-S3-bucket-name"><a href="#List-all-S3-bucket-name" class="headerlink" title="List all S3 bucket name:"></a>List all S3 bucket name:</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line">s3 = boto3.resource(<span class="string">&#x27;s3&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> bucket <span class="keyword">in</span> s3.buckets.<span class="built_in">all</span>():</span><br><span class="line">    <span class="built_in">print</span>(bucket.name)</span><br></pre></td></tr></table></figure>

<h3 id="Spin-up-an-ec2-instance"><a href="#Spin-up-an-ec2-instance" class="headerlink" title="Spin up an ec2 instance"></a>Spin up an ec2 instance</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line">ec2 = boto3.client(<span class="string">&#x27;ec2&#x27;</span>)</span><br><span class="line">response = ec2.run_instances(</span><br><span class="line">    ImageId=<span class="string">&#x27;ami-0947d2ba12ee1ff75&#x27;</span>, <span class="comment"># Amazon Linux 2 AMI (HVM), SSD Volume Type</span></span><br><span class="line">    InstanceType=<span class="string">&#x27;t2.micro&#x27;</span>,</span><br><span class="line">    KeyName=<span class="string">&#x27;xyshell&#x27;</span>,</span><br><span class="line">    MinCount=<span class="number">1</span>,</span><br><span class="line">    MaxCount=<span class="number">1</span>,</span><br><span class="line">    SubnetId=<span class="string">&#x27;subnet-05b78e3323bcabddc&#x27;</span></span><br><span class="line">)</span><br><span class="line"><span class="built_in">print</span>(response[<span class="string">&#x27;Instances&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;InstanceId&#x27;</span>])</span><br></pre></td></tr></table></figure>

<h2 id="Stopping-EC2-Instances-Nightly"><a href="#Stopping-EC2-Instances-Nightly" class="headerlink" title="Stopping EC2 Instances Nightly"></a>Stopping EC2 Instances Nightly</h2><p><img src="/photos/aws-note/Stopping-EC2-Instances-Nightly.png" alt="Stopping-EC2-Instances-Nightly.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># lambda_function.py</span></span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line">    ec2_client = boto3.client(<span class="string">&#x27;ec2&#x27;</span>)</span><br><span class="line">    <span class="comment"># get list of regions</span></span><br><span class="line">    regions = [region[<span class="string">&#x27;RegionName&#x27;</span>] <span class="keyword">for</span> region <span class="keyword">in</span> ec2_client.describe_regions()[<span class="string">&#x27;Regions&#x27;</span>]]</span><br><span class="line">    <span class="comment"># iterate over each region</span></span><br><span class="line">    <span class="keyword">for</span> region <span class="keyword">in</span> regions:</span><br><span class="line">        ec2 = boto3.resource(<span class="string">&#x27;ec2&#x27;</span>, region_name=region)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Region:&#x27;</span>, region)</span><br><span class="line">        <span class="comment"># get only running instances</span></span><br><span class="line">        instances = ec2.instances.<span class="built_in">filter</span>(</span><br><span class="line">            Filters=[</span><br><span class="line">                &#123;<span class="string">&#x27;Name&#x27;</span>: <span class="string">&#x27;instance-state-name&#x27;</span>,</span><br><span class="line">                 <span class="string">&#x27;Values&#x27;</span>: [<span class="string">&#x27;running&#x27;</span>]&#125;</span><br><span class="line">            ]</span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># stop instances</span></span><br><span class="line">        <span class="keyword">for</span> instance <span class="keyword">in</span> instances:</span><br><span class="line">            instance.stop()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;stopped instance:&#x27;</span>, instance.<span class="built_in">id</span>)</span><br></pre></td></tr></table></figure>

<h2 id="Backing-Up-EC2-Instances"><a href="#Backing-Up-EC2-Instances" class="headerlink" title="Backing Up EC2 Instances"></a>Backing Up EC2 Instances</h2><p><img src="/photos/aws-note/Backing-Up-EC2-Instances.png" alt="Backing-Up-EC2-Instances"></p>
<h3 id="Create-Backups"><a href="#Create-Backups" class="headerlink" title="Create-Backups"></a>Create-Backups</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line"></span><br><span class="line">    ec2_client = boto3.client(<span class="string">&#x27;ec2&#x27;</span>)</span><br><span class="line">    regions = [region[<span class="string">&#x27;RegionName&#x27;</span>]</span><br><span class="line">               <span class="keyword">for</span> region <span class="keyword">in</span> ec2_client.describe_regions()[<span class="string">&#x27;Regions&#x27;</span>]]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> region <span class="keyword">in</span> regions:</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Instances in EC2 Region &#123;0&#125;:&#x27;</span>.<span class="built_in">format</span>(region))</span><br><span class="line">        ec2 = boto3.resource(<span class="string">&#x27;ec2&#x27;</span>, region_name=region)</span><br><span class="line"></span><br><span class="line">        instances = ec2.instances.<span class="built_in">filter</span>(</span><br><span class="line">            Filters=[</span><br><span class="line">                &#123;<span class="string">&#x27;Name&#x27;</span>: <span class="string">&#x27;tag:backup&#x27;</span>, <span class="string">&#x27;Values&#x27;</span>: [<span class="string">&#x27;true&#x27;</span>]&#125;</span><br><span class="line">            ]</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ISO 8601 timestamp, i.e. 2019-01-31T14:01:58</span></span><br><span class="line">        timestamp = datetime.utcnow().replace(microsecond=<span class="number">0</span>).isoformat()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> instances.<span class="built_in">all</span>():</span><br><span class="line">            <span class="keyword">for</span> v <span class="keyword">in</span> i.volumes.<span class="built_in">all</span>():</span><br><span class="line"></span><br><span class="line">                desc = <span class="string">&#x27;Backup of &#123;0&#125;, volume &#123;1&#125;, created &#123;2&#125;&#x27;</span>.<span class="built_in">format</span>(</span><br><span class="line">                    i.<span class="built_in">id</span>, v.<span class="built_in">id</span>, timestamp)</span><br><span class="line">                <span class="built_in">print</span>(desc)</span><br><span class="line"></span><br><span class="line">                snapshot = v.create_snapshot(Description=desc)</span><br><span class="line"></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Created snapshot:&quot;</span>, snapshot.<span class="built_in">id</span>)</span><br></pre></td></tr></table></figure>

<h3 id="Prune-Backups"><a href="#Prune-Backups" class="headerlink" title="Prune-Backups"></a>Prune-Backups</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line"></span><br><span class="line">    account_id = boto3.client(<span class="string">&#x27;sts&#x27;</span>).get_caller_identity().get(<span class="string">&#x27;Account&#x27;</span>)</span><br><span class="line">    ec2 = boto3.client(<span class="string">&#x27;ec2&#x27;</span>)</span><br><span class="line">    regions = [region[<span class="string">&#x27;RegionName&#x27;</span>]</span><br><span class="line">               <span class="keyword">for</span> region <span class="keyword">in</span> ec2.describe_regions()[<span class="string">&#x27;Regions&#x27;</span>]]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> region <span class="keyword">in</span> regions:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Region:&quot;</span>, region)</span><br><span class="line">        ec2 = boto3.client(<span class="string">&#x27;ec2&#x27;</span>, region_name=region)</span><br><span class="line">        response = ec2.describe_snapshots(OwnerIds=[account_id])</span><br><span class="line">        snapshots = response[<span class="string">&quot;Snapshots&quot;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Sort snapshots by date ascending</span></span><br><span class="line">        snapshots.sort(key=<span class="keyword">lambda</span> x: x[<span class="string">&quot;StartTime&quot;</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Remove snapshots we want to keep (i.e. 3 most recent)</span></span><br><span class="line">        snapshots = snapshots[:-<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> snapshot <span class="keyword">in</span> snapshots:</span><br><span class="line">            <span class="built_in">id</span> = snapshot[<span class="string">&#x27;SnapshotId&#x27;</span>]</span><br><span class="line">            <span class="keyword">try</span>: <span class="comment"># EBS might be using this snapshot</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Deleting snapshot:&quot;</span>, <span class="built_in">id</span>)</span><br><span class="line">                ec2.delete_snapshot(SnapshotId=<span class="built_in">id</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Snapshot &#123;&#125; in use, skipping.&quot;</span>.<span class="built_in">format</span>(<span class="built_in">id</span>))</span><br><span class="line">                <span class="keyword">continue</span></span><br></pre></td></tr></table></figure>

<h3 id="Removing-Unattached-EBS-Volumes"><a href="#Removing-Unattached-EBS-Volumes" class="headerlink" title="Removing Unattached EBS Volumes"></a>Removing Unattached EBS Volumes</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params"><span class="built_in">object</span>, context</span>):</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Get list of regions</span></span><br><span class="line">    ec2_client = boto3.client(<span class="string">&#x27;ec2&#x27;</span>)</span><br><span class="line">    regions = [region[<span class="string">&#x27;RegionName&#x27;</span>]</span><br><span class="line">               <span class="keyword">for</span> region <span class="keyword">in</span> ec2_client.describe_regions()[<span class="string">&#x27;Regions&#x27;</span>]]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> region <span class="keyword">in</span> regions:</span><br><span class="line">        ec2 = boto3.resource(<span class="string">&#x27;ec2&#x27;</span>, region_name=region)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Region:&quot;</span>, region)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># List only unattached volumes (&#x27;available&#x27; vs. &#x27;in-use&#x27;)</span></span><br><span class="line">        volumes = ec2.volumes.<span class="built_in">filter</span>(</span><br><span class="line">            Filters=[&#123;<span class="string">&#x27;Name&#x27;</span>: <span class="string">&#x27;status&#x27;</span>, <span class="string">&#x27;Values&#x27;</span>: [<span class="string">&#x27;available&#x27;</span>]&#125;])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> volume <span class="keyword">in</span> volumes:</span><br><span class="line">            v = ec2.Volume(volume.<span class="built_in">id</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Deleting EBS volume: &#123;&#125;, Size: &#123;&#125; GiB&quot;</span>.<span class="built_in">format</span>(v.<span class="built_in">id</span>, v.size))</span><br><span class="line">            v.delete()</span><br></pre></td></tr></table></figure>

<h3 id="Deregistering-Old-AMIs"><a href="#Deregistering-Old-AMIs" class="headerlink" title="Deregistering Old AMIs"></a>Deregistering Old AMIs</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> dateutil.parser <span class="keyword">import</span> parse</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">days_old</span>(<span class="params">date</span>):</span><br><span class="line">    parsed = parse(date).replace(tzinfo=<span class="literal">None</span>)</span><br><span class="line">    diff = datetime.datetime.now() - parsed</span><br><span class="line">    <span class="keyword">return</span> diff.days</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Get list of regions</span></span><br><span class="line">    ec2_client = boto3.client(<span class="string">&#x27;ec2&#x27;</span>)</span><br><span class="line">    regions = [region[<span class="string">&#x27;RegionName&#x27;</span>]</span><br><span class="line">               <span class="keyword">for</span> region <span class="keyword">in</span> ec2_client.describe_regions()[<span class="string">&#x27;Regions&#x27;</span>]]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> region <span class="keyword">in</span> regions:</span><br><span class="line">        ec2 = boto3.client(<span class="string">&#x27;ec2&#x27;</span>, region_name=region)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Region:&quot;</span>, region)</span><br><span class="line"></span><br><span class="line">        amis = ec2.describe_images(Owners=[<span class="string">&#x27;self&#x27;</span>])[<span class="string">&#x27;Images&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> ami <span class="keyword">in</span> amis:</span><br><span class="line">            creation_date = ami[<span class="string">&#x27;CreationDate&#x27;</span>]</span><br><span class="line">            age_days = days_old(creation_date)</span><br><span class="line">            image_id = ami[<span class="string">&#x27;ImageId&#x27;</span>]</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;ImageId: &#123;&#125;, CreationDate: &#123;&#125; (&#123;&#125; days old)&#x27;</span>.<span class="built_in">format</span>(</span><br><span class="line">                image_id, creation_date, age_days))</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> age_days &gt;= <span class="number">2</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;Deleting ImageId:&#x27;</span>, image_id)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># Deregister the AMI</span></span><br><span class="line">                ec2.deregister_image(ImageId=image_id)</span><br></pre></td></tr></table></figure>

<h1 id="Boto3-Dynamodb"><a href="#Boto3-Dynamodb" class="headerlink" title="Boto3 - Dynamodb"></a>Boto3 - Dynamodb</h1><p>This chapter follows <a target="_blank" rel="noopener" href="https://github.com/linuxacademy/content-lambda-boto3">https://github.com/linuxacademy/content-lambda-boto3</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line">client = boto3.client(<span class="string">&#x27;dynamodb&#x27;</span>, endpoint_url=<span class="string">&#x27;http://localhost:8000&#x27;</span>) <span class="comment"># dynamodb-local</span></span><br><span class="line">client.list_tables()</span><br></pre></td></tr></table></figure>

<h3 id="Create-Tables"><a href="#Create-Tables" class="headerlink" title="Create Tables"></a>Create Tables</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">dynamodb = boto3.resource(<span class="string">&#x27;dynamodb&#x27;</span>)</span><br><span class="line"></span><br><span class="line">table = dynamodb.create_table(</span><br><span class="line">    TableName=<span class="string">&#x27;Movies&#x27;</span>,</span><br><span class="line">    KeySchema=[</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&#x27;AttributeName&#x27;</span>: <span class="string">&#x27;year&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;KeyType&#x27;</span>: <span class="string">&#x27;HASH&#x27;</span>  <span class="comment"># Partition key</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&#x27;AttributeName&#x27;</span>: <span class="string">&#x27;title&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;KeyType&#x27;</span>: <span class="string">&#x27;RANGE&#x27;</span>  <span class="comment"># Sort key</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    AttributeDefinitions=[</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&#x27;AttributeName&#x27;</span>: <span class="string">&#x27;year&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;AttributeType&#x27;</span>: <span class="string">&#x27;N&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&#x27;AttributeName&#x27;</span>: <span class="string">&#x27;title&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;AttributeType&#x27;</span>: <span class="string">&#x27;S&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">    ],</span><br><span class="line">    ProvisionedThroughput=&#123;</span><br><span class="line">        <span class="string">&#x27;ReadCapacityUnits&#x27;</span>: <span class="number">5</span>,</span><br><span class="line">        <span class="string">&#x27;WriteCapacityUnits&#x27;</span>: <span class="number">5</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Table status:&#x27;</span>, table.table_status)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Waiting for&#x27;</span>, table.name, <span class="string">&#x27;to complete creating...&#x27;</span>)</span><br><span class="line">table.meta.client.get_waiter(<span class="string">&#x27;table_exists&#x27;</span>).wait(TableName=<span class="string">&#x27;Movies&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Table status:&#x27;</span>, dynamodb.Table(<span class="string">&#x27;Movies&#x27;</span>).table_status)</span><br></pre></td></tr></table></figure>

<h3 id="Load-Data"><a href="#Load-Data" class="headerlink" title="Load Data"></a>Load Data</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">dynamodb = boto3.resource(<span class="string">&#x27;dynamodb&#x27;</span>)</span><br><span class="line"></span><br><span class="line">table = dynamodb.Table(<span class="string">&#x27;Movies&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;moviedata.json&quot;</span>) <span class="keyword">as</span> json_file:</span><br><span class="line">    movies = json.load(json_file, parse_float=decimal.Decimal)</span><br><span class="line">    <span class="keyword">for</span> movie <span class="keyword">in</span> movies:</span><br><span class="line">        year = <span class="built_in">int</span>(movie[<span class="string">&#x27;year&#x27;</span>])</span><br><span class="line">        title = movie[<span class="string">&#x27;title&#x27;</span>]</span><br><span class="line">        info = movie[<span class="string">&#x27;info&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Adding movie:&quot;</span>, year, title)</span><br><span class="line"></span><br><span class="line">        table.put_item(</span><br><span class="line">            Item=&#123;</span><br><span class="line">                <span class="string">&#x27;year&#x27;</span>: year,</span><br><span class="line">                <span class="string">&#x27;title&#x27;</span>: title,</span><br><span class="line">                <span class="string">&#x27;info&#x27;</span>: info,</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br></pre></td></tr></table></figure>

<p><code>moviedata.json</code>:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;year&quot;</span><span class="punctuation">:</span> <span class="number">2013</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Rush&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;info&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;directors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;Ron Howard&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;release_date&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2013-09-02T00:00:00Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;rating&quot;</span><span class="punctuation">:</span> <span class="number">8.3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;genres&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;Action&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Biography&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Drama&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Sport&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;image_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://ia.media-imdb.com/images/M/MV5BMTQyMDE0MTY0OV5BMl5BanBnXkFtZTcwMjI2OTI0OQ@@._V1_SX400_.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;plot&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A re-creation of the merciless 1970s rivalry between Formula One rivals James Hunt and Niki Lauda.&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;rank&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;running_time_secs&quot;</span><span class="punctuation">:</span> <span class="number">7380</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;actors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;Daniel Bruhl&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Chris Hemsworth&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Olivia Wilde&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<h3 id="Put-Item"><a href="#Put-Item" class="headerlink" title="Put Item"></a>Put Item</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DecimalEncoder</span>(json.JSONEncoder):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;Helper class to convert a DynamoDB item to JSON&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">default</span>(<span class="params">self, o</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(o, decimal.Decimal):</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">abs</span>(o) % <span class="number">1</span> &gt; <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">float</span>(o)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">int</span>(o)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>(DecimalEncoder, self).default(o)</span><br><span class="line"></span><br><span class="line">title = <span class="string">&quot;The Big New Movie&quot;</span></span><br><span class="line">year = <span class="number">2015</span></span><br><span class="line"></span><br><span class="line">response = table.put_item(</span><br><span class="line">    Item=&#123;</span><br><span class="line">        <span class="string">&#x27;year&#x27;</span>: year,</span><br><span class="line">        <span class="string">&#x27;title&#x27;</span>: title,</span><br><span class="line">        <span class="string">&#x27;info&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;plot&#x27;</span>: <span class="string">&quot;Nothing happens at all.&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;rating&#x27;</span>: decimal.Decimal(<span class="number">0</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;PutItem succeeded:&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(json.dumps(response, indent=<span class="number">4</span>, cls=DecimalEncoder))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Get-Item"><a href="#Get-Item" class="headerlink" title="Get Item"></a>Get Item</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> botocore.exceptions <span class="keyword">import</span> ClientError</span><br><span class="line"></span><br><span class="line">title = <span class="string">&quot;The Big New Movie&quot;</span></span><br><span class="line">year = <span class="number">2015</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    response = table.get_item(</span><br><span class="line">        Key=&#123;</span><br><span class="line">            <span class="string">&#x27;year&#x27;</span>: year,</span><br><span class="line">            <span class="string">&#x27;title&#x27;</span>: title</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line"><span class="keyword">except</span> ClientError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(e.response[<span class="string">&#x27;Error&#x27;</span>][<span class="string">&#x27;Message&#x27;</span>])</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    item = response[<span class="string">&#x27;Item&#x27;</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;GetItem succeeded:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(json.dumps(item, indent=<span class="number">4</span>, cls=DecimalEncoder))</span><br></pre></td></tr></table></figure>

<h3 id="Update-Item"><a href="#Update-Item" class="headerlink" title="Update Item"></a>Update Item</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">title = <span class="string">&quot;The Big New Movie&quot;</span></span><br><span class="line">year = <span class="number">2015</span></span><br><span class="line"></span><br><span class="line">response = table.update_item(</span><br><span class="line">    Key=&#123;</span><br><span class="line">        <span class="string">&#x27;year&#x27;</span>: year,</span><br><span class="line">        <span class="string">&#x27;title&#x27;</span>: title</span><br><span class="line">    &#125;,</span><br><span class="line">    UpdateExpression=<span class="string">&quot;set info.rating = :r, info.plot=:p, info.actors=:a&quot;</span>,</span><br><span class="line">    ExpressionAttributeValues=&#123;</span><br><span class="line">        <span class="string">&#x27;:r&#x27;</span>: decimal.Decimal(<span class="number">5.5</span>),</span><br><span class="line">        <span class="string">&#x27;:p&#x27;</span>: <span class="string">&quot;Everything happens all at once.&quot;</span>,</span><br><span class="line">        <span class="string">&#x27;:a&#x27;</span>: [<span class="string">&quot;Larry&quot;</span>, <span class="string">&quot;Moe&quot;</span>, <span class="string">&quot;Curly&quot;</span>]</span><br><span class="line">    &#125;,</span><br><span class="line">    ReturnValues=<span class="string">&quot;UPDATED_NEW&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;UpdateItem succeeded:&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(json.dumps(response, indent=<span class="number">4</span>, cls=DecimalEncoder))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">title = <span class="string">&quot;The Big New Movie&quot;</span></span><br><span class="line">year = <span class="number">2015</span></span><br><span class="line"></span><br><span class="line">response = table.update_item(</span><br><span class="line">    Key=&#123;</span><br><span class="line">        <span class="string">&#x27;year&#x27;</span>: year,</span><br><span class="line">        <span class="string">&#x27;title&#x27;</span>: title</span><br><span class="line">    &#125;,</span><br><span class="line">    UpdateExpression=<span class="string">&quot;set info.rating = info.rating + :val&quot;</span>,</span><br><span class="line">    ExpressionAttributeValues=&#123;</span><br><span class="line">        <span class="string">&#x27;:val&#x27;</span>: decimal.Decimal(<span class="number">1</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    ReturnValues=<span class="string">&quot;UPDATED_NEW&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;UpdateItem succeeded:&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(json.dumps(response, indent=<span class="number">4</span>, cls=DecimalEncoder))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">title = <span class="string">&quot;The Big New Movie&quot;</span></span><br><span class="line">year = <span class="number">2015</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Conditional update (will fail)</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Attempting conditional update...&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    response = table.update_item(</span><br><span class="line">        Key=&#123;</span><br><span class="line">            <span class="string">&#x27;year&#x27;</span>: year,</span><br><span class="line">            <span class="string">&#x27;title&#x27;</span>: title</span><br><span class="line">        &#125;,</span><br><span class="line">        UpdateExpression=<span class="string">&quot;remove info.actors[0]&quot;</span>,</span><br><span class="line">        ConditionExpression=<span class="string">&quot;size(info.actors) &gt;= :num&quot;</span>,</span><br><span class="line">        ExpressionAttributeValues=&#123;</span><br><span class="line">            <span class="string">&#x27;:num&#x27;</span>: <span class="number">3</span></span><br><span class="line">        &#125;,</span><br><span class="line">        ReturnValues=<span class="string">&quot;UPDATED_NEW&quot;</span></span><br><span class="line">    )</span><br><span class="line"><span class="keyword">except</span> ClientError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="keyword">if</span> e.response[<span class="string">&#x27;Error&#x27;</span>][<span class="string">&#x27;Code&#x27;</span>] == <span class="string">&quot;ConditionalCheckFailedException&quot;</span>:</span><br><span class="line">        <span class="built_in">print</span>(e.response[<span class="string">&#x27;Error&#x27;</span>][<span class="string">&#x27;Message&#x27;</span>])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;UpdateItem succeeded:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(json.dumps(response, indent=<span class="number">4</span>, cls=DecimalEncoder))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Delete-Item"><a href="#Delete-Item" class="headerlink" title="Delete Item"></a>Delete Item</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">title = <span class="string">&quot;The Big New Movie&quot;</span></span><br><span class="line">year = <span class="number">2015</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Attempting a conditional delete...&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    response = table.delete_item(</span><br><span class="line">        Key=&#123;</span><br><span class="line">            <span class="string">&#x27;year&#x27;</span>: year,</span><br><span class="line">            <span class="string">&#x27;title&#x27;</span>: title</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line"><span class="keyword">except</span> ClientError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="keyword">if</span> e.response[<span class="string">&#x27;Error&#x27;</span>][<span class="string">&#x27;Code&#x27;</span>] == <span class="string">&quot;ConditionalCheckFailedException&quot;</span>:</span><br><span class="line">        <span class="built_in">print</span>(e.response[<span class="string">&#x27;Error&#x27;</span>][<span class="string">&#x27;Message&#x27;</span>])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;DeleteItem succeeded:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(json.dumps(response, indent=<span class="number">4</span>, cls=DecimalEncoder))</span><br></pre></td></tr></table></figure>

<h3 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> boto3.dynamodb.conditions <span class="keyword">import</span> Key</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Movies from 1985&quot;</span>)</span><br><span class="line"></span><br><span class="line">response = table.query(</span><br><span class="line">    KeyConditionExpression=Key(<span class="string">&#x27;year&#x27;</span>).eq(<span class="number">1985</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> response[<span class="string">&#x27;Items&#x27;</span>]:</span><br><span class="line">    <span class="built_in">print</span>(i[<span class="string">&#x27;year&#x27;</span>], <span class="string">&quot;:&quot;</span>, i[<span class="string">&#x27;title&#x27;</span>])</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Movies from 1992 - titles A-L, with genres and lead actor&quot;</span>)</span><br><span class="line"></span><br><span class="line">response = table.query(</span><br><span class="line">    ProjectionExpression=<span class="string">&quot;#yr, title, info.genres, info.actors[0]&quot;</span>,</span><br><span class="line">    <span class="comment"># Expression Attribute Names for Projection Expression only.</span></span><br><span class="line">    ExpressionAttributeNames=&#123;<span class="string">&quot;#yr&quot;</span>: <span class="string">&quot;year&quot;</span>&#125;,</span><br><span class="line">    KeyConditionExpression=Key(<span class="string">&#x27;year&#x27;</span>).eq(</span><br><span class="line">        <span class="number">1992</span>) &amp; Key(<span class="string">&#x27;title&#x27;</span>).between(<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;L&#x27;</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> response[<span class="string">u&#x27;Items&#x27;</span>]:</span><br><span class="line">    <span class="built_in">print</span>(json.dumps(i, cls=DecimalEncoder))</span><br></pre></td></tr></table></figure>

<h3 id="Scan"><a href="#Scan" class="headerlink" title="Scan"></a>Scan</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">fe = Key(<span class="string">&#x27;year&#x27;</span>).between(<span class="number">1950</span>, <span class="number">1959</span>)</span><br><span class="line">pe = <span class="string">&quot;#yr, title, info.rating&quot;</span></span><br><span class="line"><span class="comment"># Expression Attribute Names for Projection Expression only.</span></span><br><span class="line">ean = &#123;<span class="string">&quot;#yr&quot;</span>: <span class="string">&quot;year&quot;</span>, &#125;</span><br><span class="line">esk = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">response = table.scan(</span><br><span class="line">    FilterExpression=fe,</span><br><span class="line">    ProjectionExpression=pe,</span><br><span class="line">    ExpressionAttributeNames=ean</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> response[<span class="string">&#x27;Items&#x27;</span>]:</span><br><span class="line">    <span class="built_in">print</span>(json.dumps(i, cls=DecimalEncoder))</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="string">&#x27;LastEvaluatedKey&#x27;</span> <span class="keyword">in</span> response:</span><br><span class="line">    response = table.scan(</span><br><span class="line">        ProjectionExpression=pe,</span><br><span class="line">        FilterExpression=fe,</span><br><span class="line">        ExpressionAttributeNames=ean,</span><br><span class="line">        ExclusiveStartKey=response[<span class="string">&#x27;LastEvaluatedKey&#x27;</span>]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> response[<span class="string">&#x27;Items&#x27;</span>]:</span><br><span class="line">        <span class="built_in">print</span>(json.dumps(i, cls=DecimalEncoder))</span><br></pre></td></tr></table></figure>

<h3 id="Delete-table"><a href="#Delete-table" class="headerlink" title="Delete table"></a>Delete table</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line">dynamodb = boto3.resource(<span class="string">&#x27;dynamodb&#x27;</span>)</span><br><span class="line"></span><br><span class="line">table = dynamodb.Table(<span class="string">&#x27;Movies&#x27;</span>)</span><br><span class="line"></span><br><span class="line">table.delete()</span><br></pre></td></tr></table></figure>

<h1 id="Boto3-S3"><a href="#Boto3-S3" class="headerlink" title="Boto3 - S3"></a>Boto3 - S3</h1><p>This chapter follows <a target="_blank" rel="noopener" href="https://github.com/linuxacademy/content-lambda-boto3">https://github.com/linuxacademy/content-lambda-boto3</a></p>
<h2 id="Resizing-Images"><a href="#Resizing-Images" class="headerlink" title="Resizing Images"></a>Resizing Images</h2><p><img src="/photos/aws-note/Resizing-Images.png" alt="Resizing-Images"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line">s3 = boto3.client(<span class="string">&#x27;s3&#x27;</span>)</span><br><span class="line">DEST_BUCKET = os.environ[<span class="string">&#x27;DEST_BUCKET&#x27;</span>]</span><br><span class="line">SIZE = <span class="number">128</span>, <span class="number">128</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> record <span class="keyword">in</span> event[<span class="string">&#x27;Records&#x27;</span>]:</span><br><span class="line">        source_bucket = record[<span class="string">&#x27;s3&#x27;</span>][<span class="string">&#x27;bucket&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">        key = record[<span class="string">&#x27;s3&#x27;</span>][<span class="string">&#x27;object&#x27;</span>][<span class="string">&#x27;key&#x27;</span>]</span><br><span class="line">        thumb = <span class="string">&#x27;thumb-&#x27;</span> + key</span><br><span class="line">        <span class="keyword">with</span> tempfile.TemporaryDirectory() <span class="keyword">as</span> tmpdir:</span><br><span class="line">            download_path = os.path.join(tmpdir, key)</span><br><span class="line">            upload_path = os.path.join(tmpdir, thumb)</span><br><span class="line">            s3.download_file(source_bucket, key, download_path)</span><br><span class="line">            generate_thumbnail(download_path, upload_path)</span><br><span class="line">            s3.upload_file(upload_path, DEST_BUCKET, thumb)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Thumbnail image saved at &#123;&#125;/&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(DEST_BUCKET, thumb))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_thumbnail</span>(<span class="params">source_path, dest_path</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Generating thumbnail from:&#x27;</span>, source_path)</span><br><span class="line">    <span class="keyword">with</span> Image.<span class="built_in">open</span>(source_path) <span class="keyword">as</span> image:</span><br><span class="line">        image.thumbnail(SIZE)</span><br><span class="line">        image.save(dest_path)</span><br></pre></td></tr></table></figure>

<p>To get pillow pkg, find it at <a target="_blank" rel="noopener" href="https://pypi.org/project/Pillow/">https://pypi.org/project/Pillow/</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unzip Pillow-5.4.1-cp37-cp37m-manylinux1_x86_64.whl</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -rf Pillow-5.4.1.dist-info</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zip -r9 lambda.zip lambda_function.py PIL</span><br></pre></td></tr></table></figure>

<p>upload the zip file to AWS Lambda.</p>
<h2 id="Importing-CSV-Files-into-DynamoDB"><a href="#Importing-CSV-Files-into-DynamoDB" class="headerlink" title="Importing CSV Files into DynamoDB"></a>Importing CSV Files into DynamoDB</h2><p><img src="/photos/aws-note/Importing-CSV-Files-into-DynamoDB.png" alt="Importing-CSV-Files-into-DynamoDB"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line">dynamodb = boto3.resource(<span class="string">&#x27;dynamodb&#x27;</span>)</span><br><span class="line">table = dynamodb.Table(<span class="string">&#x27;Movies&#x27;</span>)</span><br><span class="line">s3 = boto3.client(<span class="string">&#x27;s3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> record <span class="keyword">in</span> event[<span class="string">&#x27;Records&#x27;</span>]:</span><br><span class="line">        source_bucket = record[<span class="string">&#x27;s3&#x27;</span>][<span class="string">&#x27;bucket&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">        key = record[<span class="string">&#x27;s3&#x27;</span>][<span class="string">&#x27;object&#x27;</span>][<span class="string">&#x27;key&#x27;</span>]</span><br><span class="line">        <span class="keyword">with</span> tempfile.TemporaryDirectory() <span class="keyword">as</span> tmpdir:</span><br><span class="line">            download_path = os.path.join(tmpdir, key)</span><br><span class="line">            s3.download_file(source_bucket, key, download_path)</span><br><span class="line">            items = read_csv(download_path)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">with</span> table.batch_writer() <span class="keyword">as</span> batch:</span><br><span class="line">                <span class="keyword">for</span> item <span class="keyword">in</span> items:</span><br><span class="line">                    batch.put_item(Item=item)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_csv</span>(<span class="params">file</span>):</span><br><span class="line">    items = []</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file) <span class="keyword">as</span> csvfile:</span><br><span class="line">        reader = csv.DictReader(csvfile)</span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> reader:</span><br><span class="line">            data = &#123;&#125;</span><br><span class="line">            data[<span class="string">&#x27;Meta&#x27;</span>] = &#123;&#125;</span><br><span class="line">            data[<span class="string">&#x27;Year&#x27;</span>] = <span class="built_in">int</span>(row[<span class="string">&#x27;Year&#x27;</span>])</span><br><span class="line">            data[<span class="string">&#x27;Title&#x27;</span>] = row[<span class="string">&#x27;Title&#x27;</span>] <span class="keyword">or</span> <span class="literal">None</span></span><br><span class="line">            data[<span class="string">&#x27;Meta&#x27;</span>][<span class="string">&#x27;Length&#x27;</span>] = <span class="built_in">int</span>(row[<span class="string">&#x27;Length&#x27;</span>] <span class="keyword">or</span> <span class="number">0</span>)</span><br><span class="line">            data[<span class="string">&#x27;Meta&#x27;</span>][<span class="string">&#x27;Subject&#x27;</span>] = row[<span class="string">&#x27;Subject&#x27;</span>] <span class="keyword">or</span> <span class="literal">None</span></span><br><span class="line">            data[<span class="string">&#x27;Meta&#x27;</span>][<span class="string">&#x27;Actor&#x27;</span>] = row[<span class="string">&#x27;Actor&#x27;</span>] <span class="keyword">or</span> <span class="literal">None</span></span><br><span class="line">            data[<span class="string">&#x27;Meta&#x27;</span>][<span class="string">&#x27;Actress&#x27;</span>] = row[<span class="string">&#x27;Actress&#x27;</span>] <span class="keyword">or</span> <span class="literal">None</span></span><br><span class="line">            data[<span class="string">&#x27;Meta&#x27;</span>][<span class="string">&#x27;Director&#x27;</span>] = row[<span class="string">&#x27;Director&#x27;</span>] <span class="keyword">or</span> <span class="literal">None</span></span><br><span class="line">            data[<span class="string">&#x27;Meta&#x27;</span>][<span class="string">&#x27;Popularity&#x27;</span>] = row[<span class="string">&#x27;Popularity&#x27;</span>] <span class="keyword">or</span> <span class="literal">None</span></span><br><span class="line">            data[<span class="string">&#x27;Meta&#x27;</span>][<span class="string">&#x27;Awards&#x27;</span>] = row[<span class="string">&#x27;Awards&#x27;</span>] == <span class="string">&#x27;Yes&#x27;</span></span><br><span class="line">            data[<span class="string">&#x27;Meta&#x27;</span>][<span class="string">&#x27;Image&#x27;</span>] = row[<span class="string">&#x27;Image&#x27;</span>] <span class="keyword">or</span> <span class="literal">None</span></span><br><span class="line">            data[<span class="string">&#x27;Meta&#x27;</span>] = &#123;k: v <span class="keyword">for</span> k,</span><br><span class="line">                            v <span class="keyword">in</span> data[<span class="string">&#x27;Meta&#x27;</span>].items() <span class="keyword">if</span> v <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>&#125;</span><br><span class="line">            items.append(data)</span><br><span class="line">    <span class="keyword">return</span> items</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Transcribing-Audio"><a href="#Transcribing-Audio" class="headerlink" title="Transcribing Audio"></a>Transcribing Audio</h2><p><img src="/photos/aws-note/Transcribing-Audio.png" alt="Transcribing-Audio"></p>
<p>TranscribeAudio:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line">s3 = boto3.client(<span class="string">&#x27;s3&#x27;</span>)</span><br><span class="line">transcribe = boto3.client(<span class="string">&#x27;transcribe&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> record <span class="keyword">in</span> event[<span class="string">&#x27;Records&#x27;</span>]:</span><br><span class="line">        source_bucket = record[<span class="string">&#x27;s3&#x27;</span>][<span class="string">&#x27;bucket&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">        key = record[<span class="string">&#x27;s3&#x27;</span>][<span class="string">&#x27;object&#x27;</span>][<span class="string">&#x27;key&#x27;</span>]</span><br><span class="line">        object_url = <span class="string">&quot;https://s3.amazonaws.com/&#123;0&#125;/&#123;1&#125;&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">            source_bucket, key)</span><br><span class="line">        response = transcribe.start_transcription_job(</span><br><span class="line">            TranscriptionJobName=<span class="string">&#x27;MyTranscriptionJob&#x27;</span>,</span><br><span class="line">            Media=&#123;<span class="string">&#x27;MediaFileUri&#x27;</span>: object_url&#125;,</span><br><span class="line">            MediaFormat=<span class="string">&#x27;mp3&#x27;</span>,</span><br><span class="line">            LanguageCode=<span class="string">&#x27;en-US&#x27;</span></span><br><span class="line">        )</span><br><span class="line">        <span class="built_in">print</span>(response)</span><br></pre></td></tr></table></figure>

<p>ParseTranscription:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BUCKET_NAME = os.environ[<span class="string">&#x27;BUCKET_NAME&#x27;</span>]</span><br><span class="line"></span><br><span class="line">s3 = boto3.resource(<span class="string">&#x27;s3&#x27;</span>)</span><br><span class="line">transcribe = boto3.client(<span class="string">&#x27;transcribe&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line">    job_name = event[<span class="string">&#x27;detail&#x27;</span>][<span class="string">&#x27;TranscriptionJobName&#x27;</span>]</span><br><span class="line">    job = transcribe.get_transcription_job(TranscriptionJobName=job_name)</span><br><span class="line">    uri = job[<span class="string">&#x27;TranscriptionJob&#x27;</span>][<span class="string">&#x27;Transcript&#x27;</span>][<span class="string">&#x27;TranscriptFileUri&#x27;</span>]</span><br><span class="line">    <span class="built_in">print</span>(uri)</span><br><span class="line"></span><br><span class="line">    content = urllib.request.urlopen(uri).read().decode(<span class="string">&#x27;UTF-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(json.dumps(content))</span><br><span class="line"></span><br><span class="line">    data = json.loads(content)</span><br><span class="line"></span><br><span class="line">    text = data[<span class="string">&#x27;results&#x27;</span>][<span class="string">&#x27;transcripts&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;transcript&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="built_in">object</span> = s3.Object(BUCKET_NAME, job_name + <span class="string">&#x27;-asrOutput.txt&#x27;</span>)</span><br><span class="line">    <span class="built_in">object</span>.put(Body=text)</span><br></pre></td></tr></table></figure>

<h2 id="Detecting-Faces-with-Rekognition"><a href="#Detecting-Faces-with-Rekognition" class="headerlink" title="Detecting Faces with Rekognition"></a>Detecting Faces with Rekognition</h2><p><img src="/photos/aws-note/Detecting-Faces-with-Rekognition.png" alt="Detecting-Faces-with-Rekognition"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line">TABLE_NAME = os.environ[<span class="string">&#x27;TABLE_NAME&#x27;</span>]</span><br><span class="line"></span><br><span class="line">dynamodb = boto3.resource(<span class="string">&#x27;dynamodb&#x27;</span>)</span><br><span class="line">table = dynamodb.Table(TABLE_NAME)</span><br><span class="line">s3 = boto3.resource(<span class="string">&#x27;s3&#x27;</span>)</span><br><span class="line">rekognition = boto3.client(<span class="string">&#x27;rekognition&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Get the object from the event</span></span><br><span class="line">    bucket = event[<span class="string">&#x27;Records&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;s3&#x27;</span>][<span class="string">&#x27;bucket&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">    key = event[<span class="string">&#x27;Records&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;s3&#x27;</span>][<span class="string">&#x27;object&#x27;</span>][<span class="string">&#x27;key&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    obj = s3.Object(bucket, key)</span><br><span class="line">    image = obj.get()[<span class="string">&#x27;Body&#x27;</span>].read()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Recognizing celebrities...&#x27;</span>)</span><br><span class="line">    response = rekognition.recognize_celebrities(Image=&#123;<span class="string">&#x27;Bytes&#x27;</span>: image&#125;)</span><br><span class="line"></span><br><span class="line">    names = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> celebrity <span class="keyword">in</span> response[<span class="string">&#x27;CelebrityFaces&#x27;</span>]:</span><br><span class="line">        name = celebrity[<span class="string">&#x27;Name&#x27;</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Name: &#x27;</span> + name)</span><br><span class="line">        names.append(name)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(names)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Saving face data to DynamoDB table:&#x27;</span>, TABLE_NAME)</span><br><span class="line">    response = table.put_item(</span><br><span class="line">        Item=&#123;</span><br><span class="line">            <span class="string">&#x27;key&#x27;</span>: key,</span><br><span class="line">            <span class="string">&#x27;names&#x27;</span>: names,</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">    <span class="built_in">print</span>(response)</span><br></pre></td></tr></table></figure>

<h1 id="Boto3-SQS"><a href="#Boto3-SQS" class="headerlink" title="Boto3 - SQS"></a>Boto3 - SQS</h1><h2 id="Triggering-Lambda-from-SQS"><a href="#Triggering-Lambda-from-SQS" class="headerlink" title="Triggering Lambda from SQS"></a>Triggering Lambda from SQS</h2><p><img src="/photos/aws-note/Triggering-Lambda-from-SQS.png" alt="Triggering-Lambda-from-SQS"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line">QUEUE_NAME = os.environ[<span class="string">&#x27;QUEUE_NAME&#x27;</span>]</span><br><span class="line">MAX_QUEUE_MESSAGES = os.environ[<span class="string">&#x27;MAX_QUEUE_MESSAGES&#x27;</span>]</span><br><span class="line">DYNAMODB_TABLE = os.environ[<span class="string">&#x27;DYNAMODB_TABLE&#x27;</span>]</span><br><span class="line"></span><br><span class="line">sqs = boto3.resource(<span class="string">&#x27;sqs&#x27;</span>)</span><br><span class="line">dynamodb = boto3.resource(<span class="string">&#x27;dynamodb&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Receive messages from SQS queue</span></span><br><span class="line">    queue = sqs.get_queue_by_name(QueueName=QUEUE_NAME)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ApproximateNumberOfMessages:&quot;</span>,</span><br><span class="line">          queue.attributes.get(<span class="string">&#x27;ApproximateNumberOfMessages&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> message <span class="keyword">in</span> queue.receive_messages(</span><br><span class="line">            MaxNumberOfMessages=<span class="built_in">int</span>(MAX_QUEUE_MESSAGES)):</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(message)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Write message to DynamoDB</span></span><br><span class="line">        table = dynamodb.Table(DYNAMODB_TABLE)</span><br><span class="line"></span><br><span class="line">        response = table.put_item(</span><br><span class="line">            Item=&#123;</span><br><span class="line">                <span class="string">&#x27;MessageId&#x27;</span>: message.message_id,</span><br><span class="line">                <span class="string">&#x27;Body&#x27;</span>: message.body,</span><br><span class="line">                <span class="string">&#x27;Timestamp&#x27;</span>: datetime.now().isoformat()</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Wrote message to DynamoDB:&quot;</span>, json.dumps(response))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Delete SQS message</span></span><br><span class="line">        message.delete()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Deleted message:&quot;</span>, message.message_id)</span><br></pre></td></tr></table></figure>

<p>send_message.py:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3.7</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"><span class="keyword">from</span> faker <span class="keyword">import</span> Faker</span><br><span class="line"></span><br><span class="line">parser = argparse.ArgumentParser()</span><br><span class="line">parser.add_argument(<span class="string">&quot;--queue-name&quot;</span>, <span class="string">&quot;-q&quot;</span>, required=<span class="literal">True</span>,</span><br><span class="line">                    <span class="built_in">help</span>=<span class="string">&quot;SQS queue name&quot;</span>)</span><br><span class="line">parser.add_argument(<span class="string">&quot;--interval&quot;</span>, <span class="string">&quot;-i&quot;</span>, required=<span class="literal">True</span>,</span><br><span class="line">                    <span class="built_in">help</span>=<span class="string">&quot;timer interval&quot;</span>, <span class="built_in">type</span>=<span class="built_in">float</span>)</span><br><span class="line">parser.add_argument(<span class="string">&quot;--message&quot;</span>, <span class="string">&quot;-m&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;message to send&quot;</span>)</span><br><span class="line">parser.add_argument(<span class="string">&quot;--log&quot;</span>, <span class="string">&quot;-l&quot;</span>, default=<span class="string">&quot;INFO&quot;</span>,</span><br><span class="line">                    <span class="built_in">help</span>=<span class="string">&quot;logging level&quot;</span>)</span><br><span class="line">args = parser.parse_args()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> args.log:</span><br><span class="line">    logging.basicConfig(</span><br><span class="line">        <span class="built_in">format</span>=<span class="string">&#x27;[%(levelname)s] %(message)s&#x27;</span>, level=args.log)</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    parser.print_help(sys.stderr)</span><br><span class="line"></span><br><span class="line">sqs = boto3.client(<span class="string">&#x27;sqs&#x27;</span>)</span><br><span class="line"></span><br><span class="line">response = sqs.get_queue_url(QueueName=args.queue_name)</span><br><span class="line"></span><br><span class="line">queue_url = response[<span class="string">&#x27;QueueUrl&#x27;</span>]</span><br><span class="line"></span><br><span class="line">logging.info(queue_url)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    message = args.message</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> args.message:</span><br><span class="line">        fake = Faker()</span><br><span class="line">        message = fake.text()</span><br><span class="line"></span><br><span class="line">    logging.info(<span class="string">&#x27;Sending message: &#x27;</span> + message)</span><br><span class="line"></span><br><span class="line">    response = sqs.send_message(</span><br><span class="line">        QueueUrl=queue_url, MessageBody=message)</span><br><span class="line"></span><br><span class="line">    logging.info(<span class="string">&#x27;MessageId: &#x27;</span> + response[<span class="string">&#x27;MessageId&#x27;</span>])</span><br><span class="line">    sleep(args.interval)</span><br></pre></td></tr></table></figure>

<h2 id="Creating-a-Queue-Using-Cross-Account-Permissions"><a href="#Creating-a-Queue-Using-Cross-Account-Permissions" class="headerlink" title="Creating a Queue Using Cross-Account Permissions"></a>Creating a Queue Using Cross-Account Permissions</h2><p><img src="/photos/aws-note/Creating-a-Queue-Using-Cross-Account-Permissions.png" alt="Creating-a-Queue-Using-Cross-Account-Permissions"></p>
<p>SQS does not allow API calls such as CreateQueue using cross-account permissions. A workaround is to create and invoke a Lambda function in another account in order to call that API.</p>
<p>Create AWS CLI Profiles<br>Development account admin:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">aws configure --profile devadmin</span><br><span class="line">Production account admin:</span><br><span class="line"></span><br><span class="line">aws configure --profile prodadmin</span><br></pre></td></tr></table></figure>

<p>Create a Lambda Function in the Production Account<br>Function name: CreateSQSQueue</p>
<p>See lambda_function.py and assign the role lambda_execution_role.json.</p>
<p>Assign Permissions to the Lambda Function<br>Add permissions to the production Lambda function that allow it to be invoked by the development account user:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">aws lambda add-permission \</span><br><span class="line">--function-name CreateSQSQueue \</span><br><span class="line">--statement-id DevAccountAccess \</span><br><span class="line">--action <span class="string">&#x27;lambda:InvokeFunction&#x27;</span> \</span><br><span class="line">--principal <span class="string">&#x27;arn:aws:iam::__DEVELOPMENT_ACCOUNT_NUMBER__:user/devadmin&#x27;</span> \</span><br><span class="line">--region us-east-2 \</span><br><span class="line">--profile prodadmin</span><br></pre></td></tr></table></figure>

<p>To view the policy:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">aws lambda get-policy \</span><br><span class="line">--function-name CreateSQSQueue \</span><br><span class="line">--region us-east-2 \</span><br><span class="line">--profile prodadmin</span><br></pre></td></tr></table></figure>

<p>To remove the policy:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">aws lambda remove-permission \</span><br><span class="line">--function-name CreateSQSQueue \</span><br><span class="line">--statement-id DevAccountAccess \</span><br><span class="line">--region us-east-2 \</span><br><span class="line">--profile prodadmin</span><br></pre></td></tr></table></figure>

<p>Invoke the Production Lambda Function from the Development Account:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">aws lambda invoke \</span><br><span class="line">--function-name <span class="string">&#x27;__LAMBDA_FUNCTION_ARN__&#x27;</span> \</span><br><span class="line">--payload <span class="string">&#x27;&#123;&quot;QueueName&quot;: &quot;MyQueue&quot; &#125;&#x27;</span> \</span><br><span class="line">--invocation-type RequestResponse \</span><br><span class="line">--profile devadmin \</span><br><span class="line">--region us-east-2 \</span><br><span class="line">output.txt</span><br></pre></td></tr></table></figure>

<p>lambda_function.py:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line">sqs = boto3.resource(<span class="string">&#x27;sqs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line"></span><br><span class="line">    queue = sqs.create_queue(QueueName=event[<span class="string">&#x27;QueueName&#x27;</span>])</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Queue URL&#x27;</span>, queue.url)</span><br></pre></td></tr></table></figure>

<p>lambda_execution_role.json:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2012-10-17&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;Statement&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;logs:CreateLogGroup&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;logs:CreateLogStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;logs:PutLogEvents&quot;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:logs:*:*:*&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;sqs:CreateQueue&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h1 id="Boto3-Third-party"><a href="#Boto3-Third-party" class="headerlink" title="Boto3 - Third party"></a>Boto3 - Third party</h1><h2 id="Creating-Slack-Notifications-for-CloudWatch-Alarms"><a href="#Creating-Slack-Notifications-for-CloudWatch-Alarms" class="headerlink" title="Creating Slack Notifications for CloudWatch Alarms"></a>Creating Slack Notifications for CloudWatch Alarms</h2><p><img src="/photos/aws-note/Creating-Slack-Notifications-for-CloudWatch-Alarms.png" alt="Creating-Slack-Notifications-for-CloudWatch-Alarms"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> urllib.error <span class="keyword">import</span> HTTPError, URLError</span><br><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> Request, urlopen</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line">ssm = boto3.client(<span class="string">&#x27;ssm&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line">    <span class="built_in">print</span>(json.dumps(event))</span><br><span class="line"></span><br><span class="line">    message = json.loads(event[<span class="string">&#x27;Records&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;Sns&#x27;</span>][<span class="string">&#x27;Message&#x27;</span>])</span><br><span class="line">    <span class="built_in">print</span>(json.dumps(message))</span><br><span class="line"></span><br><span class="line">    alarm_name = message[<span class="string">&#x27;AlarmName&#x27;</span>]</span><br><span class="line">    new_state = message[<span class="string">&#x27;NewStateValue&#x27;</span>]</span><br><span class="line">    reason = message[<span class="string">&#x27;NewStateReason&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    slack_message = &#123;</span><br><span class="line">        <span class="string">&#x27;text&#x27;</span>: <span class="string">f&#x27;:fire: <span class="subst">&#123;alarm_name&#125;</span> state is now <span class="subst">&#123;new_state&#125;</span>: <span class="subst">&#123;reason&#125;</span>\n&#x27;</span></span><br><span class="line">                <span class="string">f&#x27;```\n<span class="subst">&#123;message&#125;</span>```&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    webhook_url = ssm.get_parameter(</span><br><span class="line">        Name=<span class="string">&#x27;SlackWebHookURL&#x27;</span>, WithDecryption=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    req = Request(webhook_url[<span class="string">&#x27;Parameter&#x27;</span>][<span class="string">&#x27;Value&#x27;</span>],</span><br><span class="line">                  json.dumps(slack_message).encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response = urlopen(req)</span><br><span class="line">        response.read()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Message posted to Slack&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> HTTPError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;Request failed: <span class="subst">&#123;e.code&#125;</span> <span class="subst">&#123;e.reason&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="keyword">except</span> URLError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;Server connection failed: <span class="subst">&#123;e.reason&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="Creating-a-Twitter-App"><a href="#Creating-a-Twitter-App" class="headerlink" title="Creating a Twitter App"></a>Creating a Twitter App</h2><p><img src="/photos/aws-note/Creating-a-Twitter-App.png" alt="Creating-a-Twitter-App"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"><span class="keyword">from</span> botocore.exceptions <span class="keyword">import</span> ClientError</span><br><span class="line"><span class="keyword">import</span> tweepy</span><br><span class="line"></span><br><span class="line">BUCKET_NAME = os.environ[<span class="string">&#x27;BUCKET_NAME&#x27;</span>]</span><br><span class="line">KEY = <span class="string">&#x27;data.txt&#x27;</span></span><br><span class="line"></span><br><span class="line">s3 = boto3.resource(<span class="string">&#x27;s3&#x27;</span>)</span><br><span class="line">ssm = boto3.client(<span class="string">&#x27;ssm&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_parameter</span>(<span class="params">param_name</span>):</span><br><span class="line">    response = ssm.get_parameter(Name=param_name, WithDecryption=<span class="literal">True</span>)</span><br><span class="line">    credentials = response[<span class="string">&#x27;Parameter&#x27;</span>][<span class="string">&#x27;Value&#x27;</span>]</span><br><span class="line">    <span class="keyword">return</span> credentials</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_tweet_text</span>():</span><br><span class="line">    filename = <span class="string">&#x27;/tmp/&#x27;</span> + KEY</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        s3.Bucket(BUCKET_NAME).download_file(KEY, filename)</span><br><span class="line">    <span class="keyword">except</span> ClientError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">if</span> e.response[<span class="string">&#x27;Error&#x27;</span>][<span class="string">&#x27;Code&#x27;</span>] == <span class="string">&quot;404&quot;</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;The object <span class="subst">&#123;KEY&#125;</span> does not exist in bucket <span class="subst">&#123;BUCKET_NAME&#125;</span>.&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename) <span class="keyword">as</span> f:</span><br><span class="line">        lines = f.readlines()</span><br><span class="line">        <span class="keyword">return</span> random.choice(lines)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Get SSM parameters</span></span><br><span class="line">    CONSUMER_KEY = get_parameter(<span class="string">&#x27;/TwitterBot/consumer_key&#x27;</span>)</span><br><span class="line">    CONSUMER_SECRET = get_parameter(<span class="string">&#x27;/TwitterBot/consumer_secret&#x27;</span>)</span><br><span class="line">    ACCESS_TOKEN = get_parameter(<span class="string">&#x27;/TwitterBot/access_token&#x27;</span>)</span><br><span class="line">    ACCESS_TOKEN_SECRET = get_parameter(<span class="string">&#x27;/TwitterBot/access_token_secret&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Authenticate Tweepy</span></span><br><span class="line">    auth = tweepy.OAuthHandler(CONSUMER_KEY, CONSUMER_SECRET)</span><br><span class="line">    auth.set_access_token(ACCESS_TOKEN, ACCESS_TOKEN_SECRET)</span><br><span class="line">    api = tweepy.API(auth)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Send tweet</span></span><br><span class="line">    tweet = get_tweet_text()</span><br><span class="line">    <span class="built_in">print</span>(tweet)</span><br><span class="line">    api.update_status(tweet)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://xyshell.github.io/2020/06/08/aws-note/" data-id="clykq2ryh00014495cyjf93xu" class="article-share-link">
        Share
      </a>
      
<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/aws/" rel="tag">aws</a></li></ul>

    </footer>

  </div>

  
  
<nav class="article-nav">
  
  <a href="/2020/06/08/docker-note/" class="article-nav-link">
    <strong class="article-nav-caption">Newer</strong>
    <div class="article-nav-title">
      
      Docker Note
      
    </div>
  </a>
  
  
  <a href="/2020/06/08/linux-note/" class="article-nav-link">
    <strong class="article-nav-caption">Older</strong>
    <div class="article-nav-title">Linux Note</div>
  </a>
  
</nav>

  

  
  
  
  

</article>
</section>
    <footer class="footer">
  <div class="outer">
    <ul class="list-inline">
      <li>You Xie&#39;s Blog &copy; 2024</li>
      
        <li>
          
            <a href="https://beian.miit.gov.cn/" target="_blank"></a>
            
        </li>
      
      <li>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></li>
      <li>theme  <a target="_blank" rel="noopener" href="https://github.com/zhwangart/hexo-theme-ocean">Ocean</a></li>
    </ul>
    <p><ul class="list-inline">
  
  <li><i class="fe fe-smile-alt tooltip" data-tooltip="UV"></i> <span id="busuanzi_value_site_uv"></span></li>
  
  <li><i class="fe fe-bookmark tooltip" data-tooltip="PV"></i> <span id="busuanzi_value_page_pv"></span></li>
  
</ul></p>
  </div>
</footer>
  </main>
  <aside class="sidebar">
    <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/hexo.svg" alt="You Xie&#39;s Blog"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">Home</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">Archives</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/gallery">Gallery</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">About</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link nav-item-search" title="Search">
        <i class="fe fe-search"></i>
        Search
      </a>
    </li>
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      <div class="totop" id="totop">
  <i class="fe fe-rocket"></i>
</div>
    </li>
    <li class="nav-item">
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="fe fe-feed"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
  </aside>
  
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/lazyload.min.js"></script>


<script src="/js/busuanzi-2.3.pure.min.js"></script>



<script src="/fancybox/jquery.fancybox.min.js"></script>





<script src="/js/tocbot.min.js"></script>


<script>
  // Tocbot_v4.7.0  http://tscanlin.github.io/tocbot/
  tocbot.init({
    tocSelector: '.tocbot',
    contentSelector: '.article-entry',
    headingSelector: 'h1, h2, h3, h4, h5, h6',
    hasInnerContainers: true,
    scrollSmooth: true,
    positionFixedSelector: '.tocbot',
    positionFixedClass: 'is-position-fixed',
    fixedSidebarOffset: 'auto',
  });
</script>



<script src="/js/ocean.js"></script>

</body>

</html>